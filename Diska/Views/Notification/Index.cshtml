@model IEnumerable<Diska.Models.UserNotification>
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "الإشعارات" : "Notifications";
    Layout = "_Layout";
}

<section class="section-padding" style="min-height: 70vh;">
    <div class="container">

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 class="page-title" style="margin:0;">@(isAr ? "الإشعارات" : "Notifications") 🔔</h2>

            @if (Model.Any())
            {
                <button onclick="clearAllNotifications()" class="btn small" style="color:#dc2626; border:1px solid #dc2626; background:transparent;">
                    <i class="fas fa-trash-alt"></i> @(isAr ? "مسح الكل" : "Clear All")
                </button>
            }
        </div>

        <div id="notificationsContainer">
            @if (!Model.Any())
            {
                <div style="text-align:center; padding:60px; background:#fff; border-radius:15px; border:1px solid #eee;">
                    <i class="far fa-bell-slash fa-4x" style="color:#e2e8f0; margin-bottom:20px;"></i>
                    <h3 style="color:#64748b;">@(isAr ? "لا توجد إشعارات حالياً." : "No notifications yet.")</h3>
                </div>
            }
            else
            {
                <div style="display:flex; flex-direction:column; gap:15px;">
                    @foreach (var item in Model)
                    {
                        <div class="card notif-item @(item.IsRead ? "" : "unread")" id="notif-@item.Id" style="background:@(item.IsRead ? "#fff" : "#f0f9ff"); border:1px solid #e2e8f0; border-radius:12px; padding:20px; transition:0.3s; position:relative;">

                            <div style="display:flex; gap:15px; align-items:flex-start;">
                                <div style="width:45px; height:45px; background:#e0f2fe; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                    @if (item.Type == "Order")
                                    {
                                        <i class="fas fa-box"></i>
                                    }
                                    else if (item.Type == "Wallet")
                                    {

                                        <i class="fas fa-wallet"></i>
                                    }
                                    else if (item.Type == "Alert")
                                    {

                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                    }
                                    else
                                    {

                                        <i class="fas fa-info"></i>
                                    }
                                </div>

                                <div style="flex:1;">
                                    <h4 style="margin:0 0 5px; font-size:1rem; font-weight:@(item.IsRead ? "normal" : "bold"); color:var(--text-dark);">@item.Title</h4>
                                    <p style="margin:0 0 8px; color:#666; font-size:0.9rem; line-height:1.5;">@item.Message</p>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <small style="color:#999;">@item.TimeAgo</small>
                                        @if (!string.IsNullOrEmpty(item.Link) && item.Link != "#")
                                        {
                                            <a href="@item.Link" class="btn small" style="padding:4px 10px; font-size:0.8rem; background:#f8fafc; color:var(--primary); border:1px solid #ddd;">
                                                @(isAr ? "عرض التفاصيل" : "View Details") <i class="fas @(isAr ? "fa-arrow-left" : "fa-arrow-right")"></i>
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (!item.IsRead)
                            {
                                <button onclick="markAsRead(@item.Id)" style="position:absolute; top:15px; @(isAr ? "left" : "right"):15px; background:none; border:none; color:var(--primary); cursor:pointer;" title="@(isAr ? "تحديد كمقروء" : "Mark as read")">
                                    <i class="fas fa-circle" style="font-size:0.7rem;"></i>
                                </button>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</section>

@section Scripts {
    <script>
        async function markAsRead(id) {
            try {
                const response = await fetch('/Notification/MarkAsRead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });

                if (response.ok) {
                    const card = document.getElementById(`notif-${id}`);
                    card.style.background = '#fff';
                    card.querySelector('h4').style.fontWeight = 'normal';
                    // إخفاء نقطة التمييز
                    const btn = card.querySelector('button[onclick^="markAsRead"]');
                    if(btn) btn.remove();

                    // تحديث عداد الهيدر
                    updateBadgeCount();
                }
            } catch (e) { console.error(e); }
        }

        async function clearAllNotifications() {
            if(!confirm('@(isAr ? "هل أنت متأكد من مسح جميع الإشعارات؟" : "Clear all notifications?")')) return;

            try {
                const response = await fetch('/Notification/ClearAll', { method: 'POST' });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (e) { console.error(e); }
        }

        async function updateBadgeCount() {
            const badge = document.getElementById('cartBadge'); // أو ID شارة الإشعارات في الهيدر
            // هذه الوظيفة عادة ما تكون موجودة في Layout، لكن هنا للتوضيح
        }
    </script>
}