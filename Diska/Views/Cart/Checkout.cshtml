@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "إتمام الطلب" : "Checkout";
}

<section class="checkout-section">
    <div class="container">
        <h2 class="page-title">@(isAr ? "بيانات الشحن والدفع" : "Shipping & Payment")</h2>
        <div class="checkout-grid">

            <div class="checkout-form">
                <h3><i class="fas fa-map-marker-alt"></i> @(isAr ? "عنوان التوصيل" : "Delivery Address")</h3>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label>@(isAr ? "اسم المحل / التاجر" : "Shop / Merchant Name")</label>
                        <input type="text" id="shopName" placeholder="@(isAr ? "مثال: سوبر ماركت الأمانة" : "Ex: Al-Amana Market")" required>
                    </div>
                    <div class="form-group">
                        <label>@(isAr ? "رقم الموبايل" : "Phone Number")</label>
                        <input type="tel" id="phone" placeholder="01xxxxxxxxx" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>@(isAr ? "المحافظة" : "Governorate")</label>
                            <select id="govSelect" onchange="updateRegions()">
                                <option value="" disabled selected>@(isAr ? "اختر المحافظة" : "Select Governorate")</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>@(isAr ? "المنطقة / الحي" : "City / District")</label>
                            <select id="citySelect" disabled>
                                <option value="" disabled selected>@(isAr ? "اختر المنطقة" : "Select Area")</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>@(isAr ? "العنوان بالتفصيل" : "Detailed Address")</label>
                        <input type="text" id="addressDetail" placeholder="@(isAr ? "اسم الشارع، رقم العمارة، علامة مميزة" : "Street name, Building no.")" required>
                    </div>

                    <h3><i class="fas fa-wallet"></i> @(isAr ? "طريقة الدفع" : "Payment Method")</h3>
                    <div class="payment-options">
                        <label class="payment-card selected">
                            <input type="radio" name="payment" value="Cash" checked>
                            <div class="pay-icon"><i class="fas fa-money-bill-wave"></i></div>
                            <span>@(isAr ? "دفع عند الاستلام (كاش)" : "Cash on Delivery")</span>
                        </label>
                        <label class="payment-card">
                            <input type="radio" name="payment" value="Wallet">
                            <div class="pay-icon"><i class="fas fa-wallet"></i></div>
                            <span>@(isAr ? "محفظة DISKA" : "DISKA Wallet")</span>
                        </label>
                    </div>
                </form>
            </div>

            <div class="order-summary-box new-design">
                <h3>@(isAr ? "ملخص الفاتورة" : "Order Summary")</h3>

                <div class="checkout-items" id="checkoutItemsList">
                    <!-- Loaded via JS -->
                </div>

                <div class="summary-divider"></div>

                <div class="cost-row">
                    <span>@(isAr ? "المجموع الفرعي" : "Subtotal")</span>
                    <span id="subTotal">0.00 @(isAr ? "ج.م" : "EGP")</span>
                </div>
                <div class="cost-row">
                    <span>@(isAr ? "مصاريف الشحن" : "Shipping Fees")</span>
                    <span id="shippingCost" style="color: var(--danger);">@(isAr ? "-- اختر المحافظة --" : "-- Select Gov --")</span>
                </div>

                <div class="summary-divider"></div>

                <div class="total-row">
                    <span>@(isAr ? "الإجمالي الكلي" : "Grand Total")</span>
                    <span id="finalTotal">0.00 @(isAr ? "ج.م" : "EGP")</span>
                </div>

                <button type="button" onclick="submitOrder()" class="btn primary w-100 confirm-btn">
                    @(isAr ? "تأكيد الطلب الآن" : "Confirm Order Now")
                </button>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script src="~/checkout.js"></script>
    <script>
        async function submitOrder() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
            if (cart.length === 0) { alert('@(isAr ? "السلة فارغة!" : "Cart is empty!")'); return; }

            const shippingText = document.getElementById('shippingCost').innerText;
            const shippingFees = parseFloat(shippingText) || 0;

            const orderData = {
                shopName: document.getElementById('shopName').value,
                phone: document.getElementById('phone').value,
                governorate: document.getElementById('govSelect').value,
                city: document.getElementById('citySelect').value,
                address: document.getElementById('addressDetail').value,
                paymentMethod: document.querySelector('input[name="payment"]:checked').value,
                shippingCost: shippingFees,
                items: cart.map(i => ({ id: i.id.toString(), qty: i.qty, price: i.price }))
            };

            try {
                const response = await fetch('/Cart/PlaceOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    alert('@(isAr ? "تم تأكيد طلبك بنجاح!" : "Order confirmed successfully!")');
                    localStorage.removeItem('DISKA_CART');
                    window.location.href = '/Order/MyOrders';
                } else {
                    alert('@(isAr ? "خطأ: " : "Error: ")' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('@(isAr ? "فشل الاتصال" : "Connection Failed")');
            }
        }
    </script>
}