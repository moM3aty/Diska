@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "إتمام الطلب" : "Checkout";
    Layout = "_Layout";

    string defName = ViewBag.ShopName ?? ViewBag.FullName;
    string defPhone = ViewBag.Phone;
    string defGov = ViewBag.Governorate;
    string defCity = ViewBag.City;
    string defAddr = ViewBag.Address;
}

<style>
    /* =========================================
               PREMIUM CHECKOUT STYLES (Light & Dark)
               ========================================= */
    :root {
        /* Light Theme */
        --chk-bg: #f8fafc;
        --chk-card: #ffffff;
        --chk-text: #0f172a;
        --chk-muted: #64748b;
        --chk-border: #e2e8f0;
        --chk-primary: #0F172A;
        --chk-accent: #FACC15;
        --chk-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        --chk-input-bg: #f8fafc;
    }

    [data-bs-theme="dark"] {
        /* Dark Theme */
        --chk-bg: #020617; /* Deep Dark */
        --chk-card: #1e293b; /* Slate 800 */
        --chk-text: #f8fafc; /* Light Text */
        --chk-muted: #94a3b8; /* Muted Text */
        --chk-border: rgba(255, 255, 255, 0.08);
        --chk-primary: #f8fafc;
        --chk-accent: #FACC15;
        --chk-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        --chk-input-bg: #0f172a;
    }

    body {
        background-color: var(--chk-bg);
        transition: background-color 0.3s ease;
    }

    .checkout-section {
        padding: 50px 0;
        min-height: 90vh;
        font-family: 'Cairo', sans-serif;
    }

    .checkout-container {
        display: grid;
        grid-template-columns: 1.6fr 1fr;
        gap: 30px;
        align-items: start;
    }

    /* Cards */
    .checkout-card {
        background: var(--chk-card);
        border-radius: 20px;
        box-shadow: var(--chk-shadow);
        border: 1px solid var(--chk-border);
        padding: 30px;
        margin-bottom: 25px;
        transition: 0.3s;
    }

    .card-header-custom {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--chk-border);
    }

        .card-header-custom i {
            width: 35px;
            height: 35px;
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

    [data-bs-theme="dark"] .card-header-custom i {
        background: rgba(56, 189, 248, 0.15);
        color: #38bdf8;
    }

    .card-header-custom h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--chk-text);
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 700;
        color: var(--chk-text);
        margin-bottom: 8px;
        display: block;
        font-size: 0.9rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--chk-border);
        border-radius: 10px;
        background-color: var(--chk-input-bg);
        transition: all 0.2s ease;
        font-size: 1rem;
        color: var(--chk-text);
    }

        .form-control:focus, .form-select:focus {
            border-color: var(--chk-accent);
            box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.15);
            outline: none;
            background-color: var(--chk-card);
        }

    [data-bs-theme="dark"] select option {
        background-color: var(--chk-card);
        color: var(--chk-text);
    }

    /* Payment Options */
    .payment-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .payment-card {
        border: 2px solid var(--chk-border);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        background: var(--chk-input-bg);
        position: relative;
        overflow: hidden;
    }

        .payment-card:hover {
            border-color: var(--chk-muted);
        }

        .payment-card.selected {
            border-color: var(--chk-accent);
            background: rgba(250, 204, 21, 0.05);
        }

            .payment-card.selected::after {
                content: '\f00c';
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                position: absolute;
                top: 8px;
                @(isAr ? "left" : "right") : 8px;
                font-size: 1rem;
                color: var(--chk-accent);
            }

    .payment-icon {
        font-size: 1.8rem;
        margin-bottom: 10px;
        color: var(--chk-muted);
        transition: 0.3s;
    }

    .payment-card.selected .payment-icon {
        color: var(--chk-accent);
        transform: scale(1.1);
    }

    .payment-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--chk-text);
    }

    /* Sticky Summary */
    .summary-sticky {
        position: sticky;
        top: 20px;
        background: var(--chk-card);
        border: 1px solid var(--chk-border);
    }

    .order-item {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--chk-border);
        align-items: center;
    }

        .order-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

    .item-img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid var(--chk-border);
        background: #fff;
    }

    .item-name {
        font-weight: 700;
        color: var(--chk-text);
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    .item-meta {
        color: var(--chk-muted);
        font-size: 0.8rem;
    }

    .item-price {
        font-weight: 800;
        color: var(--chk-text);
        margin-inline-start: auto;
    }

    /* Pricing Box */
    .pricing-box {
        background: var(--chk-input-bg);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid var(--chk-border);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        color: var(--chk-muted);
        font-size: 0.95rem;
    }

        .summary-row.total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--chk-border);
            color: var(--chk-text);
            font-weight: 800;
            font-size: 1.2rem;
            align-items: center;
        }

    .total-price {
        color: #16a34a;
    }

    [data-bs-theme="dark"] .total-price {
        color: #4ade80;
    }

    /* Button */
    .btn-place-order {
        background: #0F172A;
        color: #fff;
        width: 100%;
        padding: 16px;
        border-radius: 50px;
        font-weight: 800;
        border: none;
        margin-top: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(15, 23, 42, 0.2);
    }

    [data-bs-theme="dark"] .btn-place-order {
        background: var(--chk-accent);
        color: #0F172A;
        box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
    }

    .btn-place-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(15, 23, 42, 0.3);
    }

    .btn-place-order:disabled {
        background: var(--chk-border);
        color: var(--chk-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .secure-badge {
        text-align: center;
        margin-top: 20px;
        color: var(--chk-muted);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .checkout-container

    {
        grid-template-columns: 1fr;
    }

    .summary-sticky {
        position: static;
        margin-top: 30px;
    }

    }

    /* Animation */
    .fade-up {
        animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @@keyframes fadeUp {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

<section class="checkout-section fade-up">
    <div class="container">
        <form id="checkoutForm" onsubmit="return false;">
            <div class="checkout-container">

                <!-- Left Column: Shipping & Payment -->
                <div class="details-column">

                    <!-- Shipping Info -->
                    <div class="checkout-card">
                        <div class="card-header-custom">
                            <i class="fas fa-map-marker-alt"></i>
                            <h3>@(isAr ? "عنوان الشحن" : "Shipping Address")</h3>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6 form-group">
                                <label class="form-label">@(isAr ? "الاسم / اسم المحل" : "Name / Shop Name")</label>
                                <input type="text" id="shopName" class="form-control" value="@defName" required placeholder="@(isAr ? "مثال: سوبر ماركت الأمل" : "Ex: Al-Amal Market")">
                            </div>
                            <div class="col-md-6 form-group">
                                <label class="form-label">@(isAr ? "رقم الهاتف" : "Phone Number")</label>
                                <input type="tel" id="phone" class="form-control" value="@defPhone" required placeholder="01xxxxxxxxx" style="direction:ltr; text-align:@(isAr ? "right" : "left")">
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6 form-group">
                                <label class="form-label">@(isAr ? "المحافظة" : "Governorate")</label>
                                <select id="govSelect" class="form-select" required>
                                    <option value="" disabled selected>@(isAr ? "-- اختر --" : "-- Select --")</option>
                                    @if (ViewBag.GovernoratesList != null)
                                    {
                                        foreach (SelectListItem item in ViewBag.GovernoratesList)
                                        {
                                            <option value="@item.Text">@item.Text</option>
                                        }
                                    }
                                </select>
                                <input type="hidden" id="savedGov" value="@defGov">
                            </div>
                            <div class="col-md-6 form-group">
                                <label class="form-label">@(isAr ? "المدينة / المنطقة" : "City / Area")</label>
                                <select id="citySelect" class="form-select" required disabled>
                                    <option value="" disabled selected>@(isAr ? "-- اختر المحافظة أولاً --" : "-- Select Gov First --")</option>
                                </select>
                                <input type="hidden" id="savedCity" value="@defCity">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">@(isAr ? "العنوان بالتفصيل" : "Detailed Address")</label>
                            <input type="text" id="address" class="form-control" value="@defAddr" required placeholder="@(isAr ? "اسم الشارع، رقم العقار، علامة مميزة" : "Street name, building number...")">
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label">@(isAr ? "ملاحظات للتوصيل (اختياري)" : "Delivery Notes (Optional)")</label>
                            <textarea id="orderNotes" class="form-control" rows="2" placeholder="@(isAr ? "مثال: يرجى الاتصال قبل الوصول بساعة" : "Ex: Call 1 hour before arrival")"></textarea>
                        </div>
                    </div>

                    <!-- Delivery & Payment -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="checkout-card h-100 mb-0">
                                <div class="card-header-custom">
                                    <i class="fas fa-clock"></i>
                                    <h3>@(isAr ? "التوصيل" : "Delivery")</h3>
                                </div>
                                <div class="form-group mb-0">
                                    <label class="form-label">@(isAr ? "الوقت المفضل" : "Preferred Time")</label>
                                    <select id="deliverySlot" class="form-select">
                                        <option value="Anytime">@(isAr ? "أي وقت (خلال اليوم)" : "Anytime")</option>
                                        <option value="Morning">@(isAr ? "صباحاً (10ص - 4م)" : "Morning")</option>
                                        <option value="Evening">@(isAr ? "مساءً (4م - 10م)" : "Evening")</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="checkout-card h-100 mb-0">
                                <div class="card-header-custom">
                                    <i class="fas fa-wallet"></i>
                                    <h3>@(isAr ? "الدفع" : "Payment")</h3>
                                </div>
                                <div class="payment-options" style="grid-template-columns: 1fr; gap:10px;">
                                    <label class="payment-card selected" onclick="selectPayment(this)">
                                        <input type="radio" name="payment" value="Cash" checked style="display:none;">
                                        <div class="d-flex align-items-center gap-3">
                                            <i class="fas fa-money-bill-wave payment-icon mb-0" style="font-size:1.2rem;"></i>
                                            <span class="payment-title">@(isAr ? "دفع عند الاستلام" : "Cash on Delivery")</span>
                                        </div>
                                    </label>
                                    <label class="payment-card" onclick="selectPayment(this)">
                                        <input type="radio" name="payment" value="BankTransfer" style="display:none;">
                                        <div class="d-flex align-items-center gap-3">
                                            <i class="fas fa-university payment-icon mb-0" style="font-size:1.2rem;"></i>
                                            <span class="payment-title">@(isAr ? "تحويل بنكي" : "Bank Transfer")</span>
                                        </div>
                                    </label>
                                </div>

                                <!-- Bank Details Box -->
                                <div id="bankDetailsBox" style="display:none; margin-top: 15px; padding: 20px; background: var(--chk-input-bg); border: 1px solid var(--chk-border); border-radius: 12px;">
                                    <h5 style="font-size: 1rem; font-weight: 800; margin-bottom: 15px; color: var(--chk-text); display:flex; align-items:center; gap:8px;">
                                        <i class="fas fa-info-circle" style="color:var(--chk-accent);"></i> @(isAr ? "بيانات الحساب البنكي" : "Bank Account Details")
                                    </h5>
                                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.95rem; color: var(--chk-text); line-height: 2;">
                                        <li><strong>@(isAr ? "اسم البنك:" : "Bank Name:")</strong> البنك الأهلى المصرى</li>
                                        <li><strong>@(isAr ? "اسم الحساب:" : "Account Name:")</strong> السمان للتصدير</li>
                                        <li><strong>IBAN:</strong> 4393172138145900010</li>
                                        <li><strong>@(isAr ? "سويفت كود:" : "Swift Code:")</strong> 21381459</li>
                                        <li><strong>@(isAr ? "الفرع:" : "Branch:")</strong> السنبلاوين</li>
                                    </ul>
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--chk-border); font-size: 0.85rem; color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-exclamation-triangle"></i> @(isAr ? "يرجى تحويل إجمالي المبلغ على هذا الحساب لإكمال وتأكيد طلبك." : "Please transfer the total amount to this account to confirm your order.")
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Column: Summary -->
                <div class="summary-column">
                    <div class="checkout-card summary-sticky">
                        <div class="card-header-custom" style="margin-bottom: 20px; border:none; padding:0;">
                            <h3 style="font-size:1.4rem;">@(isAr ? "ملخص الطلب" : "Order Summary")</h3>
                        </div>

                        <!-- Items List -->
                        <div id="checkoutItems" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px;">
                            <div class="text-center py-4" style="color:var(--chk-muted)">
                                <i class="fas fa-spinner fa-spin"></i> @(isAr ? "جاري التحميل..." : "Loading...")
                            </div>
                        </div>

                        <!-- Pricing Breakdown -->
                        <div class="pricing-box">
                            <div class="summary-row">
                                <span>@(isAr ? "المجموع الفرعي" : "Subtotal")</span>
                                <span id="subTotalDisplay" style="font-weight:bold;">0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>@(isAr ? "تكلفة الشحن" : "Shipping")</span>
                                <span id="shippingDisplay" style="font-weight:bold;">0.00</span>
                            </div>
                            <!-- إضافة صف الضريبة -->
                            <div class="summary-row">
                                <span>@(isAr ? "الضريبة (14%)" : "Tax (14%)")</span>
                                <span id="taxDisplay" style="font-weight:bold; color:var(--chk-text);">0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>@(isAr ? "الإجمالي الكلي" : "Grand Total")</span>
                                <span class="total-price">
                                    <span id="grandTotalDisplay">0.00</span> <small style="font-size:0.9rem; font-weight:normal;">@(isAr ? "ج.م" : "EGP")</small>
                                </span>
                            </div>
                        </div>

                        <button type="button" onclick="submitOrder()" class="btn-place-order confirm-btn">
                            @(isAr ? "تأكيد الطلب الآن" : "Place Order Now")
                        </button>

                        <div class="secure-badge">
                            <i class="fas fa-shield-alt text-success"></i>
                            <span>@(isAr ? "بياناتك محمية ومشفرة 100%" : "Your data is 100% secure")</span>
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const isAr = '@isAr' === 'True';

        // الروابط المضمونة
        const urls = {
            cities: '@Url.Action("GetCities", "Cart")',
            shipping: '@Url.Action("GetShippingCost", "Cart")',
            details: '@Url.Action("GetCartDetails", "Cart")',
            place: '@Url.Action("PlaceOrder", "Cart")'
        };

        function toFloat(val) {
            return parseFloat(val.toString().replace(/,/g, '')) || 0;
        }

        function selectPayment(el) {
            document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            const radio = el.querySelector('input');
            radio.checked = true;

            // إظهار أو إخفاء بيانات البنك بناءً على الاختيار
            const bankBox = document.getElementById('bankDetailsBox');
            if (radio.value === 'BankTransfer') {
                bankBox.style.display = 'block';
            } else {
                bankBox.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCartItems(); // 1. تحميل المنتجات

            const govSelect = document.getElementById('govSelect');
            const citySelect = document.getElementById('citySelect');
            const savedGov = document.getElementById('savedGov').value;
            const savedCity = document.getElementById('savedCity').value;

            // --- 1. منطق تحميل المدن ---
            async function fetchCities(govName, selectedCity = "") {
                if (!govName) {
                    citySelect.disabled = true;
                    citySelect.innerHTML = `<option value="">${isAr ? "-- اختر المدينة --" : "-- Select City --"}</option>`;
                    return;
                }

                citySelect.disabled = true;
                citySelect.innerHTML = `<option value="">${isAr ? "جاري التحميل..." : "Loading..."}</option>`;

                try {
                    const res = await fetch(`${urls.cities}?governorate=${encodeURIComponent(govName)}`);

                    if (!res.ok) throw new Error("Server Error");

                    const cities = await res.json();

                    citySelect.innerHTML = `<option value="" disabled ${!selectedCity?'selected':''}>${isAr ? "-- اختر المدينة --" : "-- Select City --"}</option>`;

                    if (cities && cities.length > 0) {
                        cities.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c; opt.text = c;
                            if(c === selectedCity) opt.selected = true;
                            citySelect.appendChild(opt);
                        });
                        citySelect.disabled = false;
                        if(selectedCity) updateCosts(); // حساب الشحن لو في مدينة مختارة مسبقاً
                    } else {
                        // Fallback: إذا لم توجد مدن محددة، نضيف خيار عام
                        const opt = document.createElement('option');
                        opt.value = "All";
                        opt.text = isAr ? "كل المناطق" : "All Areas";
                        opt.selected = true;
                        citySelect.appendChild(opt);
                        citySelect.disabled = false;
                        updateCosts();
                    }
                } catch(e) {
                    console.error("City fetch failed", e);
                    // في حالة الفشل، نسمح باختيار عام حتى لا يتوقف الطلب
                    citySelect.innerHTML = `<option value="General" selected>${isAr ? "عام" : "General"}</option>`;
                    citySelect.disabled = false;
                    updateCosts();
                }
            }

            // ربط الأحداث
            govSelect.addEventListener('change', function() {
                fetchCities(this.value);
            });

            citySelect.addEventListener('change', updateCosts);

            // 2. التحميل التلقائي للبيانات المحفوظة
            if(savedGov && govSelect.querySelector(`option[value="${savedGov}"]`)) {
                govSelect.value = savedGov;
                fetchCities(savedGov, savedCity);
            }
        });

        async function updateCosts() {
            const gov = document.getElementById('govSelect').value;
            const city = document.getElementById('citySelect').value;

            if(!gov) return;

            try {
                const res = await fetch(`${urls.shipping}?governorate=${encodeURIComponent(gov)}&city=${encodeURIComponent(city)}`);
                const data = await res.json();

                const shipping = data.cost || 0;
                document.getElementById('shippingDisplay').innerText = shipping.toLocaleString();

                const sub = toFloat(document.getElementById('subTotalDisplay').innerText);
                updateTotals(sub, shipping);

            } catch(e) {
                console.error(e);
                updateTotals(toFloat(document.getElementById('subTotalDisplay').innerText), 0);
            }
        }

        function updateTotals(sub, ship) {
             const tax = sub * 0.14; // ضريبة 14%
             const total = sub + tax + ship;

             document.getElementById('taxDisplay').innerText = tax.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
             document.getElementById('grandTotalDisplay').innerText = total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        }

        async function loadCartItems() {
            const cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
            if(cart.length === 0) { window.location.href = '/Cart/Index'; return; }

            const container = document.getElementById('checkoutItems');

            try {
                // إضافة قيم افتراضية للون لتجنب خطأ NULL من قاعدة البيانات
                const payload = cart.map(item => ({
                    Id: String(item.id),
                    Qty: parseInt(item.qty),
                    ColorName: item.colorName || 'Default',
                    ColorHex: item.colorHex || '#000000'
                }));

                const response = await fetch(urls.details, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const items = await response.json();
                let subtotal = 0;
                let html = '';

                items.forEach(i => {
                    const t = i.price * i.qty;
                    subtotal += t;

                    let colorBadge = i.colorHex && i.colorHex !== '#000000'
                        ? `<span style="display:inline-block; width:12px; height:12px; background:${i.colorHex}; border-radius:50%; margin-inline-start:5px; border:1px solid #ddd;"></span>`
                        : '';

                    html += `<div class="order-item">
                                <img src="/${i.image}" class="item-img" onerror="this.src='/images/default.png'">
                                <div class="flex-grow-1 ms-2">
                                    <div class="fw-bold">${i.name} ${colorBadge}</div>
                                    <small class="text-muted">${i.qty} x ${i.price.toLocaleString()}</small>
                                </div>
                                <div class="fw-bold">${t.toLocaleString()}</div>
                             </div>`;
                });

                container.innerHTML = html;
                document.getElementById('subTotalDisplay').innerText = subtotal.toLocaleString();
                updateTotals(subtotal, 0);

            } catch(e) {
                console.error(e);
                container.innerHTML = '<p class="text-danger text-center">Error loading items.</p>';
            }
        }

        async function submitOrder() {
            const form = document.getElementById('checkoutForm');
            if(!form.checkValidity()) { form.reportValidity(); return; }

            const btn = document.querySelector('.confirm-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';

            const cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
            const shipping = toFloat(document.getElementById('shippingDisplay').innerText);

            const orderData = {
                ShopName: document.getElementById('shopName').value,
                Phone: document.getElementById('phone').value,
                Governorate: document.getElementById('govSelect').value,
                City: document.getElementById('citySelect').value,
                Address: document.getElementById('address').value,
                PaymentMethod: document.querySelector('input[name="payment"]:checked').value,
                DeliverySlot: document.getElementById('deliverySlot').value,
                Notes: document.getElementById('orderNotes').value,
                ShippingCost: shipping,
                // إضافة قيم افتراضية للون لتجنب إرسال Null وتسبب خطأ في الـ Backend
                Items: cart.map(i => ({
                    Id: String(i.id),
                    Qty: parseInt(i.qty),
                    ColorName: i.colorName || 'Default',
                    ColorHex: i.colorHex || '#000000'
                }))
            };

            try {
                const res = await fetch(urls.place, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await res.json();
                    if(result.success) {
                        localStorage.removeItem('DISKA_CART');
                        window.location.href = `/Cart/OrderSuccess?id=${result.orderId}`;
                    } else {
                        Swal.fire({ icon: 'error', title: isAr?'خطأ':'Error', text: result.message });
                        btn.disabled = false; btn.innerHTML = originalText;
                    }
                } else {
                    const text = await res.text();
                    console.error("Server Response:", text);
                    Swal.fire({ icon: 'error', title: 'Server Error', text: 'Check console for details' });
                    btn.disabled = false; btn.innerHTML = originalText;
                }
            } catch(e) {
                console.error(e);
                Swal.fire({ icon: 'error', title: 'Error', text: 'Connection failed' });
                btn.disabled = false; btn.innerHTML = originalText;
            }
        }
    </script>
}