@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "إتمام الطلب" : "Checkout";

    // قيم افتراضية من الكنترولر (للتعبئة التلقائية)
    string defaultName = ViewBag.ShopName ?? ViewBag.FullName;
    string defaultPhone = ViewBag.Phone;
    string defaultGov = ViewBag.Governorate;
    string defaultCity = ViewBag.City;
    string defaultAddress = ViewBag.Address;
}

<section class="section-padding">
    <div class="container">
        <h2 class="page-title">@(isAr ? "بيانات الشحن والدفع" : "Shipping & Payment")</h2>

        <div class="checkout-grid" style="display:grid; grid-template-columns: 1.5fr 1fr; gap:30px;">

            <!-- Form -->
            <div class="checkout-form" style="background:#fff; padding:30px; border-radius:12px; border:1px solid #eee;">
                <form id="checkoutForm">
                    <h3 style="margin-bottom:20px; font-size:1.2rem; color:var(--primary);">
                        <i class="fas fa-map-marker-alt"></i> @(isAr ? "عنوان التوصيل" : "Shipping Address")
                    </h3>

                    <div class="form-group mb-3">
                        <label>@(isAr ? "الاسم / اسم المحل" : "Name / Shop Name")</label>
                        <input type="text" id="shopName" class="form-control" required placeholder="@(isAr ? "اسم المستلم" : "Receiver Name")" value="@defaultName">
                    </div>

                    <div class="form-group mb-3">
                        <label>@(isAr ? "رقم الموبايل" : "Phone Number")</label>
                        <input type="tel" id="phone" class="form-control" required placeholder="01xxxxxxxxx" value="@defaultPhone">
                    </div>

                    <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div class="form-group">
                            <label>@(isAr ? "المحافظة" : "Governorate")</label>
                            <select id="govSelect" class="form-control" onchange="updateShippingCost()" required>
                                <option value="" disabled selected>@(isAr ? "-- اختر المحافظة --" : "-- Select Governorate --")</option>
                                <!-- يتم تعبئتها بواسطة JS -->
                            </select>
                            <!-- حقل مخفي لحفظ القيمة الافتراضية للـ JS -->
                            <input type="hidden" id="savedGov" value="@defaultGov" />
                        </div>
                        <div class="form-group">
                            <label>@(isAr ? "المدينة / المنطقة" : "City / Area")</label>
                            <select id="citySelect" class="form-control" required disabled>
                                <option value="" disabled selected>@(isAr ? "-- اختر المنطقة --" : "-- Select Area --")</option>
                            </select>
                            <input type="hidden" id="savedCity" value="@defaultCity" />
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label>@(isAr ? "العنوان بالتفصيل" : "Detailed Address")</label>
                        <input type="text" id="address" class="form-control" required placeholder="@(isAr ? "اسم الشارع - رقم العقار - علامة مميزة" : "Street - Building - Landmark")" value="@defaultAddress">
                    </div>

                    <!-- وقت التوصيل -->
                    <div class="form-group mb-3">
                        <label><i class="fas fa-clock"></i> @(isAr ? "وقت التوصيل المفضل" : "Preferred Delivery Time")</label>
                        <select id="deliverySlot" class="form-control">
                            <option value="Anytime">@(isAr ? "أي وقت (خلال اليوم)" : "Anytime (During Day)")</option>
                            <option value="Morning">@(isAr ? "صباحاً (10ص - 4م)" : "Morning (10AM - 4PM)")</option>
                            <option value="Evening">@(isAr ? "مساءً (4م - 10م)" : "Evening (4PM - 10PM)")</option>
                        </select>
                    </div>

                    <!-- ملاحظات -->
                    <div class="form-group mb-4">
                        <label><i class="fas fa-sticky-note"></i> @(isAr ? "ملاحظات إضافية" : "Order Notes")</label>
                        <textarea id="orderNotes" class="form-control" rows="2" placeholder="@(isAr ? "مثال: يرجى الاتصال قبل الوصول" : "Ex: Call before arrival")"></textarea>
                    </div>

                    <h3 style="margin-bottom:20px; font-size:1.2rem; color:var(--primary);">
                        <i class="fas fa-wallet"></i> @(isAr ? "طريقة الدفع" : "Payment Method")
                    </h3>

                    <div class="payment-options">
                        <label class="payment-card selected" style="display:flex; align-items:center; gap:10px; padding:15px; border:1px solid #FACC15; background:#fffbeb; border-radius:8px; cursor:pointer; margin-bottom:10px;">
                            <input type="radio" name="payment" value="Cash" checked>
                            <i class="fas fa-money-bill-wave" style="color:green;"></i>
                            <span>@(isAr ? "دفع عند الاستلام (كاش)" : "Cash on Delivery")</span>
                        </label>

                        <!-- تم إزالة الشرط لأنه زائد، المستخدم مسجل دخول بالفعل -->
                        <label class="payment-card" style="display:flex; align-items:center; gap:10px; padding:15px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                            <input type="radio" name="payment" value="Wallet">
                            <i class="fas fa-wallet" style="color:#3b82f6;"></i>
                            <span>@(isAr ? "المحفظة الإلكترونية" : "Wallet Balance")</span>
                        </label>
                    </div>
                </form>
            </div>

            <!-- Summary -->
            <div class="order-preview" style="background:#f8fafc; padding:25px; border-radius:12px; height:fit-content; border:1px solid #e2e8f0;">
                <h3 style="margin-bottom:20px;">@(isAr ? "ملخص الفاتورة" : "Bill Summary")</h3>

                <div id="checkoutItems" style="max-height:200px; overflow-y:auto; margin-bottom:20px; border-bottom:1px solid #ddd;">
                    <!-- Items via JS -->
                </div>

                <div class="cost-row" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>@(isAr ? "قيمة المنتجات" : "Subtotal")</span>
                    <span id="subTotalDisplay">0.00</span>
                </div>
                <div class="cost-row" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>@(isAr ? "مصاريف الشحن" : "Shipping")</span>
                    <span id="shippingDisplay">50.00</span>
                </div>
                <hr>
                <div class="cost-row total" style="display:flex; justify-content:space-between; margin-top:10px; font-size:1.3rem; font-weight:bold; color:var(--primary);">
                    <span>@(isAr ? "الإجمالي الكلي" : "Grand Total")</span>
                    <span id="grandTotalDisplay">0.00</span>
                </div>

                <button type="button" onclick="submitOrder()" class="btn primary w-100" style="margin-top:20px; padding:12px; font-size:1.1rem;">
                    @(isAr ? "تأكيد الطلب" : "Confirm Order") <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/checkout-data.js"></script> <!-- بيانات المحافظات -->
    <script src="~/js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderCheckoutPreview();

            // محاولة تحديد المحافظة المحفوظة تلقائياً
            setTimeout(() => {
                const savedGov = document.getElementById('savedGov').value;
                const savedCity = document.getElementById('savedCity').value;
                const govSelect = document.getElementById('govSelect');
                const citySelect = document.getElementById('citySelect');

                if (savedGov && govSelect) {
                    govSelect.value = savedGov;
                    // تفعيل حدث التغيير لملء المدن
                    const event = new Event('change');
                    govSelect.dispatchEvent(event);

                    // تحديد المدينة بعد ملء القائمة
                    if (savedCity) {
                        citySelect.value = savedCity;
                    }

                    // تحديث الشحن
                    updateShippingCost();
                } else {
                    // حساب مبدئي (القاهرة افتراضياً إذا لم يوجد عنوان)
                    updateShippingCost();
                }
            }, 500); // تأخير بسيط لضمان تحميل البيانات
        });

        async function submitOrder() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
            if (cart.length === 0) { alert("السلة فارغة!"); return; }

            const shippingText = document.getElementById('shippingDisplay').innerText;

            const orderData = {
                shopName: document.getElementById('shopName').value,
                phone: document.getElementById('phone').value,
                governorate: document.getElementById('govSelect').value,
                city: document.getElementById('citySelect').value,
                address: document.getElementById('address').value,
                deliverySlot: document.getElementById('deliverySlot')?.value || "Anytime",
                notes: document.getElementById('orderNotes')?.value || "",
                paymentMethod: document.querySelector('input[name="payment"]:checked').value,
                shippingCost: parseFloat(shippingText) || 0,
                items: cart.map(i => ({ id: i.id, qty: i.qty, price: i.price }))
            };

            try {
                const btn = document.querySelector('button[onclick="submitOrder()"]');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التنفيذ...';

                const response = await fetch('/Cart/PlaceOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    localStorage.removeItem('DISKA_CART');
                    if(result.redirectUrl) {
                        window.location.href = result.redirectUrl;
                    } else {
                        window.location.href = `/Cart/OrderSuccess?id=${result.orderId}`;
                    }
                } else {
                    alert("خطأ: " + result.message);
                    btn.disabled = false;
                    btn.innerHTML = 'تأكيد الطلب';
                }
            } catch (e) {
                console.error(e);
                alert("فشل الاتصال بالخادم");
                btn.disabled = false;
                btn.innerHTML = 'تأكيد الطلب';
            }
        }
    </script>
}