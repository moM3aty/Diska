@using Microsoft.AspNetCore.Identity
@using System.Globalization
@inject UserManager<Diska.Models.ApplicationUser> UserManager
@{
    // يتم تضمين هذا الملف في _Layout.cshtml
    // يتحقق مما إذا كان المستخدم مسجلاً ثم يفحص الاستبيانات عبر AJAX
    bool isUserLoggedIn = User.Identity.IsAuthenticated;
}

@if (isUserLoggedIn)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // ننتظر قليلاً حتى يتم تحميل الصفحة بالكامل لتجنب إزعاج المستخدم فوراً
            setTimeout(checkForPendingSurvey, 2000);
        });

        function checkForPendingSurvey() {
            // التحقق من الثيم (Dark/Light) لتنسيق النافذة
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';

            const colors = isDark ? {
                bg: '#1e293b', text: '#f8fafc', btn: '#6366f1', cancel: '#94a3b8'
            } : {
                bg: '#ffffff', text: '#0f172a', btn: '#0F172A', cancel: '#64748b'
            };

            // استدعاء الكنترولر للبحث عن استبيان
            fetch('/UserSurvey/CheckPending')
                .then(response => {
                    if (!response.ok) return null;
                    return response.json();
                })
                .then(data => {
                    // إذا عادت البيانات بـ ID، فهذا يعني وجود استبيان متاح
                    if (data && data.id) {
                        const isAr = document.documentElement.lang === 'ar' || document.documentElement.dir === 'rtl';

                        const titleText = isAr ? "شاركنا رأيك!" : "We Value Your Feedback!";
                        const surveyName = isAr ? data.title : (data.titleEn || data.title);
                        const msgText = isAr
                            ? `نود تحسين خدماتنا لك. هل لديك دقيقة للمشاركة في: "${surveyName}"؟`
                            : `Help us improve. Do you have a minute for: "${surveyName}"?`;

                        const btnText = isAr ? 'ابدأ الآن' : 'Start Now';
                        const cancelText = isAr ? 'لاحقاً' : 'Later';

                        // إظهار SweetAlert
                        Swal.fire({
                            title: titleText,
                            text: msgText,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: btnText,
                            cancelButtonText: cancelText,

                            // Styling
                            background: colors.bg,
                            color: colors.text,
                            confirmButtonColor: colors.btn,
                            cancelButtonColor: colors.cancel,
                            backdrop: `rgba(0,0,0,0.5)`,

                            customClass: {
                                popup: 'rounded-4 shadow-lg border-0',
                                confirmButton: 'px-4 py-2 rounded-pill fw-bold',
                                cancelButton: 'px-4 py-2 rounded-pill'
                            },
                            showClass: { popup: 'animate__animated animate__fadeInDown' },
                            hideClass: { popup: 'animate__animated animate__fadeOutUp' }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/UserSurvey/Take/' + data.id;
                            }
                        });
                    }
                })
                .catch(err => {
                    // console.log("No pending surveys or error checking.");
                });
        }
    </script>
}