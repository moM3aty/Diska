@using Microsoft.AspNetCore.Identity
@using System.Globalization
@inject UserManager<Diska.Models.ApplicationUser> UserManager
@{
    // هذا الكود يتحقق فقط إذا كان المستخدم مسجلاً
    // التحقق الفعلي من الاستبيان يتم عبر AJAX لتجنب بطء تحميل الصفحة
    bool isUserLoggedIn = User.Identity.IsAuthenticated;
}

@if (isUserLoggedIn)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // تأخير بسيط لضمان تحميل الصفحة بالكامل قبل ظهور النافذة
            setTimeout(checkPendingSurvey, 1500);
        });

        function checkPendingSurvey() {
            // التحقق من الوضع الحالي (Dark/Light)
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';

            // تعريف الألوان بناءً على الوضع لضمان التناسق (Premium Look)
            const colors = isDark ? {
                background: '#1e293b', // Slate 800 (Dark Card)
                text: '#f8fafc',       // Slate 50 (Light Text)
                confirmBtn: '#6366f1', // Indigo 500 (Brighter Primary)
                cancelBtn: '#94a3b8'   // Slate 400 (Muted Text)
            } : {
                background: '#ffffff', // White
                text: '#0f172a',       // Slate 900 (Dark Text)
                confirmBtn: '#0F172A', // Slate 900 (Deep Primary)
                cancelBtn: '#64748b'   // Slate 500
            };

            // التحقق من وجود استبيان معلق عبر AJAX
            fetch('/UserSurvey/CheckPending')
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // إذا عاد السيرفر ببيانات (معناه يوجد استبيان لم يتم حله)
                    if (data && data.id) {
                        const isAr = document.documentElement.lang === 'ar' || document.documentElement.dir === 'rtl';

                        // تحديد النصوص بناءً على اللغة
                        const title = isAr ? "شاركنا رأيك!" : "We Value Your Feedback!";
                        const surveyTitle = isAr ? data.title : (data.titleEn || data.title);
                        const text = isAr
                            ? `نود تحسين خدماتنا لك. يرجى تخصيص لحظة للإجابة على استبيان: "${surveyTitle}"`
                            : `Help us improve. Please take a moment to answer: "${surveyTitle}"`;

                        const confirmBtn = isAr ? "ابدأ الآن" : "Start Now";
                        const cancelBtn = isAr ? "ليس الآن" : "Not Now";

                        // عرض SweetAlert بتصميم Premium متكيف مع الوضع
                        Swal.fire({
                            title: title,
                            text: text,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: confirmBtn,
                            cancelButtonText: cancelBtn,

                            // تطبيق الألوان الديناميكية
                            background: colors.background,
                            color: colors.text,
                            confirmButtonColor: colors.confirmBtn,
                            cancelButtonColor: colors.cancelBtn,

                            backdrop: `rgba(15, 23, 42, 0.6)`,
                            padding: '2em',
                            customClass: {
                                popup: 'rounded-4 shadow-lg border ' + (isDark ? 'border-secondary' : 'border-light'),
                                confirmButton: 'px-4 py-2 rounded-pill fw-bold',
                                cancelButton: 'px-4 py-2 rounded-pill'
                            },
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/UserSurvey/Take/' + data.id;
                            }
                        });
                    }
                })
                .catch(err => {
                    // console.error('Survey check failed', err);
                    // Silent fail is better for UX
                });
        }
    </script>
}