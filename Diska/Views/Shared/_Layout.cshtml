@using Microsoft.AspNetCore.Identity
@using System.Globalization
@using Diska.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    var isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    var dir = isAr ? "rtl" : "ltr";
    var lang = isAr ? "ar" : "en";
    var theme = Context.Request.Cookies["theme"] ?? "light";

    // جلب المستخدم الحالي بأمان
    var user = await UserManager.GetUserAsync(User);
    var userRole = "Customer";
    if (user != null)
    {
        var roles = await UserManager.GetRolesAsync(user);
        userRole = roles.FirstOrDefault() ?? "Customer";
    }
}

<!DOCTYPE html>
<html lang="@lang" dir="@dir" data-bs-theme="@theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - DISKA</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="icon" type="image/x-icon" href="~/images/logo2.png">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
</head>
<body class="@(theme == "dark" ? "dark-mode" : "")">

    <header class="main-header">
        <div class="container header-container">

            <!-- Logo with Slogan -->
            <a asp-area="" asp-controller="Home" asp-action="Index" class="logo" style="text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;">
                <div style="display: flex; align-items: center;">
                    <img class="mqL" src="~/images/logo2.png" alt="DISKA" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <img class="mqS" src="~/images/precent.png" alt="DISKA" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                </div>
                    <span style="font-size: 0.8rem; font-weight: 700; color: #64748b; white-space: nowrap;margin-top:-35px;">
                        @(isAr ? "التجارة بقت هنا" : "Commerce is here")
                    </span>
            </a>

            <!-- Search Box -->
            <form class="search-box" asp-area="" asp-controller="Home" asp-action="Search" method="get">
                <input type="text" name="query" placeholder="@(isAr ? "ابحث عن منتج..." : "Search...")" value="@Context.Request.Query["query"]">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>

            <!-- Actions -->
            <div class="header-actions" style="margin-top: 5px;">

                <!-- Account -->
                @if (SignInManager.IsSignedIn(User))
                {
                    <a asp-area="" asp-controller="Profile" asp-action="Index" class="action-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <span class="icon-label">@(isAr ? "مرحباً" : "Hello")</span>
                        </div>
                    </a>
                }
                else
                {
                    <a asp-area="" asp-controller="Account" asp-action="Login" class="action-item">
                        <i class="fas fa-sign-in-alt"></i>
                        <div>
                            <span class="icon-label">@(isAr ? "دخول" : "Login")</span>
                        </div>
                    </a>
                }

                <!-- Wishlist (Icon Only) -->
                <a asp-area="" asp-controller="Wishlist" asp-action="Index" class="action-item" title="@(isAr ? "المفضلة" : "Wishlist")">
                    <i class="fas fa-heart"></i>
                    <span class="icon-label">@(isAr ? "المفضلة" : "Wishlist")</span>
                </a>

                <a asp-controller="Notification" asp-action="Index" class="action-item notif-icon-container" style="text-decoration: none; position: relative;">
                    <i class="fas fa-bell"></i>
                    <span class="badge notif-badge" id="notifBadge" style="background:var(--danger); color:#fff; display:none; position:absolute; top:-5px; right:-5px; border-radius:50%; padding:3px 6px; font-size:0.6rem;">0</span>
                    <span class="icon-label">@(isAr ? "تنبيهات" : "Alerts")</span>
                </a>

                <!-- Cart -->
                <a asp-area="" asp-controller="Cart" asp-action="Index" class="action-item" style="position:relative;">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="badge" id="cartBadge">0</span>
                    <div>
                        <span class="icon-label">@(isAr ? "السلة" : "Cart")</span>
                    </div>
                </a>


                <!-- Role Specific Link (Admin / Merchant / Sell with us) -->
                @if (User.IsInRole("Admin"))
                {
                    <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index" class="merchant-link">
                        <i class="fas fa-cogs"></i> @(isAr ? "الإدارة" : "Admin")
                    </a>
                }
                else if (User.IsInRole("Merchant"))
                {
                    <a asp-area="Merchant" asp-controller="Dashboard" asp-action="Index" class="merchant-link">
                        <i class="fas fa-store"></i> @(isAr ? "لوحة التاجر" : "My Panel")
                    </a>
                }
                else
                {
                    <a asp-area="" asp-controller="Home" asp-action="MerchantLanding" class="merchant-link">
                        <i class="fas fa-hand-holding-usd"></i> @(isAr ? "بيع معنا" : "Sell with Us")
                    </a>
                }

                <!-- Mobile Menu Btn -->
                <div class="mobile-menu-btn" onclick="toggleMenu()">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="sidebar-header">
            <div style="display: flex; flex-direction: column;">
                <h3 style="color:var(--primary); font-weight:800; margin: 0;">DISKA</h3>
                <span style="font-size: 0.75rem; color: #64748b; font-weight: 600;">@(isAr ? "التجارة بقت هنا" : "Commerce is here")</span>
            </div>
            <button class="close-menu" onclick="toggleMenu()"><i class="fas fa-times"></i></button>
        </div>
        <ul class="sidebar-links">
            <!-- Role Specific Links -->
            @if (SignInManager.IsSignedIn(User))
            {
                @if (User.IsInRole("Admin"))
                {
                    <li><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index"><i class="fas fa-cogs"></i> @(isAr ? "لوحة الإدارة" : "Admin Panel")</a></li>
                }
                @if (User.IsInRole("Merchant"))
                {
                    <li><a asp-area="Merchant" asp-controller="Dashboard" asp-action="Index"><i class="fas fa-store"></i> @(isAr ? "لوحة التاجر" : "Merchant Panel")</a></li>
                }
            }
            else
            {
                <li><a asp-area="" asp-controller="Home" asp-action="MerchantLanding" class="merchant-link" style="color:var(--primary); border:1px solid var(--primary); justify-content:center;"><i class="fas fa-hand-holding-usd"></i> @(isAr ? "بع معنا" : "Sell with Us")</a></li>
            }

            <li class="divider" style="border-top:1px solid var(--border); margin:10px 0;"></li>

            <!-- Dark Mode Toggle -->
            <li id="darkModeToggleSidebar" style="cursor: pointer;">
                <a href="javascript:void(0)">
                    <i class="fas @(theme == "dark" ? "fa-sun" : "fa-moon")"></i>
                    <span id="darkModeText">
                        @(isAr ? (theme == "dark" ? "الوضع النهاري" : "الوضع الليلي") : (theme == "dark" ? "Light Mode" : "Dark Mode"))
                    </span>
                </a>
            </li>

            <li class="divider" style="border-top:1px solid var(--border); margin:10px 0;"></li>

            <!-- Navigation -->
            <li><a asp-area="" asp-controller="Home" asp-action="Index"><i class="fas fa-home"></i> @(isAr ? "الرئيسية" : "Home")</a></li>
            <li><a asp-area="" asp-controller="Deals" asp-action="Index"><i class="fas fa-fire" style="color: var(--danger);"></i> @(isAr ? "العروض" : "Deals")</a></li>
            <li><a asp-area="" asp-controller="Request" asp-action="Index"><i class="fas fa-bullhorn" style="color: #8b5cf6;"></i> @(isAr ? "طلبات خاصة" : "Special Requests")</a></li>
            <li><a asp-area="" asp-controller="Cart" asp-action="Index"><i class="fas fa-shopping-cart"></i> @(isAr ? "السلة" : "Cart")</a></li>

            <li class="divider" style="border-top:1px solid var(--border); margin:10px 0;"></li>

            <!-- User Menu -->
            @if (SignInManager.IsSignedIn(User))
            {
                <li><a asp-area="" asp-controller="Profile" asp-action="Index"><i class="fas fa-user-circle"></i> @(isAr ? "حسابي" : "My Profile")</a></li>
                <li><a asp-area="" asp-controller="Order" asp-action="Index"><i class="fas fa-box"></i> @(isAr ? "طلباتي" : "My Orders")</a></li>
                <li><a asp-area="" asp-controller="Address" asp-action="Index"><i class="fas fa-map-marker-alt"></i> @(isAr ? "العناوين" : "Addresses")</a></li>
                <li><a asp-area="" asp-controller="Wishlist" asp-action="Index"><i class="fas fa-heart"></i> @(isAr ? "المفضلة" : "Wishlist")</a></li>
                <li><a asp-area="" asp-controller="Account" asp-action="Logout" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> @(isAr ? "خروج" : "Logout")</a></li>
            }
            else
            {
                <li><a asp-area="" asp-controller="Account" asp-action="Login"><i class="fas fa-sign-in-alt"></i> @(isAr ? "تسجيل الدخول" : "Login")</a></li>
                <li><a asp-area="" asp-controller="Account" asp-action="Signup"><i class="fas fa-user-plus"></i> @(isAr ? "إنشاء حساب" : "Register")</a></li>
            }

            <li class="divider" style="border-top:1px solid var(--border); margin:10px 0;"></li>

            <!-- Support -->
            <li><a asp-area="" asp-controller="Home" asp-action="About"><i class="fas fa-info-circle"></i> @(isAr ? "من نحن" : "About Us")</a></li>
            <li><a asp-area="" asp-controller="Contact" asp-action="Index"><i class="fas fa-headset"></i> @(isAr ? "تواصل معنا" : "Contact Us")</a></li>
        </ul>
    </div>
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

    <!-- Main Content -->
    <main role="main">
        @RenderBody()
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div style="text-align: @(isAr ? "right" : "left");">
                    <img style="margin:-25px" src="~/images/logo2.png" alt="Diska" width="150px" />
                    <p>@(isAr ? "منصتك الأولى لتجارة الجملة في مصر. نربطك بأفضل الموردين بأفضل الأسعار." : "Your #1 wholesale platform in Egypt. Connecting you with top suppliers at best prices.")</p>
                </div>

                <div style="text-align: @(isAr ? "right" : "left");">
                    <h4>@(isAr ? "روابط هامة" : "Links")</h4>
                    <ul>
                        <li><a asp-area="" asp-controller="Home" asp-action="About">@(isAr ? "من نحن" : "About Us")</a></li>
                        @if (!User.IsInRole("Merchant"))
                        {
                            <li><a asp-area="" asp-controller="Home" asp-action="MerchantLanding">@(isAr ? "بع معنا" : "Sell with Us")</a></li>
                        }
                        <li><a asp-area="" asp-controller="Contact" asp-action="Index">@(isAr ? "تواصل معنا" : "Contact Us")</a></li>
                    </ul>
                </div>

                <div style="text-align: @(isAr ? "right" : "left");">
                    <h4>@(isAr ? "المساعدة" : "Help")</h4>
                    <ul>
                        <li><a asp-area="" asp-controller="Home" asp-action="Policies">@(isAr ? "سياسة الخصوصية" : "Privacy Policy")</a></li>
                        <li><a asp-area="" asp-controller="Home" asp-action="FAQ">@(isAr ? "الأسئلة الشائعة" : "FAQ")</a></li>
                        <li><a asp-area="" asp-controller="Home" asp-action="Privacy">@(isAr ? "الشحن والتوصيل" : "Shipping & Delivery")</a></li>
                        <li><a asp-area="" asp-controller="Home" asp-action="Terms">@(isAr ? "الشروط والأحكام" : "terms and conditions")</a></li>
                    </ul>
                </div>
            </div>

            <div class="copyrights">
                <p>&copy; @DateTime.Now.Year DISKA. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Floating Tools -->
    <div class="floating-container">
        <!-- Language Switcher -->
        <form id="langForm" asp-area="" asp-controller="Language" asp-action="SetLanguage" method="post" class="d-inline">
            <input type="hidden" name="culture" value="@(isAr ? "en-US" : "ar-EG")" />
            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
            <a href="javascript:void(0)" onclick="document.getElementById('langForm').submit();" class="float-btn lang-btn" title="@(isAr ? "English" : "العربية")">
                <i class="fas fa-globe"></i>
            </a>
        </form>
        <!-- WhatsApp -->
        <a href="https://wa.me/201000000000" target="_blank" class="float-btn whatsapp-btn">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/cart.js"></script>

    <script>
        function toggleMenu() {
            var sidebar = document.getElementById('mobileSidebar');
            var overlay = document.getElementById('menuOverlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        // Notification Logic
        window.updateNotificationBadge = async function() {
            try {
                const response = await fetch('/Notification/GetUnreadCount');
                if (response.ok) {
                    const count = await response.json();
                    const badge = document.getElementById('notifBadge');
                    if (badge) {
                        badge.innerText = count;
                        badge.style.display = count > 0 ? 'flex' : 'none';

                        // Optional: Add simple animation if count increased
                        if (count > 0) {
                            badge.classList.add('pulse-badge');
                            setTimeout(() => badge.classList.remove('pulse-badge'), 1000);
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to update notifications badge', e);
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Update Badges on Load
            const updateCartBadge = () => {
                const cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
                const badge = document.getElementById('cartBadge');
                if(badge) {
                    badge.innerText = cart.length;
                    badge.style.display = cart.length > 0 ? 'flex' : 'none';
                }
            };
            updateCartBadge();
            window.addEventListener('cartUpdated', updateCartBadge);

            // Initial Notification Check
            if ('@SignInManager.IsSignedIn(User)' === 'True') {
                updateNotificationBadge();
                // Optional: Poll every 60 seconds
                setInterval(updateNotificationBadge, 60000);
            }

            // Dark Mode Toggle Logic
            const toggleBtn = document.getElementById('darkModeToggleSidebar');
            const darkModeText = document.getElementById('darkModeText');

            // Text values for switching
            const textLight = '@Html.Raw(isAr ? "الوضع النهاري" : "Light Mode")';
            const textDark = '@Html.Raw(isAr ? "الوضع الليلي" : "Dark Mode")';

            if(toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const body = document.body;
                    const html = document.documentElement;

                    body.classList.toggle('dark-mode');
                    const isDark = body.classList.contains('dark-mode');

                    // Update cookie
                    document.cookie = "theme=" + (isDark ? "dark" : "light") + "; path=/; max-age=31536000";

                    // Update attribute for CSS selectors relying on data-bs-theme
                    html.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');

                    // Update Icon & Text
                    const icon = toggleBtn.querySelector('i');
                    if(isDark) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                        if(darkModeText) darkModeText.textContent = textLight;
                    } else {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                        if(darkModeText) darkModeText.textContent = textDark;
                    }
                });
            }

            // Ensure consistency on load
            if (document.cookie.includes('theme=dark')) {
                document.body.classList.add('dark-mode');
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            }
        });
    </script>

    <style>
        @("@keyframes") pulseBadge {
            0%

        {
            transform: scale(1);
        }

        50% {
            transform: scale(1.3);
        }

        100% {
            transform: scale(1);
        }

        }

        .pulse-badge {
            animation: pulseBadge 0.5s ease-in-out;
        }
    </style>


    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>