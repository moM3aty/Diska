@model Diska.Models.Product
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? Model.Name : Model.NameEn;

    // Average Rating
    var avgRating = ViewBag.AverageRating != null ? (double)ViewBag.AverageRating : 0;
}

<section class="product-details-section">
    <div class="container">

        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">@(isAr ? "الرئيسية" : "Home")</a> /
            <a asp-action="Index" asp-route-categoryId="@Model.CategoryId">@(isAr? Model.Category.Name : Model.Category.NameEn)</a> /
            <span>@(isAr? Model.Name: Model.NameEn)</span>
        </div>

        <div class="details-grid">
            <!-- Image Side -->
            <div class="details-img">
                <div class="main-image-box" style="position:relative; margin-bottom:10px; border:1px solid #eee; border-radius:10px; overflow:hidden;">
                    @if (Model.OldPrice > Model.Price)
                    {
                        <span class="discount-badge" style="position:absolute; top:10px; right:10px; z-index:2;">@(isAr ? "خصم" : "Sale")</span>
                    }
                    <img id="mainImage" src="~/@Model.ImageUrl" alt="@Model.Name" onerror="this.src='/images/default.png'" style="width:100%; height:auto;">
                </div>

                @if (Model.Images != null && Model.Images.Any())
                {
                    <div class="thumbs-list" style="display:flex; gap:10px; overflow-x:auto;">
                        <img src="~/@Model.ImageUrl" class="thumb-item active" onclick="changeImage(this)" style="width:70px; height:70px; border-radius:5px; border:2px solid var(--primary); cursor:pointer;">
                        @foreach (var img in Model.Images)
                        {
                            <img src="~/@img.ImageUrl" class="thumb-item" onclick="changeImage(this)" style="width:70px; height:70px; border-radius:5px; border:2px solid #eee; cursor:pointer;">
                        }
                    </div>
                }
            </div>

            <!-- Info Side -->
            <div class="details-info">
                <h1>@(isAr? Model.Name: Model.NameEn)</h1>

                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                    <div class="brand-tag">
                        <i class="fas fa-store"></i> @(Model.Merchant?.ShopName ?? "Diska Store")
                    </div>
                    <div style="color:#f59e0b; font-size:0.9rem;">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <i class="fas @(i <= avgRating ? "fa-star" : "fa-star-half-alt")"></i>
                        }
                        <span style="color:#666;">(@ViewBag.ReviewCount)</span>
                    </div>
                </div>

                <div class="sku" style="margin-bottom:15px;">SKU: @Model.SKU</div>

                <div class="main-price">
                    @if (Model.OldPrice > Model.Price)
                    {
                        <span class="old">@Model.OldPrice.Value.ToString("N0")</span>
                    }
                    <span>@Model.Price.ToString("N0") <small>@(isAr ? "ج.م" : "EGP")</small></span>
                </div>

                <!-- Wholesale Table -->
                @if (Model.PriceTiers != null && Model.PriceTiers.Any())
                {
                    <div class="wholesale-table">
                        <h4>@(isAr ? "أسعار الجملة" : "Wholesale Prices")</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>@(isAr ? "الكمية" : "Qty")</th>
                                    <th>@(isAr ? "السعر للقطعة" : "Unit Price")</th>
                                    <th>@(isAr ? "التوفير" : "Saving")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tier in Model.PriceTiers)
                                {
                                    <tr>
                                        <td>@tier.MinQuantity - @tier.MaxQuantity</td>
                                        <td>@tier.UnitPrice.ToString("N0")</td>
                                        <td style="color:green;">@((Model.Price - tier.UnitPrice).ToString("N0"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <!-- Stock & Unit Info -->
                <div class="meta-info">
                    <p><i class="fas fa-box"></i> @(isAr ? $"الكرتونة تحتوي على {Model.UnitsPerCarton} قطعة" : $"Carton contains {Model.UnitsPerCarton} pcs")</p>
                    <p>
                        @if (Model.StockQuantity > 0)
                        {
                            <span style="color:var(--success); font-weight:bold;"><i class="fas fa-check-circle"></i> @(isAr ? "متوفر في المخزون" : "In Stock")</span>
                        }
                        else
                        {
                            <span style="color:var(--danger); font-weight:bold;"><i class="fas fa-times-circle"></i> @(isAr ? "غير متوفر" : "Out of Stock")</span>
                        }
                    </p>
                </div>

                <!-- Actions -->
                <div class="details-actions">
                    <div class="qty-control">
                        <button onclick="document.getElementById('pQty').stepDown()">-</button>
                        <input type="number" id="pQty" value="1" min="1" max="@Model.StockQuantity">
                        <button onclick="document.getElementById('pQty').stepUp()">+</button>
                    </div>
                    @if (Model.StockQuantity > 0)
                    {
                        <button class="btn primary add-big-btn" onclick="addToCartSimple(@Model.Id)">
                            <i class="fas fa-cart-plus"></i> @(isAr ? "إضافة للسلة" : "Add to Cart")
                        </button>
                    }
                    else
                    {
                        <button class="btn primary add-big-btn disabled-btn" disabled style="background:#ccc; cursor:not-allowed;">
                            @(isAr ? "نفذت الكمية" : "Out of Stock")
                        </button>
                    }
                </div>

                <div style="margin-top:30px;">
                    <h4 style="border-bottom:1px solid #eee; padding-bottom:10px;">@(isAr ? "الوصف" : "Description")</h4>
                    <div style="line-height:1.8; color:#555; margin-top:10px;">
                        @Html.Raw(isAr ? Model.Description : Model.DescriptionEn)
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function changeImage(img) {
            document.getElementById('mainImage').src = img.src;
            document.querySelectorAll('.thumb-item').forEach(i => i.style.borderColor = '#eee');
            img.style.borderColor = 'var(--primary)';
        }

        function addToCartSimple(id) {
            let qty = document.getElementById('pQty').value;
            if(typeof addItemToCart === 'function') addItemToCart(id, qty);
        }
    </script>
}