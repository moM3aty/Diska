@model Diska.Models.Product
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? Model.Name : (Model.NameEn ?? Model.Name);
}

<section class="product-details-section">
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">@(isAr ? "الرئيسية" : "Home")</a> /
            <span>@(isAr? Model.Category.Name : (Model.Category.NameEn ?? Model.Category.Name))</span> /
            <span>@(isAr? Model.Name: (Model.NameEn ?? Model.Name))</span>
        </div>

        <div class="details-grid">
            <!-- Image -->
            <div class="details-img">
                <img src="~/@Model.ImageUrl" alt="@Model.Name">
            </div>

            <!-- Info -->
            <div class="details-info product-card" data-id="@Model.Id">
                <!-- Class product-card added for JS hook -->
                <h1>@(isAr? Model.Name: (Model.NameEn ?? Model.Name))</h1>
                <p class="sku">SKU: #@Model.Id</p>

                <div class="main-price">
                    <span class="current-price">@Model.Price.ToString("N2") @(isAr ? "ج.م" : "EGP")</span>
                    @if (Model.OldPrice.HasValue)
                    {
                        <span class="old-price">@Model.OldPrice.Value.ToString("N2")</span>
                    }
                </div>

                <div class="meta-info">
                    <p><i class="fas fa-box"></i> @(isAr ? $"الوحدة: {Model.UnitsPerCarton} قطعة/كرتونة" : $"Unit: {Model.UnitsPerCarton} pcs/carton")</p>
                    <p>
                        <i class="fas fa-cubes"></i>
                        @(isAr ? "المخزون:" : "Stock:")
                        <span style="color: @(Model.StockQuantity > 10 ? "green" : "red"); font-weight:bold;">
                            @(Model.StockQuantity > 0 ? Model.StockQuantity.ToString() : (isAr ? "نفذت الكمية" : "Out of Stock"))
                        </span>
                    </p>
                </div>

                <!-- B2B Tiered Pricing Table -->
                @if (Model.PriceTiers != null && Model.PriceTiers.Any())
                {
                    <div class="wholesale-table">
                        <h4>@(isAr ? "خصومات الكميات (الجملة)" : "Bulk Discounts")</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>@(isAr ? "الكمية" : "Quantity")</th>
                                    <th>@(isAr ? "السعر للقطعة" : "Unit Price")</th>
                                    <th>@(isAr ? "التوفير" : "Savings")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tier in Model.PriceTiers)
                                {
                                    var saving = Model.Price - tier.UnitPrice;
                                    <tr class="highlight">
                                        <td>@tier.MinQuantity - @tier.MaxQuantity</td>
                                        <td>@tier.UnitPrice.ToString("N2")</td>
                                        <td style="color:green;">@saving.ToString("N2") @(isAr ? "ج.م" : "EGP")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <!-- Actions -->
                @if (Model.StockQuantity > 0)
                {
                    <div class="details-actions">
                        <div class="qty-control">
                            <button onclick="changeQty(-1)">-</button>
                            <input type="number" id="qtyInput" value="1" min="1" max="@Model.StockQuantity" readonly class="manual-qty">
                            <button onclick="changeQty(1)">+</button>
                        </div>
                        <button class="btn primary add-big-btn add-btn" onclick="addToCart(this)">
                            @(isAr ? "إضافة للسلة" : "Add to Cart") <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                }
                else
                {
                    <button class="btn" disabled style="background:#ccc; width:100%;">@(isAr ? "غير متوفر حالياً" : "Currently Unavailable")</button>
                }

                <div class="description" style="margin-top:20px;">
                    <h3>@(isAr ? "تفاصيل المنتج" : "Description")</h3>
                    <p>@(isAr? Model.Description: (Model.DescriptionEn ?? Model.Description))</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    function changeQty(amount) {
        const input = document.getElementById('qtyInput');
        let val = parseInt(input.value) + amount;
        if (val >= 1 && val <= parseInt(input.getAttribute('max'))) {
            input.value = val;
        }
    }
</script>