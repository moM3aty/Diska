@model IEnumerable<Diska.Models.Product>
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = ViewBag.CategoryName;
    var brands = ViewBag.AvailableBrands as List<string>;
}

<section class="category-section section-padding">
    <div class="container">

        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">@(isAr ? "الرئيسية" : "Home")</a> / <span>@ViewBag.CategoryName</span>
        </div>

        <div class="category-layout">

            <!-- Sidebar Filter -->
            <aside class="sidebar">
                <form method="get" asp-action="Category">
                    <input type="hidden" name="id" value="@ViewBag.CategoryId" />

                    <div class="filter-group">
                        <h3>@(isAr ? "نطاق السعر" : "Price Range")</h3>
                        <div class="price-range">
                            <input type="number" name="minPrice" placeholder="@(isAr ? "من" : "Min")" value="@Context.Request.Query["minPrice"]">
                            <input type="number" name="maxPrice" placeholder="@(isAr ? "إلى" : "Max")" value="@Context.Request.Query["maxPrice"]">
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>@(isAr ? "الماركات / التجار" : "Brands / Merchants")</h3>
                        @if (brands != null && brands.Any())
                        {
                            foreach (var brand in brands)
                            {
                                if (!string.IsNullOrEmpty(brand))
                                {
                                    <label>
                                        <input type="checkbox" name="brands" value="@brand" @(Context.Request.Query["brands"].Contains(brand) ? "checked" : "")>
                                        @brand
                                    </label>
                                }
                            }
                        }
                        else
                        {
                            <p style="color:#999; font-size:0.8rem;">@(isAr ? "لا توجد ماركات" : "No brands")</p>
                        }
                    </div>

                    <button type="submit" class="btn primary w-100">@(isAr ? "تطبيق الفلتر" : "Apply Filter")</button>
                </form>
            </aside>

            <!-- Products -->
            <main class="category-products">
                <div class="products-header">
                    <h2>@ViewBag.CategoryName <small style="color:#666; font-size:0.9rem;">(@Model.Count() @(isAr ? "منتج" : "Items"))</small></h2>

                    <form method="get" id="sortForm" style="margin:0;">
                        <input type="hidden" name="id" value="@ViewBag.CategoryId" />
                        <!-- Preserve filters when sorting -->
                        @foreach (var key in Context.Request.Query.Keys)
                        {
                            if (key != "sort" && key != "id")
                            {
                                <input type="hidden" name="@key" value="@Context.Request.Query[key]" />
                            }
                        }

                        <select name="sort" onchange="document.getElementById('sortForm').submit()" style="padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="">@(isAr ? "الترتيب الافتراضي" : "Default Sorting")</option>
                            <option value="price_asc" selected="@(ViewBag.CurrentSort == "price_asc")">@(isAr ? "السعر: الأقل للأعلى" : "Price: Low to High")</option>
                            <option value="price_desc" selected="@(ViewBag.CurrentSort == "price_desc")">@(isAr ? "السعر: الأعلى للأقل" : "Price: High to Low")</option>
                        </select>
                    </form>
                </div>

                @if (!Model.Any())
                {
                    <div style="text-align:center; padding:50px; background:#fff; border-radius:10px; border:1px solid #eee;">
                        <p>@(isAr ? "لا توجد منتجات تطابق اختيارك." : "No products found.")</p>
                    </div>
                }
                else
                {
                    <div class="products-grid">
                        @foreach (var item in Model)
                        {
                            <div class="product-card" data-id="@item.Id" data-stock="@item.StockQuantity">
                                <button class="fav-btn" onclick="toggleWishlist(@item.Id, this)"><i class="far fa-heart"></i></button>

                                <a asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none;">
                                    <div class="product-img"><img src="~/@item.ImageUrl" alt="@item.Name"></div>
                                </a>

                                <div class="product-info">
                                    <a asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none; color:inherit;">
                                        <h4>@(isAr? item.Name: (item.NameEn ?? item.Name))</h4>
                                    </a>
                                    <div class="pricing">
                                        <span class="current-price">@item.Price.ToString("N2") @(isAr ? "ج.م" : "EGP")</span>
                                    </div>
                                    <div class="add-to-cart">
                                        <button class="add-btn btn primary w-100" onclick="addToCart(this)">
                                            @(isAr ? "إضافة" : "Add") <i class="fas fa-cart-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </main>
        </div>
    </div>
</section>