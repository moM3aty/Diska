@model IEnumerable<Diska.Models.Product>
@using System.Globalization
@using System.Text.RegularExpressions
@using Diska.Data
@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext _context
@inject UserManager<Diska.Models.ApplicationUser> UserManager

@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = ViewBag.CategoryName;
    var brands = ViewBag.AvailableBrands as List<string>;

    // جلب قائمة المفضلة للمستخدم الحالي لتلوين القلب
    var user = await UserManager.GetUserAsync(User);
    var wishlistIds = user != null
        ? _context.WishlistItems.Where(w => w.UserId == user.Id).Select(w => w.ProductId).ToList()
        : new List<int>();
}

<!-- New Modern Card Design & Animations -->
<style>
    :root {
        --card-radius: 16px;
        --card-bg: #ffffff;
        --primary-color: #2563eb;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --accent-color: #FACC15;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 25px;
    }

    /* Card Container */
    .pro-card-v2 {
        background: var(--card-bg);
        border-radius: var(--card-radius);
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #f1f5f9;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

        .pro-card-v2:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);
            border-color: transparent;
        }

    /* Image Area */
    .pro-img-box {
        position: relative;
        height: 240px;
        background: #f8fafc;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

        .pro-img-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.5s ease;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.05));
        }

    .pro-card-v2:hover .pro-img-box img {
        transform: scale(1.08);
    }

    /* Badges & Actions */
    .badge-discount {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #ef4444;
        color: white;
        font-weight: 800;
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        z-index: 2;
    }

    html[dir="ltr"] .badge-discount {
        left: 15px;
        right: auto;
    }

    .btn-wishlist {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        border: 1px solid #e2e8f0;
        color: #94a3b8;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 3;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    html[dir="ltr"] .btn-wishlist {
        right: 15px;
        left: auto;
    }

    .btn-wishlist:hover {
        background: #fff;
        transform: scale(1.1);
        color: #ef4444;
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    /* حالة القلب الأحمر */
    .btn-wishlist.active {
        color: #ef4444;
        border-color: #fee2e2;
        background: #fff;
    }

        .btn-wishlist.active i {
            font-weight: 900; /* Solid icon */
        }

    /* Content Area */
    .pro-details {
        padding: 18px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .pro-cat {
        font-size: 0.75rem;
        color: var(--text-sub);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .pro-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0 0 10px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 42px; /* Fixed height for alignment */
    }

    .pro-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: var(--text-sub);
        background: #f1f5f9;
        padding: 5px 10px;
        border-radius: 6px;
        width: fit-content;
        margin-bottom: 12px;
    }

    .pro-price-box {
        margin-top: auto;
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-bottom: 15px;
    }

    .price-current {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--primary-color);
    }

    .price-old {
        font-size: 0.85rem;
        text-decoration: line-through;
        color: #cbd5e1;
        font-weight: 500;
    }

    /* Add Button */
    .btn-add-cart {
        width: 100%;
        background: var(--text-main);
        color: #fff;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

        .btn-add-cart:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
        }

        .btn-add-cart:active {
            transform: scale(0.98);
        }
</style>

<section class="category-section section-padding">
    <div class="container">

        <!-- Header Controls -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:15px;">
            <div class="breadcrumb" style="margin:0; font-size:0.95rem;">
                <a asp-controller="Home" asp-action="Index" style="color:#94a3b8;">@(isAr ? "الرئيسية" : "Home")</a>
                <span style="color:#cbd5e1; margin:0 8px;">/</span>
                <span style="font-weight:bold; color:var(--text-main);">@ViewBag.CategoryName</span>
            </div>

            <div class="sort-box">
                <select onchange="location = this.value;" style="padding:10px 30px 10px 15px; border:1px solid #e2e8f0; border-radius:30px; font-weight:600; cursor:pointer; outline:none; background:#fff; font-size:0.9rem; appearance:none; -webkit-appearance:none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;">
                    <option>@(isAr ? "ترتيب حسب" : "Sort By")</option>
                    <option value="?id=@ViewBag.CategoryId&sort=price_asc">@(isAr ? "الأقل سعراً" : "Lowest Price")</option>
                    <option value="?id=@ViewBag.CategoryId&sort=price_desc">@(isAr ? "الأعلى سعراً" : "Highest Price")</option>
                </select>
            </div>
        </div>

        <div class="category-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <form method="get" asp-action="Category">
                    <input type="hidden" name="id" value="@ViewBag.CategoryId" />

                    <div class="filter-group">
                        <h3>@(isAr ? "نطاق السعر" : "Price Range")</h3>
                        <div class="price-range">
                            <input type="number" name="minPrice" placeholder="@(isAr ? "من" : "Min")" value="@Context.Request.Query["minPrice"]">
                            <input type="number" name="maxPrice" placeholder="@(isAr ? "إلى" : "Max")" value="@Context.Request.Query["maxPrice"]">
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>@(isAr ? "الماركات" : "Brands")</h3>
                        @if (brands != null && brands.Any())
                        {
                            foreach (var brand in brands)
                            {
                                if (!string.IsNullOrEmpty(brand))
                                {
                                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;">
                                        <input type="checkbox" name="brands" value="@brand" @(Context.Request.Query["brands"].Contains(brand) ? "checked" : "") style="width:16px; height:16px;">
                                        <span>@brand</span>
                                    </label>
                                }
                            }
                        }
                    </div>

                    <button type="submit" class="btn primary w-100" style="margin-top:10px;">@(isAr ? "تصفية النتائج" : "Apply Filter")</button>
                </form>
            </aside>

            <!-- Products Grid -->
            <main class="category-products">
                @if (!Model.Any())
                {
                    <div style="text-align:center; padding:80px; background:#fff; border-radius:16px; border:1px solid #eee;">
                        <i class="fas fa-box-open fa-4x" style="color:#e2e8f0; margin-bottom:20px;"></i>
                        <h3 style="color:#94a3b8; font-weight:600;">@(isAr ? "لا توجد منتجات متاحة حالياً." : "No products found.")</h3>
                        <a href="/" class="btn primary small" style="margin-top:15px;">@(isAr ? "العودة للرئيسية" : "Back Home")</a>
                    </div>
                }
                else
                {
                    <div class="products-grid">
                        @foreach (var item in Model)
                        {
                            // التحقق هل المنتج في المفضلة
                            bool isLiked = wishlistIds.Contains(item.Id);

                            <div class="pro-card-v2 product-card" data-id="@item.Id" data-stock="@item.StockQuantity">

                                <!-- Discount Badge -->
                                @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                {
                                    var discount = (int)((1 - (item.Price / item.OldPrice.Value)) * 100);
                                    if (discount > 0)
                                    {
                                        <div class="badge-discount">@(isAr ? $"خصم {discount}%" : $"{discount}% OFF")</div>
                                    }
                                }

                                <!-- Wishlist Button (Updated to check isLiked) -->
                                <button class="btn-wishlist @(isLiked ? "active" : "")" onclick="toggleWishlist(@item.Id, this)" title="@(isAr ? "إضافة للمفضلة" : "Add to Wishlist")">
                                    <i class="@(isLiked ? "fas" : "far") fa-heart"></i>
                                </button>

                                <!-- Image -->
                                <a asp-action="Details" asp-route-id="@item.Id" class="pro-img-box">
                                    <img src="~/@item.ImageUrl" alt="@item.Name" onerror="this.src='https://placehold.co/300x300/png?text=Product'">
                                </a>

                                <!-- Details -->
                                <div class="pro-details">
                                    <span class="pro-cat">@(isAr? item.Category?.Name : (item.Category?.NameEn ?? item.Category?.Name))</span>

                                    <a asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none;">
                                        <h3 class="pro-title">@(isAr? item.Name: (item.NameEn ?? item.Name))</h3>
                                    </a>

                                    <div class="pro-meta">
                                        <i class="fas fa-box"></i>
                                        <span>@(isAr ? $"الكرتونة: {item.UnitsPerCarton} ق" : $"Carton: {item.UnitsPerCarton} pcs")</span>
                                    </div>

                                    <div class="pro-price-box">
                                        <div style="display:flex; flex-direction:column;">
                                            <span class="price-current">@item.Price.ToString("N0") <small style="font-size:0.75rem; font-weight:normal;">@(isAr ? "ج.م" : "EGP")</small></span>
                                            @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                            {
                                                <span class="price-old">@item.OldPrice.Value.ToString("N0")</span>
                                            }
                                        </div>
                                    </div>

                                    <button class="btn-add-cart" onclick="addToCart(this)">
                                        <span>@(isAr ? "إضافة للسلة" : "Add to Cart")</span>
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </main>
        </div>
    </div>
</section>

<!-- Required Scripts for SweetAlert & Wishlist Logic -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        async function toggleWishlist(productId, btn) {
            try {
                const icon = btn.querySelector('i');
                const response = await fetch('/Wishlist/Toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${productId}`
                });

                if (response.status === 401) {
                    Swal.fire({
                        title: '@(isAr ? "تنبيه" : "Alert")',
                        text: '@(isAr ? "يجب عليك تسجيل الدخول أولاً لإضافة منتجات للمفضلة." : "Please login first to add items to wishlist.")',
                        icon: 'warning',
                        confirmButtonText: '@(isAr ? "دخول" : "Login")',
                        showCancelButton: true,
                        cancelButtonText: '@(isAr ? "إلغاء" : "Cancel")'
                    }).then((result) => {
                        if (result.isConfirmed) window.location.href = '/Account/Login';
                    });
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    if (result.status === 'added') {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        btn.classList.add('active');

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: '@(isAr ? "تمت الإضافة للمفضلة" : "Added to Wishlist")',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        btn.classList.remove('active');

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'info',
                            title: '@(isAr ? "تم الحذف من المفضلة" : "Removed from Wishlist")',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                }
            } catch (error) {
                console.error(error);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: '@(isAr ? "حدث خطأ" : "Error Occurred")',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }
    </script>
}