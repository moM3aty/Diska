@model IEnumerable<Diska.Models.Product>
@using System.Globalization
@using Diska.Data
@using Microsoft.AspNetCore.Identity
@inject UserManager<Diska.Models.ApplicationUser> UserManager
@inject ApplicationDbContext _context

@{
    Layout = "_Layout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    var categoryName = ViewBag.CategoryName as string ?? (isAr ? "كل المنتجات" : "All Products");
    ViewData["Title"] = categoryName;

    var categories = ViewBag.Categories as IEnumerable<Diska.Models.Category>;
    var merchants = ViewBag.AvailableMerchants as List<string>;

    int discount = 0;

    // Wishlist Logic
    var user = await UserManager.GetUserAsync(User);
    var wishlistIds = user != null
        ? _context.WishlistItems.Where(w => w.UserId == user.Id).Select(w => w.ProductId).ToList()
        : new List<int>();
}

<style>
    /* =========================================
           PREMIUM CATALOG STYLES (Light & Dark)
           ========================================= */
    :root {
        /* Light Theme Defaults */
        --cat-bg: #f8fafc;
        --cat-card-bg: #ffffff;
        --cat-text-main: #0f172a;
        --cat-text-muted: #64748b;
        --cat-border: #e2e8f0;
        --cat-primary: #0F172A;
        --cat-accent: #FACC15;
        --cat-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        --cat-input-bg: #f8fafc;
    }

    [data-bs-theme="dark"] {
        /* Dark Theme Overrides */
        --cat-bg: #020617; /* Deep Dark */
        --cat-card-bg: #1e293b; /* Slate 800 */
        --cat-text-main: #f8fafc; /* Light Text */
        --cat-text-muted: #94a3b8; /* Muted Text */
        --cat-border: rgba(255, 255, 255, 0.08);
        --cat-primary: #f8fafc; /* Headings */
        --cat-accent: #FACC15; /* Gold */
        --cat-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        --cat-input-bg: #0f172a; /* Slate 900 */
    }

    body {
        background-color: var(--cat-bg);
        transition: background-color 0.3s ease;
    }

    .catalog-wrapper {
        padding: 40px 0;
        min-height: 100vh;
        font-family: 'Cairo', sans-serif;
    }

    /* --- Header --- */
    .catalog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
        background: var(--cat-card-bg);
        padding: 20px 30px;
        border-radius: 16px;
        box-shadow: var(--cat-shadow);
        border: 1px solid var(--cat-border);
    }

    .page-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--cat-primary);
    }

    .result-count {
        color: var(--cat-text-muted);
        font-size: 0.9rem;
        margin-top: 5px;
        display: block;
    }

    .sort-select {
        padding: 10px 20px;
        border-radius: 30px;
        border: 1px solid var(--cat-border);
        background: var(--cat-input-bg);
        color: var(--cat-text-main);
        font-weight: 600;
        cursor: pointer;
        outline: none;
        transition: 0.2s;
    }

        .sort-select:hover {
            border-color: var(--cat-primary);
        }

    [data-bs-theme="dark"] .sort-select option {
        background-color: var(--cat-card-bg);
    }

    /* --- Layout --- */
    .catalog-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
        align-items: start;
    }

    /* --- Sidebar --- */
    .filter-sidebar {
        background: var(--cat-card-bg);
        padding: 25px;
        border-radius: 16px;
        border: 1px solid var(--cat-border);
        box-shadow: var(--cat-shadow);
        position: sticky;
        top: 20px;
        transition: background-color 0.3s ease;
    }

    .filter-group {
        margin-bottom: 25px;
        border-bottom: 1px dashed var(--cat-border);
        padding-bottom: 20px;
    }

        .filter-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

    .filter-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--cat-primary);
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
    }

    /* Category Links */
    .category-link {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        color: var(--cat-text-muted);
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        border-radius: 8px;
        font-weight: 600;
    }

        .category-link:hover {
            color: var(--cat-primary);
            background-color: var(--cat-input-bg);
        }

        .category-link.active {
            color: var(--cat-primary);
            background-color: rgba(79, 70, 229, 0.1);
            font-weight: 700;
        }

    [data-bs-theme="dark"] .category-link.active {
        background-color: rgba(250, 204, 21, 0.1);
        color: var(--cat-accent);
    }

    .cat-icon {
        font-size: 1rem;
        margin-inline-end: 10px;
        width: 20px;
        text-align: center;
        color: var(--cat-text-muted);
    }

    .category-link.active .cat-icon {
        color: var(--cat-primary);
    }

    [data-bs-theme="dark"] .category-link.active .cat-icon {
        color: var(--cat-accent);
    }

    /* Sub Categories */
    .sub-cats {
        padding-inline-start: 15px;
        margin-inline-start: 18px;
        border-inline-start: 2px solid var(--cat-border);
        margin-top: 5px;
        margin-bottom: 10px;
        display: none;
    }

        .sub-cats.open {
            display: block;
        }

    .sub-link {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        color: var(--cat-text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        border-radius: 6px;
        transition: 0.2s;
    }

        .sub-link:hover {
            color: var(--cat-primary);
            background-color: var(--cat-input-bg);
        }

        .sub-link.active {
            color: var(--cat-primary);
            font-weight: 700;
            background: rgba(79, 70, 229, 0.1);
        }

    [data-bs-theme="dark"] .sub-link.active {
        background: rgba(250, 204, 21, 0.1);
        color: var(--cat-accent);
    }

    /* Price Inputs */
    .price-inputs {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .price-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--cat-border);
        border-radius: 8px;
        text-align: center;
        font-size: 0.9rem;
        background-color: var(--cat-input-bg);
        color: var(--cat-text-main);
        outline: none;
    }

        .price-input:focus {
            border-color: var(--cat-accent);
        }

    /* Checkboxes */
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        color: var(--cat-text-muted);
        font-size: 0.95rem;
    }

    .checkbox-input {
        width: 18px;
        height: 18px;
        accent-color: var(--cat-primary);
        cursor: pointer;
    }

    [data-bs-theme="dark"] .checkbox-input {
        accent-color: var(--cat-accent);
    }

    /* Sidebar Buttons */
    .btn-filter {
        width: 100%;
        background: var(--cat-primary);
        color: #fff;
        padding: 12px;
        border-radius: 10px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    [data-bs-theme="dark"] .btn-filter {
        background: var(--cat-accent);
        color: #000;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    .btn-reset {
        display: block;
        text-align: center;
        margin-top: 15px;
        color: var(--cat-text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        transition: 0.2s;
    }

        .btn-reset:hover {
            color: var(--cat-primary);
            text-decoration: underline;
        }

    /* --- Product Cards --- */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 25px;
    }

    .product-card {
        background: var(--cat-card-bg);
        border-radius: 20px;
        border: 1px solid var(--cat-border);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--cat-shadow);
    }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
            border-color: var(--cat-primary);
        }

    [data-bs-theme="dark"] .product-card:hover {
        box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        border-color: var(--cat-accent);
    }

    .product-img {
        height: 220px;
        padding: 25px;
        background: #fff; /* Always white for product image */
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-bottom: 1px solid var(--cat-border);
    }

    [data-bs-theme="dark"] .product-img {
        background: transparent;
    }
        .product-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

    .product-card:hover .product-img img {
        transform: scale(1.1);
    }

    /* Badges */
    .badge-container {
        position: absolute;
        top: 15px;
        @(isAr ? "right" : "left") : 15px;
        z-index: 2;
        display: flex;
        flex-direction: column;
        gap: 5px;
        pointer-events: none;
    }

    .badge-discount, .badge-bestseller {
        color: #fff;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 800;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .badge-discount {
        background: #ef4444;
    }

    .badge-bestseller {
        background: linear-gradient(135deg, #FFD700, #FDB931);
    }

    .fav-btn {
        position: absolute;
        top: 15px; @(isAr
                ? "left" : "right") : 15px;
        width: 35px;
        height: 35px;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        border: 1px solid #e2e8f0;
        color: #94a3b8;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 3;
        transition: 0.3s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

        .fav-btn:hover {
            transform: scale(1.1);
            color: #ef4444;
        }

        .fav-btn.active {
            color: #ef4444;
            background: #fee2e2;
            border-color: #ef4444;
        }

    /* Info */
    .product-info {
        padding: 15px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .pro-cat {
        font-size: 0.75rem;
        color: var(--cat-text-muted);
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .product-title h4 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--cat-text-main);
        margin: 0 0 10px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 40px;
        transition: color 0.2s;
    }

    .product-card:hover h4 {
        color: var(--cat-primary);
    }

    [data-bs-theme="dark"] .product-card:hover h4 {
        color: var(--cat-accent);
    }

    .pricing {
        font-size: 1.2rem;
        font-weight: 900;
        color: var(--cat-primary);
        margin-top: auto;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 6px;
    }

    [data-bs-theme="dark"] .pricing {
        color: #f8fafc;
    }

    .old-price {
        text-decoration: line-through;
        color: var(--cat-text-muted);
        font-size: 0.85rem;
        font-weight: 600;
    }

    .product-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed var(--cat-border);
        font-size: 0.75rem;
        color: var(--cat-text-muted);
    }

    .stock-info {
        font-weight: 700;
        color: #16a34a;
    }

        .stock-info.low {
            color: #ef4444;
        }

    /* Actions */
    .add-to-cart {
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transform: translateY(10px);
        transition: 0.3s;
    }

    .product-card:hover .add-to-cart {
        opacity: 1;
        transform: translateY(0);
    }

    /* Mobile: Always show actions */
    @@media (max-width: 768px) {
        .add-to-cart {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .qty-control-card {
        display: flex;
        border: 1px solid var(--cat-border);
        border-radius: 8px;
        overflow: hidden;
        background: var(--cat-input-bg);
        height: 35px;
    }

        .qty-control-card button {
            width: 30px;
            height: 100%;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--cat-text-main);
            font-weight: bold;
            transition: 0.2s;
        }

            .qty-control-card button:hover {
                background: rgba(0,0,0,0.05);
            }

        .qty-control-card input {
            width: 35px;
            border: none;
            text-align: center;
            font-weight: 700;
            color: var(--cat-text-main);
            outline: none;
            background: transparent;
            font-size: 0.9rem;
        }

    .add-btn {
        flex: 1;
        background: var(--cat-primary);
        color: #fff;
        border: none;
        padding: 0 10px;
        height: 35px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.85rem;
    }

    [data-bs-theme="dark"] .add-btn {
        background: var(--cat-accent);
        color: #000;
    }

    .add-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    .add-btn:disabled {
        background: var(--cat-border);
        cursor: not-allowed;
        color: var(--cat-text-muted);
        box-shadow: none;
        transform: none;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px;
        background: var(--cat-card-bg);
        border-radius: 20px;
        border: 2px dashed var(--cat-border);
        grid-column: 1 / -1;
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--cat-text-muted);
        opacity: 0.3;
        margin-bottom: 20px;
    }

    /* Animation */
    .fade-up {
        animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .catalog-grid {
            grid-template-columns: 1fr;
        }

        .filter-sidebar {
            position: static;
            margin-bottom: 30px;
        }
    }
</style>

<div class="catalog-wrapper">
    <div class="container fade-up">

        <!-- Breadcrumb -->
        <div style="margin-bottom: 20px; font-size: 0.9rem;">
            <a href="/" style="text-decoration:none; color:var(--cat-text-main);">@(isAr ? "الرئيسية" : "Home")</a>
            <span style="color:var(--cat-text-muted); margin:0 10px;">/</span>
            <span style="font-weight:bold; color:var(--cat-primary);">@categoryName</span>
        </div>

        <!-- Header -->
        <div class="catalog-header">
            <div>
                <h1 class="page-title">@categoryName</h1>
                <span class="result-count">@Model.Count() @(isAr ? "منتج" : "products")</span>
            </div>

            <form id="sortForm" method="get" asp-action="Index">
                <input type="hidden" name="categoryId" value="@Context.Request.Query["categoryId"]" />
                <input type="hidden" name="query" value="@Context.Request.Query["query"]" />
                <input type="hidden" name="minPrice" value="@Context.Request.Query["minPrice"]" />
                <input type="hidden" name="maxPrice" value="@Context.Request.Query["maxPrice"]" />

                <select name="sort" class="sort-select" onchange="this.form.submit()">
                    <option value="">@(isAr ? "ترتيب حسب" : "Sort By")</option>
                    <option value="newest" selected="@(ViewBag.CurrentSort == "newest")">@(isAr ? "الأحدث" : "Newest")</option>
                    <option value="price_asc" selected="@(ViewBag.CurrentSort == "price_asc")">@(isAr ? "السعر: الأقل للأعلى" : "Price: Low to High")</option>
                    <option value="price_desc" selected="@(ViewBag.CurrentSort == "price_desc")">@(isAr ? "السعر: الأعلى للأقل" : "Price: High to Low")</option>
                </select>
            </form>
        </div>

        <div class="catalog-grid">

            <!-- Sidebar -->
            <aside class="filter-sidebar">
                <form method="get" asp-action="Index">
                    <input type="hidden" name="sort" value="@ViewBag.CurrentSort" />
                    <input type="hidden" name="query" value="@Context.Request.Query["query"]" />

                    <!-- Categories Tree -->
                    @if (categories != null && categories.Any())
                    {
                        <div class="filter-group">
                            <div class="filter-title">@(isAr ? "الأقسام" : "Categories")</div>
                            <div class="category-tree">
                                <a href="@Url.Action("Index", new { sort = ViewBag.CurrentSort })"
                                   class="category-link @(ViewBag.CategoryId == null ? "active" : "")">
                                    <span><i class="fas fa-th-large cat-icon"></i> @(isAr ? "الكل" : "All")</span>
                                </a>

                                @foreach (var cat in categories.Where(c => c.ParentId == null))
                                {
                                    bool isParentActive = (ViewBag.CategoryId == cat.Id);
                                    bool isChildActive = (cat.Children != null && cat.Children.Any(c => c.Id == ViewBag.CategoryId));
                                    bool isOpen = isParentActive || isChildActive;

                                    <div class="cat-item">
                                        <a href="@Url.Action("Index", new { categoryId = cat.Id, sort = ViewBag.CurrentSort })"
                                           class="category-link @(isParentActive ? "active" : "")"
                                           style="@(isChildActive ? "color:var(--cat-primary); font-weight:700;" : "")">
                                            <span>
                                                <i class="@(cat.IconClass ?? "fas fa-folder") cat-icon"></i>
                                                @(isAr? cat.Name: cat.NameEn)
                                            </span>
                                            @if (cat.Children != null && cat.Children.Any())
                                            {
                                                <i class="fas @(isOpen ? "fa-angle-up" : "fa-angle-down") small text-muted"></i>
                                            }
                                        </a>

                                        @if (cat.Children != null && cat.Children.Any())
                                        {
                                            <div class="sub-cats @(isOpen ? "open" : "")">
                                                @foreach (var sub in cat.Children)
                                                {
                                                    <a href="@Url.Action("Index", new { categoryId = sub.Id, sort = ViewBag.CurrentSort })"
                                                       class="sub-link @(ViewBag.CategoryId == sub.Id ? "active" : "")">
                                                        <i class="@(sub.IconClass ?? "fas fa-caret-right")"></i>
                                                        @(isAr? sub.Name: sub.NameEn)
                                                    </a>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Price -->
                    <div class="filter-group">
                        <div class="filter-title">@(isAr ? "السعر" : "Price")</div>
                        <div class="price-inputs">
                            <input type="number" name="minPrice" class="price-input" placeholder="@(isAr ? "من" : "Min")" value="@Context.Request.Query["minPrice"]">
                            <span>-</span>
                            <input type="number" name="maxPrice" class="price-input" placeholder="@(isAr ? "إلى" : "Max")" value="@Context.Request.Query["maxPrice"]">
                        </div>
                    </div>

                    <!-- Merchants -->
                    @if (merchants != null && merchants.Any())
                    {
                        <div class="filter-group">
                            <div class="filter-title">@(isAr ? "التجار" : "Merchants")</div>
                            <div style="max-height:200px; overflow-y:auto;">
                                @foreach (var m in merchants)
                                {
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="merchants" value="@m" class="checkbox-input" @(Context.Request.Query["merchants"].Contains(m) ? "checked" : "")>
                                        @m
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    <button type="submit" class="btn-filter">@(isAr ? "تصفية النتائج" : "Apply Filters")</button>
                    <a asp-action="Index" class="btn-reset">@(isAr ? "إعادة تعيين" : "Reset")</a>
                </form>
            </aside>

            <!-- Products -->
            <main>
                @if (!Model.Any())
                {
                    <div class="empty-state">
                        <i class="fas fa-search empty-icon"></i>
                        <h3>@(isAr ? "لا توجد نتائج" : "No products found")</h3>
                        <p>@(isAr ? "جرب تغيير خيارات البحث أو الفلترة" : "Try adjusting your filters")</p>
                        <a href="/" class="btn-reset" style="color:var(--cat-primary);">@(isAr ? "العودة للرئيسية" : "Back Home")</a>
                    </div>
                }
                else
                {
                    <div class="products-grid">
                        @foreach (var item in Model)
                        {
                            bool isBestSeller = item.StockQuantity > 0 && item.StockQuantity < 20;
                            bool isLiked = wishlistIds.Contains(item.Id);

                            <div class="product-card" data-id="@item.Id" data-stock="@item.StockQuantity">

                                <!-- Badges & Wishlist -->
                                <div class="badge-container">
                                    @if (isBestSeller)
                                    {
                                        <span class="badge-bestseller">
                                            <i class="fas fa-crown"></i> @(isAr ? "الأكثر مبيعاً" : "Best Seller")
                                        </span>
                                    }

                                    @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                    {
                                        discount = (int)Math.Round(((item.OldPrice.Value - item.Price) / item.OldPrice.Value) * 100);
                                        <span class="badge-discount">
                                            @(isAr ? "خصم" : "Sale") @discount%
                                        </span>
                                    }
                                </div>

                                <!-- Wishlist Button -->
                                <button class="fav-btn @(isLiked ? "active" : "")" onclick="toggleWishlist(@item.Id, this)">
                                    <i class="@(isLiked ? "fas" : "far") fa-heart"></i>
                                </button>

                                <!-- Product Image -->
                                <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" class="product-img">
                                    <img src="~/@item.ImageUrl" onerror="this.src='/images/default.png'" alt="@item.Name">
                                </a>

                                <!-- Product Info -->
                                <div class="product-info">
                                    <span class="pro-cat">@(isAr? item.Category?.Name : item.Category?.NameEn)</span>

                                    <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none; color:inherit;">
                                        <h4>@(isAr? item.Name: item.NameEn)</h4>
                                    </a>

                                    <div class="pricing">
                                        <span>@item.Price.ToString("N0") <small>@(isAr ? "ج.م" : "EGP")</small></span>
                                        @if (item.OldPrice.HasValue)
                                        {
                                            <span class="old-price">@item.OldPrice.Value.ToString("N0")</span>
                                        }
                                    </div>

                                    <!-- Meta -->
                                    <div class="product-meta">
                                        <span class="unit"><i class="fas fa-box"></i> @item.UnitsPerCarton</span>
                                        @if (item.StockQuantity > 0)
                                        {
                                            <span class="stock-info">@(isAr ? "متوفر" : "In Stock")</span>
                                        }
                                        else
                                        {
                                            <span class="stock-info low">@(isAr ? "نافذ" : "Out of Stock")</span>
                                        }
                                    </div>

                                    <!-- Actions -->
                                    <div class="add-to-cart">
                                        <div class="qty-control-card">
                                            <button onclick="updateQty(this, -1)">-</button>
                                            <input type="number" id="qty-@item.Id" value="1" min="1" max="@item.StockQuantity" readonly>
                                            <button onclick="updateQty(this, 1)">+</button>
                                        </div>

                                        @if (item.StockQuantity > 0)
                                        {
                                            <button class="add-btn" onclick="addToCart(@item.Id, this)">
                                                @(isAr ? "أضف" : "Add") <i class="fas fa-cart-plus"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="add-btn" disabled>@(isAr ? "غير متوفر" : "Out")</button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </main>
        </div>

    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function updateQty(btn, n) {
            const el = btn.parentElement.querySelector('input');
            let v = parseInt(el.value) + n;
            if(v >= 1 && v <= parseInt(el.getAttribute('max'))) el.value = v;
        }

        function addToCart(id, btn) {
            let qty = document.getElementById('qty-' + id).value;
            let original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            let formData = new FormData();
            formData.append('productId', id);
            formData.append('quantity', qty);

            fetch('/Cart/AddItem', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: res.message, showConfirmButton: false, timer: 1500 });

                    let cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
                    // Simple cart update for grid (no color logic here yet)
                    let uniqueId = id + '_def';
                    let existing = cart.find(i => i.uniqueId === uniqueId);

                    if(existing) existing.qty += parseInt(qty);
                    else cart.push({
                         id: res.product.id, uniqueId: uniqueId, qty: parseInt(qty),
                         name: res.product.name, price: res.product.price, image: res.product.image
                    });

                    localStorage.setItem('DISKA_CART', JSON.stringify(cart));
                    if(typeof updateCartBadge === 'function') updateCartBadge();
                } else {
                    Swal.fire({ icon: 'warning', title: 'تنبيه', text: res.message });
                }
            })
            .catch(e => console.error(e))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = original;
            });
        }

        async function toggleWishlist(id, btn) {
            try {
                const icon = btn.querySelector('i');
                const response = await fetch('/Wishlist/Toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `productId=${id}`
                });

                if(response.status === 401) { window.location.href = '/Account/Login'; return; }
                const res = await response.json();
                if(res.success) {
                    if(res.status === 'added') {
                        icon.classList.remove('far'); icon.classList.add('fas'); btn.classList.add('active');
                        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'تمت الإضافة للمفضلة', showConfirmButton: false, timer: 1500 });
                    } else {
                        icon.classList.remove('fas'); icon.classList.add('far'); btn.classList.remove('active');
                        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'تم الحذف من المفضلة', showConfirmButton: false, timer: 1500 });
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
}
}