@model IEnumerable<Diska.Models.GroupDeal>
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "صفقات الجملة" : "Wholesale Deals";
}

<section class="section-padding">
    <div class="container">
        <div style="text-align: center; margin-bottom: 40px;">
            <h2 class="page-title" style="justify-content: center;">🔥 @(isAr ? "صفقات الكميات الكبيرة" : "Bulk Deals")</h2>
            <p style="color: #666;">@(isAr ? "اشتري مع غيرك وحققوا التارجت عشان السعر ينزل!" : "Group buy to hit the target and lower the price!")</p>
        </div>

        <div class="products-grid">
            @foreach (var deal in Model)
            {
                var percentage = (double)deal.ReservedQuantity / deal.TargetQuantity * 100;
                var timeLeft = deal.EndDate - DateTime.Now;

                <div class="product-card deal-card" id="deal-@deal.Id">
                    <div class="flash-badge" style="background: linear-gradient(45deg, #ff9800, #f57c00);">
                        <i class="fas fa-clock"></i> @timeLeft.Days @(isAr ? "يوم باقي" : "Days left")
                    </div>

                    <div class="product-img">
                        <img src="~/@deal.Product?.ImageUrl" alt="@deal.Product?.Name">
                    </div>

                    <div class="product-info">
                        <h4>@(isAr? deal.Product?.Name : (deal.Product?.NameEn ?? deal.Product?.Name))</h4>

                        <div class="pricing">
                            <span class="current-price" style="color:#d32f2f; font-size:1.2rem;">@deal.DealPrice.ToString("N2")</span>
                            <span class="old-price">@deal.Product?.Price.ToString("N2")</span>
                        </div>

                        <!-- Progress Bar -->
                        <div style="margin: 15px 0;">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                                <span>@(isAr ? "تم حجز:" : "Reserved:") <b id="reserved-@deal.Id">@deal.ReservedQuantity</b></span>
                                <span>@(isAr ? "الهدف:" : "Target:") <b>@deal.TargetQuantity</b></span>
                            </div>
                            <div style="background:#eee; height:10px; border-radius:5px; overflow:hidden;">
                                <div id="progress-@deal.Id" style="background:#10b981; height:100%; width:@percentage%;"></div>
                            </div>
                        </div>

                        <form onsubmit="joinDeal(event, @deal.Id)" style="display:flex; gap:10px;">
                            <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:70px; text-align:center;">
                            <button type="submit" class="btn primary w-100">@(isAr ? "انضم للصفقة" : "Join Deal")</button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

@section Scripts {
    <script>
        async function joinDeal(e, dealId) {
            e.preventDefault();
            const form = e.target;
            const qty = form.querySelector('input[name="quantity"]').value;
            const btn = form.querySelector('button');

            // Check login (simple check, backend handles auth)
            // Ideally check a global JS variable for auth status

            const formData = new FormData();
            formData.append('dealId', dealId);
            formData.append('quantity', qty);

            try {
                btn.disabled = true;
                const response = await fetch('/Deals/JoinDeal', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });

                if (response.status === 401) {
                    window.location.href = '/Account/Login';
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // Update UI live
                    document.getElementById(`reserved-${dealId}`).innerText = result.reserved;
                    document.getElementById(`progress-${dealId}`).style.width = result.newProgress + '%';
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error(error);
                alert("حدث خطأ ما");
            } finally {
                btn.disabled = false;
            }
        }
    </script>
}