@model Diska.Models.GroupDeal
@using System.Globalization
@using Diska.Data
@using Microsoft.AspNetCore.Identity
@inject UserManager<Diska.Models.ApplicationUser> UserManager
@inject ApplicationDbContext _context

@{
    Layout = "_Layout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = Model.Title;

    var products = ViewBag.IncludedProducts as List<Diska.Models.Product>;
    var timeLeft = Model.EndDate - DateTime.Now;

    // Wishlist Logic
    var user = await UserManager.GetUserAsync(User);
    var wishlistIds = user != null
        ? _context.WishlistItems.Where(w => w.UserId == user.Id).Select(w => w.ProductId).ToList()
        : new List<int>();

    string currentTheme = Context.Request.Cookies["theme"] ?? "light";
}

<style>
    /* --- Premium Global Styles --- */
    :root {
        --color-gold: #D4AF37;
        --color-dark: #0f172a;
        --color-dark-soft: #1e293b;
        /* Light Mode Defaults */
        --d-bg-body: #f8fafc;
        --d-card-bg: #ffffff;
        --d-text-main: #0f172a;
        --d-text-muted: #64748b;
        --d-border: #e2e8f0;
        --d-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
        --d-glass-bg: rgba(255, 255, 255, 0.8);
        --d-glass-border: rgba(255, 255, 255, 0.5);
    }

    /* Dark Mode Overrides - Using body.dark-mode for higher specificity */
    [data-bs-theme="dark"], body.dark-mode {
        --d-bg-body: #020617; /* Deep Dark */
        --d-card-bg: #1e293b; /* Slate 800 */
        --d-text-main: #f8fafc; /* Light Text */
        --d-text-muted: #94a3b8; /* Muted Text */
        --d-border: rgba(255, 255, 255, 0.08);
        --d-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.4);
        --color-dark: #f8fafc; /* Repurpose dark color var for headings */
        --d-glass-bg: rgba(30, 41, 59, 0.7); /* Darker glass */
        --d-glass-border: rgba(255, 255, 255, 0.1);
    }

    /* Apply Background to Body */
    body {
        background-color: var(--d-bg-body);
        color: var(--d-text-main);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* --- Deal Hero Section --- */
    .deal-hero {
        background: radial-gradient(circle at top right, #1e293b, #0f172a);
        padding: 80px 0 120px;
        color: #fff;
        text-align: center;
        position: relative;
        overflow: hidden;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

        .deal-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(var(--color-gold) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.05;
            pointer-events: none;
        }

    .deal-tag {
        background: linear-gradient(135deg, var(--color-gold), #FDB931);
        color: #000;
        font-weight: 800;
        padding: 8px 25px;
        border-radius: 50px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 25px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        position: relative;
        z-index: 2;
    }

    .deal-title {
        font-size: 3.5rem;
        font-weight: 900;
        margin-bottom: 20px;
        background: linear-gradient(to right, #fff, #cbd5e1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 10px 30px rgba(0,0,0,0.2);
        position: relative;
        z-index: 2;
    }

    .deal-desc {
        font-size: 1.2rem;
        color: #94a3b8;
        max-width: 700px;
        margin: 0 auto 40px;
        line-height: 1.8;
        font-weight: 300;
        position: relative;
        z-index: 2;
    }

    /* Countdown */
    .countdown-wrapper {
        display: flex;
        justify-content: center;
        gap: 20px;
        position: relative;
        z-index: 2;
    }

    .countdown-unit {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.15);
        padding: 15px 25px;
        border-radius: 16px;
        min-width: 100px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        transition: transform 0.3s ease;
    }

        .countdown-unit:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

    .time-val {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--color-gold);
        line-height: 1;
        display: block;
        font-variant-numeric: tabular-nums;
    }

    .time-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #cbd5e1;
        margin-top: 5px;
    }

    /* --- Products Section --- */
    .deal-products-section {
        background-color: var(--d-bg-body);
        padding: 80px 0;
        position: relative;
        margin-top: -60px; /* Overlap effect */
        border-radius: 40px 40px 0 0;
        z-index: 3;
        box-shadow: 0 -20px 50px rgba(0,0,0,0.05);
        transition: background-color 0.3s ease;
    }

    .section-header {
        text-align: center;
        margin-bottom: 50px;
    }

        .section-header h3 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--d-text-main);
            margin-bottom: 10px;
        }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
    }

    /* Product Card */
    .product-card {
        background: var(--d-card-bg);
        border-radius: 24px;
        border: 1px solid var(--d-border);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-shadow: var(--d-shadow);
    }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
            border-color: var(--color-gold);
        }

    .product-img-wrapper {
        height: 260px;
        padding: 30px;
        background: #fff; /* White background for product images usually looks best */
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--d-border);
    }

    /* Dark Mode Image Wrapper Adjustment (Optional) */
    [data-bs-theme="dark"] .product-img-wrapper,
    body.dark-mode .product-img-wrapper {
        background: var(--d-card-bg); /* Use dark bg if transparent PNGs, or keep white */
        /* opacity: 0.9; optional dimming */
    }
    /* If images have white backgrounds, force white container even in dark mode for consistency */
    [data-bs-theme="dark"] .product-img-wrapper,
    body.dark-mode .product-img-wrapper {
        background: #ffffff;
    }

    .product-img-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.5s ease;
    }

    .product-card:hover .product-img-wrapper img {
        transform: scale(1.1);
    }

    /* Badges */
    .badges-wrapper {
        position: absolute;
        top: 20px;
        @(isAr ? "right" : "left") : 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 10;
    }

    .badge-premium {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        padding: 6px 14px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 800;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 6px;
        color: #000;
    }

    .badge-discount {
        background: #ef4444;
        color: #fff;
    }

    .badge-bestseller {
        background: var(--color-gold);
        color: #fff;
    }

    /* Fav Button */
    .fav-btn {
        position: absolute;
        top: 20px;
        @(isAr ? "left" : "right") : 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fff;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        color: #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }

        .fav-btn:hover {
            transform: scale(1.1);
            color: #ef4444;
        }

        .fav-btn.active {
            color: #ef4444;
            background: #fee2e2;
        }

    /* Details */
    .product-details {
        padding: 25px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: var(--d-card-bg);
        position: relative;
        z-index: 5;
    }

    .category-tag {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--d-text-muted);
        font-weight: 700;
        margin-bottom: 8px;
    }

    .product-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--d-text-main);
        margin: 0 0 12px;
        line-height: 1.4;
        height: 44px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        transition: color 0.2s;
    }

    .product-card:hover .product-title {
        color: var(--color-gold);
    }

    .price-block {
        display: flex;
        align-items: baseline;
        gap: 10px;
        margin-bottom: 20px;
    }

    .current-price {
        font-size: 1.4rem;
        font-weight: 900;
        color: var(--d-text-main);
    }

        .current-price small {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--d-text-muted);
        }

    .old-price {
        font-size: 0.95rem;
        color: var(--d-text-muted);
        text-decoration: line-through;
        font-weight: 600;
    }

    /* Actions */
    .card-actions {
        margin-top: auto;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .qty-control {
        display: flex;
        align-items: center;
        background: var(--d-bg-body);
        border-radius: 12px;
        padding: 5px;
        border: 1px solid var(--d-border);
    }

    .qty-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--d-card-bg);
        border-radius: 8px;
        color: var(--d-text-main);
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

        .qty-btn:hover {
            background: var(--color-gold);
            color: #fff;
        }

    .qty-input {
        width: 40px;
        text-align: center;
        border: none;
        background: transparent;
        font-weight: 700;
        color: var(--d-text-main);
        outline: none;
    }

    .add-to-cart-btn {
        flex: 1;
        background: var(--d-text-main);
        color: var(--d-bg-body);
        border: none;
        border-radius: 12px;
        height: 42px;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    [data-bs-theme="dark"] .add-to-cart-btn, body.dark-mode .add-to-cart-btn {
        background: var(--color-gold);
        color: #000;
    }

    [data-bs-theme="dark"] .qty-control button{
        background: var(--color-gold);
        color:#000;
    }
    .add-to-cart-btn:hover {
        background: var(--color-gold);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
    }

    .add-to-cart-btn:disabled {
        background: var(--d-border);
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        color: var(--d-text-muted);
    }
</style>

<!-- Hero Section -->
<div class="deal-hero">
    <div class="container">
        <span class="deal-tag">
            <i class="fas fa-bolt"></i>
            @(isAr ? "عرض حصري" : "Exclusive Offer")
        </span>

        <h1 class="deal-title">
            @(isAr? Model.Title: Model.TitleEn)
        </h1>

        <p class="deal-desc">
            @if (Model.IsPercentage)
            {
                @(isAr ? $"لا تفوت الفرصة! استمتع بخصم حصري {Model.DiscountValue:0}% على هذه التشكيلة المختارة بعناية." : $"Don't miss out! Enjoy an exclusive {Model.DiscountValue:0}% OFF on this carefully curated collection.")
            }
            else
            {
                @(isAr ? $"عرض مميز! خصم فوري {Model.DiscountValue:N0} جنيه على جميع المنتجات في هذه القائمة." : $"Special Deal! Instant {Model.DiscountValue:N0} EGP OFF on all items in this list.")
            }
        </p>

        <!-- Premium Countdown -->
        @if (Model.EndDate > DateTime.Now)
        {
            <div class="countdown-wrapper" id="countdown">
                <div class="countdown-unit">
                    <span class="time-val" id="days">00</span>
                    <span class="time-label">@(isAr ? "يوم" : "Days")</span>
                </div>
                <div class="countdown-unit">
                    <span class="time-val" id="hours">00</span>
                    <span class="time-label">@(isAr ? "ساعة" : "Hrs")</span>
                </div>
                <div class="countdown-unit">
                    <span class="time-val" id="minutes">00</span>
                    <span class="time-label">@(isAr ? "دقيقة" : "Mins")</span>
                </div>
            </div>
        }
    </div>
</div>

<!-- Products Section -->
<div class="deal-products-section">
    <div class="container">

        <div class="section-header">
            <h3>
                @(isAr ? "تشكيلة العرض" : "Deal Collection")
                <span style="font-size:1.2rem; color:var(--d-text-muted); font-weight:400; margin-inline-start:5px;">(@(products?.Count ?? 0))</span>
            </h3>
        </div>

        @if (products != null && products.Any())
        {
            <div class="products-grid">
                @foreach (var item in products)
                {
                    bool isBestSeller = item.StockQuantity > 0 && item.StockQuantity < 20;
                    bool isLiked = wishlistIds.Contains(item.Id);
                    bool inStock = item.StockQuantity > 0;

                    <div class="product-card" data-id="@item.Id">

                        <!-- Badges -->
                        <div class="badges-wrapper">
                            @if (isBestSeller)
                            {
                                <span class="badge-premium badge-bestseller"><i class="fas fa-crown"></i> @(isAr ? "الأكثر طلباً" : "Best Seller")</span>
                            }
                            <span class="badge-premium badge-discount">
                                @(Model.IsPercentage ? $"{Model.DiscountValue:0}% OFF" : "SALE")
                            </span>
                        </div>

                        <!-- Wishlist -->
                        <button class="fav-btn @(isLiked ? "active" : "")" onclick="toggleWishlist(@item.Id, this)">
                            <i class="fas @(isLiked ? "fa-heart" : "fa-heart")"></i>
                        </button>

                        <!-- Image -->
                        <div class="product-img-wrapper">
                            <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id">
                                <img src="~/@item.ImageUrl" alt="@item.Name" onerror="this.src='/images/default.png'">
                            </a>
                        </div>

                        <!-- Details -->
                        <div class="product-details">
                            <div class="category-tag">@(isAr? item.Category?.Name : item.Category?.NameEn)</div>

                            <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none;">
                                <h4 class="product-title">@(isAr? item.Name: item.NameEn)</h4>
                            </a>

                            <div class="price-block">
                                <div class="current-price">@item.Price.ToString("N0") <small>@(isAr ? "ج.م" : "EGP")</small></div>
                                @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                {
                                    <div class="old-price">@item.OldPrice.Value.ToString("N0")</div>
                                }
                            </div>

                            <div class="card-actions">
                                @if (inStock)
                                {
                                    <div class="qty-control">
                                        <button class="qty-btn" onclick="updateCardQty(this, -1)">-</button>
                                        <input type="number" class="qty-input" id="qty-@item.Id" value="1" min="1" max="@item.StockQuantity" readonly>
                                        <button class="qty-btn" onclick="updateCardQty(this, 1)">+</button>
                                    </div>
                                    <button class="add-to-cart-btn" onclick="addToCartDeal(@item.Id, @Model.Id, this)">
                                        @(isAr ? "أضف للسلة" : "Add to Cart") <i class="fas fa-shopping-bag"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="add-to-cart-btn" disabled style="width:100%; opacity:0.7;">
                                        @(isAr ? "غير متوفر" : "Out of Stock")
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-4x mb-3 text-muted opacity-25"></i>
                <p class="text-muted fs-5">@(isAr ? "انتهت الكميات المخصصة لهذا العرض." : "Items in this deal are out of stock.")</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-outline-dark px-4 mt-2 rounded-pill">@(isAr ? "العودة للمتجر" : "Back to Shop")</a>
            </div>
        }

    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Smooth Countdown Logic
        const endDate = new Date('@Model.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")').getTime();

        function updateTimer() {
            const now = new Date().getTime();
            const distance = endDate - now;

            if (distance < 0) {
                const el = document.getElementById("countdown");
                if(el) el.innerHTML = "<div class='text-white bg-danger px-4 py-2 rounded-pill fw-bold'>EXPIRED</div>";
                return;
            }

            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

            const dEl = document.getElementById("days");
            const hEl = document.getElementById("hours");
            const mEl = document.getElementById("minutes");

            if(dEl) dEl.innerText = d;
            if(hEl) hEl.innerText = h;
            if(mEl) mEl.innerText = m;
        }

        setInterval(updateTimer, 1000);
        updateTimer(); // Initial call

        function updateCardQty(btn, change) {
            let input = btn.parentElement.querySelector('input');
            let val = parseInt(input.value) + change;
            let max = parseInt(input.getAttribute('max'));
            if (val >= 1 && val <= max) input.value = val;
        }

        // Add To Cart with Deal Context
        function addToCartDeal(productId, dealId, btn) {
            let qty = document.getElementById('qty-' + productId).value;
            let originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            let formData = new FormData();
            formData.append('productId', productId);
            formData.append('quantity', qty);
            formData.append('dealId', dealId);

            fetch('/Cart/AddItem', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                        didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
                    });
                    Toast.fire({ icon: 'success', title: res.message });

                    // Update Local Cart (Simplified for brevity)
                    let cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
                    let uniqueId = productId + '_deal_' + dealId;
                    let existing = cart.find(i => i.uniqueId === uniqueId);

                    if(existing) existing.qty += parseInt(qty);
                    else cart.push({
                         id: res.product.id, uniqueId: uniqueId, qty: parseInt(qty),
                         name: res.product.name, price: res.product.price, image: res.product.image,
                         maxStock: res.product.stock, colorName: res.product.colorName, colorHex: res.product.colorHex,
                         isDeal: true, dealId: dealId
                    });

                    localStorage.setItem('DISKA_CART', JSON.stringify(cart));
                    if(typeof updateCartBadge === 'function') updateCartBadge();
                } else {
                    Swal.fire({ icon: 'warning', title: 'Attention', text: res.message, confirmButtonColor: '#0f172a' });
                }
            })
            .catch(e => console.error(e))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
        }

        // Toggle Wishlist with Animation
        async function toggleWishlist(id, btn) {
            try {
                const icon = btn.querySelector('i');
                const isCurrentlyActive = btn.classList.contains('active');

                if(isCurrentlyActive) {
                    btn.classList.remove('active'); icon.classList.remove('fas'); icon.classList.add('far');
                } else {
                    btn.classList.add('active'); icon.classList.remove('far'); icon.classList.add('fas');
                    btn.style.transform = "scale(1.2)";
                    setTimeout(() => btn.style.transform = "scale(1)", 200);
                }

                const response = await fetch('/Wishlist/Toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `productId=${id}`
                });

                if(response.status === 401) { window.location.href = '/Account/Login'; return; }
                const res = await response.json();

                if(!res.success) {
                    if(isCurrentlyActive) {
                         btn.classList.add('active'); icon.classList.remove('far'); icon.classList.add('fas');
                    } else {
                         btn.classList.remove('active'); icon.classList.remove('fas'); icon.classList.add('far');
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
}