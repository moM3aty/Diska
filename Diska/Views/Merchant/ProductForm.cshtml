@model Diska.Models.Product
@{
    ViewData["Title"] = Model.Id == 0 ? "إضافة منتج" : "تعديل المنتج";
    var isAr = System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar");
}

<section class="section-padding">
    <div class="container">
        <div class="merchant-form-box" style="max-width: 900px; margin: 0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color: var(--primary);">@(Model.Id == 0 ? "إضافة منتج جديد" : "تعديل: " + Model.Name)</h2>
                <a asp-action="Index" class="btn btn-outline">إلغاء</a>
            </div>

            <form asp-action="SaveProduct" method="post" enctype="multipart/form-data">
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="MerchantId" />

                <div class="form-row" style="display:grid; grid-template-columns: 1fr 2fr; gap:30px;">
                    <!-- Image Upload -->
                    <div>
                        <div class="upload-box" style="margin-bottom:20px;">
                            <label for="imageFile" class="upload-label">
                                <img src="~/@(string.IsNullOrEmpty(Model.ImageUrl) ? "images/default-product.png" : Model.ImageUrl)" id="previewImg" style="width:100%; max-height:250px; object-fit:contain; margin-bottom:10px;">
                                <div class="btn primary small" style="width:100%;">@(isAr ? "رفع صورة" : "Upload Image")</div>
                            </label>
                            <input type="file" name="imageFile" id="imageFile" accept="image/*" style="display:none;" onchange="previewImage(this)">
                        </div>

                        <!-- Toggle Active Status -->
                        <div style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #eee; text-align:center;">
                            <label style="display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer;">
                                <input asp-for="IsActive" type="checkbox" style="width:20px; height:20px;">
                                <span style="font-weight:bold;">@(isAr ? "المنتج متاح للبيع (نشط)" : "Active for Sale")</span>
                            </label>
                        </div>
                    </div>

                    <!-- Info -->
                    <div>
                        <div class="form-group">
                            <label>اسم المنتج (عربي)</label>
                            <input asp-for="Name" class="form-control" required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label>اسم المنتج (إنجليزي)</label>
                            <input asp-for="NameEn" class="form-control" />
                        </div>

                        <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div class="form-group">
                                <label>القسم</label>
                                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories">
                                    <option value="">-- اختر --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>وحدات الكرتونة</label>
                                <input asp-for="UnitsPerCarton" class="form-control" required />
                            </div>
                        </div>

                        <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div class="form-group">
                                <label>تاريخ الإنتاج</label>
                                <input asp-for="ProductionDate" type="date" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label>تاريخ الانتهاء</label>
                                <input asp-for="ExpiryDate" type="date" class="form-control" required />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:20px;">
                    <div class="form-group">
                        <label>السعر (قطعة)</label>
                        <input asp-for="Price" type="number" step="0.01" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>السعر قبل الخصم</label>
                        <input asp-for="OldPrice" type="number" step="0.01" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>المخزون (قطعة)</label>
                        <input asp-for="StockQuantity" type="number" class="form-control" required />
                    </div>
                </div>

                <hr style="margin: 30px 0; border:0; border-top:1px solid #eee;">

                <h3 style="margin-bottom:15px; font-size:1.2rem; color:var(--primary);">شرائح أسعار الجملة (B2B)</h3>
                <div class="table-responsive">
                    <table class="table" style="width:100%; text-align:center; border:1px solid #eee; margin-bottom:15px;">
                        <thead style="background:#f8f9fa;">
                            <tr>
                                <th>من كمية</th>
                                <th>إلى كمية</th>
                                <th>سعر القطعة (بعد الخصم)</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody id="tiersContainer">
                            @for (int i = 0; i < Model.PriceTiers.Count; i++)
                            {
                                <tr>
                                    <td><input type="number" name="PriceTiers[@i].MinQuantity" value="@Model.PriceTiers[i].MinQuantity" class="form-control small-input"></td>
                                    <td><input type="number" name="PriceTiers[@i].MaxQuantity" value="@Model.PriceTiers[i].MaxQuantity" class="form-control small-input"></td>
                                    <td><input type="number" name="PriceTiers[@i].UnitPrice" value="@Model.PriceTiers[i].UnitPrice" class="form-control small-input"></td>
                                    <td><button type="button" class="btn-delete" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline" onclick="addTierRow()">+ إضافة شريحة سعر</button>

                <hr style="margin: 30px 0; border:0; border-top:1px solid #eee;">

                <div class="form-group">
                    <label>الوصف وتفاصيل المنتج</label>
                    <textarea asp-for="Description" rows="4" class="form-control"></textarea>
                </div>

                <button type="submit" class="btn primary w-100" style="padding:15px; font-size:1.1rem; margin-top:20px;">حفظ ونشر المنتج</button>
            </form>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/merchant.js"></script>
}