@{
    ViewData["Title"] = "الإشعارات";
}

<section class="section-padding" style="padding-top: 50px; min-height: 60vh;">
    <div class="container">
        <div class="notif-header">
            <h2>الإشعارات والتنبيهات 🔔</h2>
            <button class="btn btn-outline-danger" id="clearNotifBtn" style="border: 1px solid #dc3545; color: #dc3545; background: transparent; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-trash-alt"></i> مسح الكل
            </button>
        </div>

        <div class="notifications-list" id="fullNotifList">
            <div style="text-align:center; padding:40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary);"></i>
                <p style="margin-top:10px;">جاري تحميل الإشعارات...</p>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadNotificationsPage();

            document.getElementById('clearNotifBtn').addEventListener('click', async () => {
                if(confirm('هل أنت متأكد من مسح جميع الإشعارات؟')) {
                    await fetch('/Notification/ClearAll', { method: 'POST' });
                    loadNotificationsPage(); // إعادة التحميل
                    // تحديث العداد في الهيدر أيضاً
                    if(typeof updateNotificationBadge === 'function') updateNotificationBadge();
                }
            });
        });

        async function loadNotificationsPage() {
            const container = document.getElementById('fullNotifList');
            try {
                // نستخدم نفس الـ API ولكن يمكن توسيعه لجلب الكل مع Pagination
                // هنا سنستخدم GetRecent كمثال، ويمكنك عمل GetUserNotifications في الكنترولر لجلب الكل
                const response = await fetch('/Notification/GetRecent');
                const data = await response.json();

                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#777; background:#fff; border-radius:10px; border:1px solid #eee;">
                            <i class="fas fa-bell-slash" style="font-size:2rem; margin-bottom:10px; opacity:0.5;"></i>
                            <p>لا توجد إشعارات جديدة</p>
                        </div>`;
                    return;
                }

                data.forEach(n => {
                    const iconClass = n.type === 'Alert' ? 'fa-exclamation-triangle' :
                                      n.type === 'Order' ? 'fa-box' : 'fa-info-circle';
                    const bgClass = n.type === 'Alert' ? '#fef2f2' :
                                    n.type === 'Order' ? '#f0f9ff' : '#fff';
                    const iconColor = n.type === 'Alert' ? '#ef4444' :
                                      n.type === 'Order' ? '#0ea5e9' : '#3b82f6';

                    const html = `
                        <div class="notif-card ${n.isRead ? '' : 'unread'}" style="background:${n.isRead ? '#fff' : '#f8fafc'}; border-left: 4px solid ${n.isRead ? '#eee' : '#FACC15'};">
                            <div class="icon" style="background:${bgClass}; color:${iconColor};">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="content" style="flex:1;">
                                <h4 style="font-weight:${n.isRead ? 'normal' : 'bold'};">${n.title}</h4>
                                <p>${n.message}</p>
                                <span class="time">${n.timeAgo}</span>
                            </div>
                            ${!n.isRead ? `<button onclick="markAsRead(${n.id}, this)" style="font-size:0.8rem; color:#666; background:none; border:none; cursor:pointer;" title="تحديد كمقروء"><i class="fas fa-check-double"></i></button>` : ''}
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = '<p style="text-align:center; color:red;">حدث خطأ في تحميل الإشعارات</p>';
            }
        }

        async function markAsRead(id, btnElement) {
            await fetch(`/Notification/MarkAsRead?id=${id}`, { method: 'POST' });
            // تغيير الستايل فورياً لعدم الحاجة لإعادة التحميل
            const card = btnElement.closest('.notif-card');
            card.style.background = '#fff';
            card.style.borderLeft = '4px solid #eee';
            card.querySelector('h4').style.fontWeight = 'normal';
            btnElement.remove();
            if(typeof updateNotificationBadge === 'function') updateNotificationBadge();
        }
    </script>
}