@model IEnumerable<Diska.Models.Product>
@using System.Globalization
@using Diska.Data
@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext _context
@inject UserManager<Diska.Models.ApplicationUser> UserManager

@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "الرئيسية" : "Home";

    var categories = ViewBag.Categories as IEnumerable<Diska.Models.Category>;
    var banners = ViewBag.Banners as IEnumerable<Diska.Models.Banner>;

    // ألوان خلفيات وأيقونات للأقسام (للتصميم)
    string[] catColors = { "#e0f2fe", "#fef3c7", "#dcfce7", "#fee2e2", "#f3e8ff", "#ffedd5" };
    string[] iconColors = { "#0284c7", "#d97706", "#16a34a", "#dc2626", "#9333ea", "#ea580c" };
    int discount = 0;
    // جلب قائمة المفضلة للمستخدم الحالي لتلوين القلب
    var user = await UserManager.GetUserAsync(User);
    var wishlistIds = user != null
        ? _context.WishlistItems.Where(w => w.UserId == user.Id).Select(w => w.ProductId).ToList()
        : new List<int>();
}

<style>
    /* --- Banner Slider Styles --- */
    .hero-section {
        position: relative;
        margin-bottom: 50px;
        overflow: hidden; /* لمنع ظهور السكرول أثناء الحركة */
    }

    .banner-slide {
        display: none;
        animation: fadeEffect 1s;
    }

        .banner-slide.active {
            display: block;
        }

    @@keyframes fadeEffect {
        from {
            opacity: 0.4;
        }

        to {
            opacity: 1;
        }
    }

    html[dir="ltr"] .banner-content {
        text-align: left;
    }

    .tag-box {
        margin-bottom: 15px;
    }

    .tag {
        background: #ef4444;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        color: #fff;
    }

    .main-headline {
        font-size: 2.5rem;
        font-weight: 800;
        color: #fff;
        margin-bottom: 15px;
        line-height: 1.3;
    }

    .slogan-desc {
        font-size: 1.1rem;
        color: #cbd5e1;
        margin-bottom: 25px;
        max-width: 500px;
    }

    /* Slider Dots */
    .slider-dots {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 5;
    }

    .dot {
        height: 10px;
        width: 10px;
        background-color: rgba(255,255,255,0.3);
        border-radius: 50%;
        cursor: pointer;
        transition: 0.3s;
        margin-top: -30px;
    }

        .dot.active {
            background-color: #FACC15;
            transform: scale(1.2);
        }

    /* Mobile Responsive Fixes */
    @@media (max-width: 900px) {
        .banner-card {
            flex-direction: column-reverse;
            text-align: center;
            padding: 30px 20px;
        }

        .banner-content {
            text-align: center;
        }

        .banner-image img {
            width: 80%;
            transform: rotate(0);
            margin-bottom: 20px;
        }

        .main-headline {
            font-size: 1.8rem;
        }
    }
</style>

<!-- 1. Hero Section (Slider) -->
<section class="hero-section container" dir="@(isAr ? "rtl" : "ltr")">
    @if (banners != null && banners.Any())
    {
        int slideIndex = 0;
        foreach (var banner in banners)
        {
            // منطق توليد الرابط الصحيح بناءً على نوع البنر
            string href = "#";
            if (banner.LinkType == "External") { href = banner.LinkId; }
            else if (banner.LinkType == "Product") { href = Url.Action("Details", "Product", new { id = banner.LinkId }); }
            else if (banner.LinkType == "Category") { href = Url.Action("Category", "Product", new { id = banner.LinkId }); }
            else if (banner.LinkType == "Deal") { href = Url.Action("Deals", "Home"); }

            // استخدام صورة الديسك توب كصورة أساسية (مع إصلاح اسم الخاصية)
            string imgSrc = !string.IsNullOrEmpty(banner.ImageDesktop) ? banner.ImageDesktop : "images/banner-img.png";

            <div class="banner-slide @(slideIndex == 0 ? "active" : "")" id="slide-@slideIndex">
                <div class="banner-card">
                    <div class="banner-content">
                        <div class="tag-box">
                            <span class="tag">@(isAr ? "عروض حصرية 🔥" : "Hot Deals 🔥")</span>
                        </div>
                        <h2 class="main-headline">@(isAr? banner.Title: banner.TitleEn)</h2>
                        <p class="slogan-desc">@(isAr? banner.Subtitle: banner.SubtitleEn)</p>
                        <a href="@href" class="btn primary">@(isAr? banner.ButtonText: banner.ButtonTextEn)</a>
                    </div>
                    <div class="banner-image">
                        <img src="~/@imgSrc" alt="@banner.Title" onerror="this.src='/images/banner-img.png'">
                    </div>
                </div>
            </div>
            slideIndex++;
        }

        <!-- Dots Navigation -->
        <div class="slider-dots">
            @for (int i = 0; i < banners.Count(); i++)
            {
                <span class="dot @(i == 0 ? "active" : "")" onclick="currentSlide(@i)"></span>
            }
        </div>
    }
    else
    {
        <!-- Fallback Banner (If no banners exist) -->
        <div class="banner-card">
            <div class="banner-content">
                <span class="tag">HOT</span>
                <h2>@(isAr ? "عروض حصرية للجملة" : "Exclusive Wholesale Deals")</h2>
                <p>@(isAr ? "تسوق الآن واحصل على أفضل الأسعار" : "Shop now for the best prices")</p>
                <a href="#products" class="btn primary">@(isAr ? "تسوق الآن" : "Shop Now")</a>
            </div>
            <div class="banner-image">
                <img src="~/images/banner-img.png" alt="Offers" onerror="this.style.display='none'">
            </div>
        </div>
    }
</section>

<!-- 2. Categories Section -->
@if (categories != null && categories.Any())
{
    <section class="categories-section">
        <div class="container">
            <div class="section-header">
                <h3>@(isAr ? "تسوق حسب القسم" : "Shop by Category")</h3>
            </div>
            <div class="categories-grid">
                @{
                    int i = 0;
                }
                @foreach (var cat in categories)
                {
                    <a asp-controller="Product" asp-action="Index" asp-route-id="@cat.Id" class="cat-item">
                        <div class="icon" style="background-color: @catColors[i % 6]; color: @iconColors[i % 6]; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <i class="@(cat.IconClass ?? "fas fa-box")"></i>
                        </div>
                        <span>@(isAr? cat.Name: cat.NameEn)</span>
                    </a>
                    i++;
                }
                <a asp-controller="Home" asp-action="Deals" class="cat-item">
                    <div class="icon" style="background-color: #ffedd5; color: #ea580c;">
                        <i class="fas fa-fire"></i>
                    </div>
                    <span>@(isAr ? "عروض خاصة" : "Special Offers")</span>
                </a>
            </div>
        </div>
    </section>
}

<!-- 3. Featured Products -->
<section id="products" class="products-section bg-light">
    <div class="container">
        <div class="section-header">
            <h3>@(isAr ? "أحدث المنتجات" : "New Arrivals")</h3>
            <a asp-area="" asp-controller="Product" asp-action="index" class="view-all">@(isAr ? "عرض الكل" : "View All") <i class="fas @(isAr ? "fa-arrow-left" : "fa-arrow-right")"></i></a>
        </div>

        <div class="products-grid">
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    bool isBestSeller = item.StockQuantity > 0 && item.StockQuantity < 20;
                    bool isLiked = wishlistIds.Contains(item.Id);

                    <div class="product-card" data-id="@item.Id" data-stock="@item.StockQuantity">

                        <!-- Badges & Wishlist -->
                        <div class="badge-container" style="position:absolute; top:15px; @(isAr ? "right" : "left"):15px; z-index:2; display:flex; flex-direction:column; gap:5px;">
                            @if (isBestSeller)
                            {
                                <span class="badge-bestseller" style="background:linear-gradient(135deg, #FFD700, #FDB931); color:#fff; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:800; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                    <i class="fas fa-crown"></i> @(isAr ? "الأكثر مبيعاً" : "Best Seller")
                                </span>
                            }
                            
                            @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                            {
                                
                                if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                {
                                    discount = (int)Math.Round(((item.OldPrice.Value - item.Price) / item.OldPrice.Value) * 100);
                                }
                                <span class="badge-discount" style="text-align:center;background:#ef4444; color:#fff; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:800;">
                                    @(isAr ? "خصم" : "Sale") %@discount
                                </span>
                            }
                        </div>

                        <!-- زر المفضلة (تم وضعه يدوياً ليتوافق مع الستايل) -->
                        <button class="fav-btn @(isLiked ? "active" : "")" onclick="toggleWishlist(@item.Id, this)"
                                style="position:absolute; top:15px; @(isAr ? "left" : "right"):15px; width:35px; height:35px; background:rgba(255,255,255,0.9); border-radius:50%; border:1px solid #e2e8f0; color:@(isLiked ? "#ef4444" : "#94a3b8"); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:3; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
                            <i class="@(isLiked ? "fas" : "far") fa-heart"></i>
                        </button>

                        <!-- Product Image -->
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" class="product-img">
                            <img src="~/@item.ImageUrl" alt="@item.Name" onerror="this.src='/images/default.png'">
                        </a>

                        <!-- Product Info -->
                        <div class="product-info">
                            <span class="pro-cat" style="font-size:0.75rem; color:#64748b;">@(isAr? item.Category?.Name : item.Category?.NameEn)</span>

                            <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none; color:inherit;">
                                <h4>@(isAr? item.Name: item.NameEn)</h4>
                            </a>

                            <div class="pricing">
                                <span class="current-price">@item.Price.ToString("N0") <small>@(isAr ? "ج.م" : "EGP")</small></span>
                                @if (item.OldPrice.HasValue)
                                {
                                    <span class="old-price">@item.OldPrice.Value.ToString("N0")</span>
                                }
                            </div>

                            <!-- Meta -->
                            <div class="product-meta">
                                <span class="unit"><i class="fas fa-box"></i> @item.UnitsPerCarton</span>
                                @if (item.StockQuantity > 0)
                                {
                                    <span class="stock-info">@(isAr ? "متوفر" : "In Stock")</span>
                                }
                                else
                                {
                                    <span class="stock-info low">@(isAr ? "نافذ" : "Out of Stock")</span>
                                }
                            </div>

                            <!-- Actions -->
                            <div class="add-to-cart">
                                <button onclick="updateCardQty(this, -1)">-</button>
                                <input type="number" id="qty-@item.Id" value="1" min="1" max="@item.StockQuantity" readonly>
                                <button onclick="updateCardQty(this, 1)">+</button>
                                <button class="add-btn" onclick="addToCart(this, @item.Id)">
                                    @(isAr ? "أضف" : "Add") <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">
                    <p>@(isAr ? "لا توجد منتجات متاحة حالياً." : "No products available.")</p>
                </div>
            }
        </div>
    </div>
</section>
    
@section Scripts {
    <script>
        // دوال التحكم في السلايدر
        let slideIndex = 0;
        let slideTimer;

        function showSlides() {
            const slides = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.dot');
            if(slides.length === 0) return;

            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            slideIndex++;
            if (slideIndex > slides.length) {slideIndex = 1}

            slides[slideIndex-1].classList.add('active');
            if(dots.length > 0) dots[slideIndex-1].classList.add('active');

            clearTimeout(slideTimer);
            slideTimer = setTimeout(showSlides, 5000);
        }

        window.currentSlide = function(n) {
            slideIndex = n;
            const slides = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.dot');
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            slides[n].classList.add('active');
            dots[n].classList.add('active');
            clearTimeout(slideTimer);
            slideTimer = setTimeout(showSlides, 5000);
        }

        // تشغيل السلايدر عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            if(document.querySelectorAll('.banner-slide').length > 0) showSlides();
        });

        // دوال الكمية والإضافة
        function updateCardQty(btn, change) {
            let input = btn.parentElement.querySelector('input');
            let val = parseInt(input.value) + change;
            let max = parseInt(input.getAttribute('max'));
            if (val >= 1 && val <= max) input.value = val;
        }

        function addToCart(btn, id) {
            let qtyInput = document.getElementById('qty-' + id);
            let qty = qtyInput ? qtyInput.value : 1;
            if(typeof addItemToCart === 'function') {
                addItemToCart(id, qty, btn);
            }
        }

        async function toggleWishlist(id, btn) {
            try {
                const icon = btn.querySelector('i');
                const response = await fetch('/Wishlist/Toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${id}`
                });

                if (response.status === 401) {
                    // SweetAlert is loaded in Layout
                    Swal.fire({
                        title: '@(isAr ? "تنبيه" : "Alert")',
                        text: '@(isAr ? "يجب عليك تسجيل الدخول أولاً." : "Please login first.")',
                        icon: 'warning',
                        confirmButtonText: '@(isAr ? "دخول" : "Login")'
                    }).then((r) => { if(r.isConfirmed) window.location.href='/Account/Login'; });
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    if (result.status === 'added') {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        btn.classList.add('active');
                        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '@(isAr ? "تمت الإضافة للمفضلة" : "Added to Wishlist")', showConfirmButton: false, timer: 1500 });
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        btn.classList.remove('active');
                        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: '@(isAr ? "تم الحذف من المفضلة" : "Removed from Wishlist")', showConfirmButton: false, timer: 1500 });
                    }
                }
            } catch (error) { console.error(error); }
        }
    </script>
}