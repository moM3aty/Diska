@model IEnumerable<Diska.Models.Product>
@using System.Globalization
@using Diska.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore 
@inject ApplicationDbContext _context
@inject UserManager<Diska.Models.ApplicationUser> UserManager

@{
    Layout = "_Layout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "الرئيسية" : "Home";

    // 1. معالجة الأقسام (جلب مباشر إذا لم تتوفر في ViewBag)
    var categories = ViewBag.Categories as IEnumerable<Diska.Models.Category>;
    if (categories == null || !categories.Any())
    {
        // جلب الأقسام الرئيسية النشطة
        categories = _context.Categories
            .Where(c => c.ParentId == null && c.IsActive)
            .OrderBy(c => c.DisplayOrder)
            .ToList();
    }

    // 2. معالجة البنرات (إصلاح الاستعلام المسبب للخطأ)
    var banners = ViewBag.Banners as IEnumerable<Diska.Models.Banner>;
    if (banners == null || !banners.Any())
    {
        // تصحيح: استخدمنا ApprovalStatus بدلاً من Status لأن الأخير غير موجود في قاعدة البيانات كحقل
        // تم إزالة شرط التاريخ مؤقتاً لضمان الظهور، يمكنك إعادته لاحقاً
        banners = _context.Banners
            .Where(b => b.IsActive && (b.ApprovalStatus == "Approved" || b.ApprovalStatus == "Pending"))
            .OrderBy(b => b.Priority)
            .ToList();
    }

    // Wishlist Logic
    var user = await UserManager.GetUserAsync(User);
    var wishlistIds = user != null
        ? _context.WishlistItems.Where(w => w.UserId == user.Id).Select(w => w.ProductId).ToList()
        : new List<int>();
}

<style>
    /* =========================================
       PREMIUM HOME STYLES (Light & Dark)
       ========================================= */
    :root {
        /* Base Colors */
        --home-bg: #f8fafc;
        --home-card-bg: #ffffff;
        --home-text-main: #0f172a;
        --home-text-muted: #64748b;
        --home-border: #e2e8f0;
        --home-primary: #0F172A;
        --home-accent: #FACC15;
        --home-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        --home-card-hover-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        --home-input-bg: #f8fafc;
        
        /* Category Colors */
        --cat-bg-0: #e0f2fe; --cat-icon-0: #0284c7;
        --cat-bg-1: #fef3c7; --cat-icon-1: #d97706;
        --cat-bg-2: #dcfce7; --cat-icon-2: #16a34a;
        --cat-bg-3: #fee2e2; --cat-icon-3: #dc2626;
        --cat-bg-4: #f3e8ff; --cat-icon-4: #9333ea;
        --cat-bg-5: #ffedd5; --cat-icon-5: #ea580c;
        --cat-special-bg: #fff7ed; --cat-special-icon: #ea580c;
    }

    [data-bs-theme="dark"] {
        /* Dark Theme Overrides */
        --home-bg: #020617;
        --home-card-bg: #1e293b;
        --home-text-main: #f8fafc;
        --home-text-muted: #94a3b8;
        --home-border: rgba(255, 255, 255, 0.08);
        --home-primary: #f8fafc;
        --home-accent: #FACC15;
        --home-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.4);
        --home-card-hover-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.6);
        --home-input-bg: #0f172a;
        
        --cat-bg-0: rgba(14, 165, 233, 0.15); --cat-icon-0: #38bdf8;
        --cat-bg-1: rgba(245, 158, 11, 0.15); --cat-icon-1: #fbbf24;
        --cat-bg-2: rgba(34, 197, 94, 0.15); --cat-icon-2: #4ade80;
        --cat-bg-3: rgba(239, 68, 68, 0.15); --cat-icon-3: #f87171;
        --cat-bg-4: rgba(168, 85, 247, 0.15); --cat-icon-4: #c084fc;
        --cat-bg-5: rgba(234, 88, 12, 0.15); --cat-icon-5: #fb923c;
        --cat-special-bg: rgba(251, 146, 60, 0.15); --cat-special-icon: #fb923c;
    }

    body { background-color: var(--home-bg); transition: background-color 0.3s ease; }

    /* --- Banner Slider Styles --- */
    .hero-section { position: relative; margin-bottom: 60px; overflow: hidden; padding-top: 20px; min-height: 400px; }
    .banner-slide { display: none; animation: fadeEffect 1s; width: 100%; }
    .banner-slide.active { display: block; }
    @@keyframes fadeEffect { from { opacity: 0; } to { opacity: 1; } }

    .banner-card {
        background: linear-gradient(135deg, #0F172A 0%, #1e293b 100%);
        border-radius: 24px; padding: 50px 60px; color: #fff;
        display: flex; justify-content: space-between; align-items: center;
        position: relative; overflow: hidden; box-shadow: var(--home-shadow);
        border: 1px solid rgba(255,255,255,0.1);
        min-height: 350px;
    }
    [data-bs-theme="dark"] .banner-card { background: linear-gradient(135deg, #020617 0%, #1e293b 100%); }
    .banner-card::after {
        content: ''; position: absolute; top: -50%; right: -10%; width: 500px; height: 500px;
        background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }

    .banner-content { z-index: 2; flex: 1; text-align: right; }
    html[dir="ltr"] .banner-content { text-align: left; }
    .tag-box { margin-bottom: 15px; }
    .tag {
        background: rgba(239, 68, 68, 0.2); padding: 6px 16px; border-radius: 50px;
        font-size: 0.8rem; font-weight: 800; color: #fff; border: 1px solid rgba(239, 68, 68, 0.4);
        text-transform: uppercase; letter-spacing: 1px;
    }
    .main-headline { font-size: 2.8rem; font-weight: 900; color: #fff; margin-bottom: 15px; line-height: 1.2; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .slogan-desc { font-size: 1.1rem; color: #cbd5e1; margin-bottom: 30px; max-width: 500px; line-height: 1.6; }

    .banner-image { flex: 1; display: flex; justify-content: center; z-index: 2; position: relative; }
    .banner-image img { max-width: 500px; object-fit: contain; transform: rotate(-5deg) scale(1); transition: transform 0.5s ease; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.4)); }
    .banner-card:hover .banner-image img { transform: rotate(0) scale(1.05); }

    .slider-dots { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 5; }
    .dot { height: 6px; width: 6px; background-color: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; transition: 0.3s; }
    .dot.active { background-color: var(--home-accent); width: 25px; }

    /* --- Categories --- */
    .categories-section { padding: 30px 0; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .section-header h3 { font-size: 1.8rem; font-weight: 800; color: var(--home-text-main); margin: 0; }
    .view-all { color: var(--home-primary); font-weight: 700; text-decoration: none; transition: 0.2s; font-size: 0.95rem; }
    .view-all:hover { color: var(--home-accent); transform: translateX(isAr ? -5px : 5px); }

    .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 20px; text-align: center; }
    .cat-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; transition: 0.3s; padding:10px; border-radius:25px; }
    .cat-item:hover { transform: translateY(-5px); }
    .cat-item .icon { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; transition: 0.3s; }
    .cat-item span { font-weight: 700; font-size: 0.9rem; color: var(--home-text-main); }

    /* --- Products --- */
    .products-section { padding: 50px 0; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; }

    .product-card {
        background: var(--home-card-bg); border: 1px solid var(--home-border);
        border-radius: 20px; padding: 15px; position: relative;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; flex-direction: column; height: 100%;
    }
    .product-card:hover { box-shadow: var(--home-card-hover-shadow); border-color: var(--home-accent); transform: translateY(-8px); }

    .badge-container { position: absolute; top: 15px; @(isAr ? "right" : "left") : 15px; z-index: 2; display: flex; flex-direction: column; gap: 6px; }
    .badge-bestseller, .badge-discount { font-size: 0.7rem; font-weight: 800; padding: 4px 10px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; color: #fff; }
    .badge-bestseller { background: linear-gradient(135deg, #FFD700, #FDB931); }
    .badge-discount { background: #ef4444; }

    .fav-btn {
        position: absolute; top: 15px; @(isAr ? "left" : "right") : 15px;
        width: 40px; height: 40px; background: var(--home-card-bg);
        border: 1px solid var(--home-border); border-radius: 50%; color: #94a3b8;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        z-index: 3; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .fav-btn:hover { transform: scale(1.1); color: #ef4444; }
    .fav-btn.active { color: #ef4444; border-color: #ef4444; background: #fff0f0; }
    [data-bs-theme="dark"] .fav-btn.active { background: rgba(239, 68, 68, 0.1); }

    .product-img {
        height: 200px; display: flex; align-items: center; justify-content: center;
        margin-bottom: 15px; background: #fff; border-radius: 12px; padding: 20px;
        position: relative; overflow: hidden;
    }
    [data-bs-theme="dark"] .product-img { background: transparent; }
    .product-img img { max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.5s ease; }
    .product-card:hover .product-img img { transform: scale(1.08); }

    .product-info { flex: 1; display: flex; flex-direction: column; }
    .pro-cat { font-size: 0.75rem; color: var(--home-text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; font-weight: 700; }
    .product-info h4 { font-size: 1rem; font-weight: 700; margin-bottom: 8px; color: var(--home-text-main); height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; transition: color 0.2s; }
    .product-card:hover h4 { color: #4f46e5; }
    [data-bs-theme="dark"] .product-card:hover h4 { color: #818cf8; }

    .pricing { display: flex; align-items: baseline; gap: 8px; margin-bottom: 15px; }
    .current-price { font-weight: 900; color: var(--home-text-main); font-size: 1.2rem; }
    .current-price small { font-size: 0.75rem; color: var(--home-text-muted); font-weight: 600; }
    .old-price { text-decoration: line-through; color: var(--home-text-muted); font-size: 0.9rem; font-weight: 600; }

    .product-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--home-text-muted); margin-bottom: 15px; background: rgba(0,0,0,0.02); padding: 6px 10px; border-radius: 8px; }
    [data-bs-theme="dark"] .product-meta { background: rgba(255,255,255,0.03); }
    .stock-info { font-weight: 700; color: #16a34a; }
    .stock-info.low { color: #ef4444; }

    /* Quantity & Add to Cart */
    .add-to-cart { margin-top: auto; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    
    .qty-input-group { 
        display: flex; align-items: center; border: 1px solid var(--home-border); 
        border-radius: 50px; overflow: hidden; background: var(--home-input-bg); 
        height: 40px; /* Same height as add button */
    }
    
    .qty-btn { 
        background: transparent; border: none; width: 30px; height: 100%; 
        font-weight: bold; color: var(--home-text-main); cursor: pointer; transition: 0.2s; 
    }
    .qty-btn:hover { background: rgba(0,0,0,0.05); color: var(--home-primary); }
    [data-bs-theme="dark"] .qty-btn:hover { background: rgba(255,255,255,0.1); }
    
    .qty-val { 
        width: 40px; text-align: center; border: none; background: transparent; 
        font-weight: 700; color: var(--home-text-main); outline: none; 
        -moz-appearance: textfield; font-size: 0.9rem; height: 100%;
        cursor: text;
    }
    .qty-val:focus { background: var(--home-card-bg); }
    .qty-val::-webkit-outer-spin-button, .qty-val::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .add-btn { 
        background: var(--home-primary); color: #fff; border: none; border-radius: 50px; 
        padding: 0 20px; height: 40px; font-weight: 700; font-size: 0.9rem; flex-grow: 1; 
        transition: 0.3s; display: flex; align-items: center; justify-content: center; 
        gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    }
    [data-bs-theme="dark"] .add-btn { background: #FACC15; color: #0F172A; }
    .add-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .add-btn.bg-secondary { background: var(--home-border) !important; color: var(--home-text-muted) !important; cursor: not-allowed; box-shadow: none; transform: none; }

    .btn.primary { background: var(--home-accent); color: #000; padding: 12px 30px; border-radius: 50px; font-weight: 800; display: inline-block; text-decoration: none; transition: 0.3s; box-shadow: 0 5px 15px rgba(250, 204, 21, 0.4); }
    .btn.primary:hover { transform: translateY(-3px); background: #fff; color: #000; }

    @@media (max-width: 900px) {
        .banner-card { flex-direction: column-reverse; text-align: center; padding: 40px 20px; }
        .banner-content { text-align: center; }
        .banner-image img { margin-bottom: 20px; width: 100%; transform: rotate(0); }
        .main-headline { font-size: 2rem; }
    }
</style>

<!-- 1. Hero Section (Slider) -->
<section class="hero-section container" dir="@(isAr ? "rtl" : "ltr")">
    @if (banners != null && banners.Any())
    {
        int slideIndexLocal = 0;
        foreach (var banner in banners)
        {
            string href = "#";
            if (banner.LinkType == "External") { href = banner.LinkId; }
            else if (banner.LinkType == "Product") { href = Url.Action("Details", "Product", new { id = banner.LinkId }); }
            else if (banner.LinkType == "Category") { href = Url.Action("Index", "Product", new { categoryId = banner.LinkId }); }
            else if (banner.LinkType == "Deal") { href = Url.Action("Index", "Deal"); }

            string imgSrc = !string.IsNullOrEmpty(banner.ImageDesktop) ? banner.ImageDesktop : "images/banner-img.png";

            <div class="banner-slide @(slideIndexLocal == 0 ? "active" : "")" id="slide-@slideIndexLocal">
                <div class="banner-card">
                    <div class="banner-content">
                        <div class="tag-box"><span class="tag">@(isAr ? "عروض حصرية 🔥" : "Hot Deals 🔥")</span></div>
                        <h2 class="main-headline">@(isAr? banner.Title: banner.TitleEn)</h2>
                        <p class="slogan-desc">@(isAr? banner.Subtitle: banner.SubtitleEn)</p>
                        <a href="@href" class="btn primary">@(isAr? banner.ButtonText: banner.ButtonTextEn)</a>
                    </div>
                    <div class="banner-image">
                        <img src="~/@imgSrc" alt="@banner.Title" onerror="this.src='/images/logo2.png'">
                    </div>
                </div>
            </div>
            slideIndexLocal++;
        }
        <div class="slider-dots">
            @for (int i = 0; i < banners.Count(); i++)
            {
                <span class="dot @(i == 0 ? "active" : "")" onclick="currentSlide(@i)"></span>
            }
        </div>
    }
    else
    {
        <div class="banner-card">
            <div class="banner-content">
                <span class="tag">HOT</span>
                <h2 class="main-headline">@(isAr ? "عروض حصرية للجملة" : "Exclusive Wholesale Deals")</h2>
                <p class="slogan-desc">@(isAr ? "تسوق الآن واحصل على أفضل الأسعار" : "Shop now for the best prices")</p>
                <a href="#products" class="btn primary">@(isAr ? "تسوق الآن" : "Shop Now")</a>
            </div>
            <div class="banner-image">
                <img src="~/images/banner-img.png" alt="Offers" onerror="this.style.display='none'">
            </div>
        </div>
    }
</section>

<!-- 2. Categories Section -->
@if (categories != null && categories.Any())
{
    <section class="categories-section">
        <div class="container">
            <div class="section-header">
                <h3>@(isAr ? "تسوق حسب القسم" : "Shop by Category")</h3>
            </div>
            <div class="categories-grid">
                @{ int i = 0; }
                @foreach (var cat in categories)
                {
                    <a asp-controller="Product" asp-action="Index" asp-route-categoryId="@cat.Id" class="cat-item">
                        <div class="icon" style="background-color: var(--cat-bg-@(i % 6)); color: var(--cat-icon-@(i % 6)); box-shadow: var(--home-shadow);">
                            <i class="@(cat.IconClass ?? "fas fa-box")"></i>
                        </div>
                        <span>@(isAr? cat.Name: cat.NameEn)</span>
                    </a>
                    i++;
                }
                <a asp-controller="Deal" asp-action="Index" class="cat-item">
                    <div class="icon" style="background-color: var(--cat-special-bg); color: var(--cat-special-icon); box-shadow: var(--home-shadow);">
                        <i class="fas fa-fire"></i>
                    </div>
                    <span>@(isAr ? "عروض خاصة" : "Special Offers")</span>
                </a>
            </div>
        </div>
    </section>
}

<!-- 3. Featured Products -->
<section id="products" class="products-section">
    <div class="container">
        <div class="section-header">
            <h3>@(isAr ? "أحدث المنتجات" : "New Arrivals")</h3>
            <a asp-area="" asp-controller="Product" asp-action="index" class="view-all">@(isAr ? "عرض الكل" : "View All") <i class="fas @(isAr ? "fa-arrow-left" : "fa-arrow-right")"></i></a>
        </div>

        <div class="products-grid">
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    bool isBestSeller = item.StockQuantity > 0 && item.StockQuantity < 20;
                    bool isLiked = wishlistIds.Contains(item.Id);
                    int discountProd = 0;

                    <div class="product-card" data-id="@item.Id" data-stock="@item.StockQuantity">
                        <div class="badge-container">
                            @if (isBestSeller) { <span class="badge-bestseller"><i class="fas fa-crown"></i> @(isAr ? "الأكثر مبيعاً" : "Best Seller")</span> }
                            @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                            {
                                discountProd = (int)Math.Round(((item.OldPrice.Value - item.Price) / item.OldPrice.Value) * 100);
                                <span class="badge-discount">@(isAr ? "خصم" : "Sale") @discountProd%</span>
                            }
                        </div>

                        <button class="fav-btn @(isLiked ? "active" : "")" onclick="toggleWishlist(@item.Id, this)">
                            <i class="fas @(isLiked ? "fa-heart" : "fa-heart")"></i>
                        </button>

                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" class="product-img">
                            <img src="~/@item.ImageUrl" alt="@item.Name" onerror="this.src='/images/default.png'">
                        </a>

                        <div class="product-info">
                            <span class="pro-cat">@(isAr? item.Category?.Name : item.Category?.NameEn)</span>
                            <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" style="text-decoration:none; color:inherit;">
                                <h4>@(isAr? item.Name: item.NameEn)</h4>
                            </a>
                            <div class="pricing">
                                <span class="current-price">@item.Price.ToString("N0") <small>@(isAr ? "ج.م" : "EGP")</small></span>
                                @if (item.OldPrice.HasValue && item.OldPrice > item.Price)
                                {
                                    <span class="old-price">@item.OldPrice.Value.ToString("N0")</span>
                                }
                            </div>
                            <div class="product-meta">
                                <span class="unit"><i class="fas fa-box"></i> @item.UnitsPerCarton</span>
                                <span class="stock-info @(item.StockQuantity <= 0 ? "low" : "")">
                                    @(item.StockQuantity > 0 ? (isAr ? "متوفر" : "In Stock") : (isAr ? "نافذ" : "Out of Stock"))
                                </span>
                            </div>

                            <div class="add-to-cart">
                                @if (item.StockQuantity > 0)
                                {
                                    <div class="qty-input-group">
                                        <button type="button" class="qty-btn" onclick="updateCardQty(this, -1)">-</button>
                                        <input type="number" id="qty-@item.Id" value="1" min="1" max="@item.StockQuantity" class="qty-val" onchange="validateQty(this)" onkeyup="if(event.key === 'Enter') validateQty(this)">
                                        <button type="button" class="qty-btn" onclick="updateCardQty(this, 1)">+</button>
                                    </div>

                                    <button class="add-btn" onclick="addToCart(@item.Id, this)">
                                        @(isAr ? "أضف" : "Add") <i class="fas fa-cart-plus"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="add-btn bg-secondary" disabled>@(isAr ? "غير متوفر" : "Out")</button>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--home-text-muted);">
                    <p>@(isAr ? "لا توجد منتجات متاحة حالياً." : "No products available.")</p>
                </div>
            }
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_SurveyPopup" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Banner Logic
        let slideIndex = 0;
        let slideTimer;
        
        function showSlides(n) {
            const slides = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.dot');
            if(slides.length === 0) return;

            if (n !== undefined) {
                slideIndex = n;
            } else {
                slideIndex++;
            }

            if (slideIndex >= slides.length) { slideIndex = 0; }
            if (slideIndex < 0) { slideIndex = slides.length - 1; }

            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            slides[slideIndex].classList.add('active');
            if(dots.length > 0) dots[slideIndex].classList.add('active');

            clearTimeout(slideTimer);
            slideTimer = setTimeout(() => showSlides(), 5000);
        }

        window.currentSlide = function(n) {
            showSlides(n);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(document.querySelectorAll('.banner-slide').length > 0) {
                slideIndex = -1; 
                showSlides();
            }
        });

        // Qty Logic
        function updateCardQty(btn, change) {
            let input = btn.parentElement.querySelector('input');
            let currentVal = parseInt(input.value) || 0;
            let newVal = currentVal + change;
            input.value = newVal; 
            validateQty(input);
        }

        function validateQty(input) {
            let val = parseInt(input.value);
            let max = parseInt(input.getAttribute('max'));
            
            if (isNaN(val) || val < 1) {
                input.value = 1;
            } else if (val > max) {
                input.value = max;
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'warning', 
                    title: '@(isAr?"عفواً، الكمية المتاحة محدودة":"Limited Stock")', 
                    showConfirmButton: false, timer: 1500
                });
            }
        }

        function addToCart(id, btn) {
            let qtyInput = document.getElementById('qty-' + id);
            validateQty(qtyInput); 
            let qty = qtyInput.value;
            let original = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            let formData = new FormData();
            formData.append('productId', id);
            formData.append('quantity', qty);

            fetch('/Cart/AddItem', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(res => {
                btn.disabled = false;
                btn.innerHTML = original;

                if(res.success) {
                    let cart = JSON.parse(localStorage.getItem('DISKA_CART')) || [];
                    
                    if (cart.length > 0 && cart[0].merchantId && res.product.merchantId && cart[0].merchantId !== res.product.merchantId) {
                        Swal.fire({
                            title: '@(isAr ? "تاجر مختلف" : "Different Merchant")',
                            text: '@Html.Raw(isAr ? "سلتك تحتوي على منتجات من تاجر آخر. هل تريد إفراغ السلة وإضافة هذا المنتج؟" : "Cart has items from another merchant. Clear and add this item?")',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            confirmButtonText: '@(isAr ? "نعم، أفرغ السلة وأضف" : "Yes, clear and add")',
                            cancelButtonText: '@(isAr ? "إلغاء" : "Cancel")'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                cart = []; 
                                addItemToLocal(cart, res, qty, id);
                            }
                        });
                        return; 
                    }
                    addItemToLocal(cart, res, qty, id);
                } else {
                    Swal.fire({ icon: 'warning', title: 'Note', text: res.message });
                }
            })
            .catch(e => {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = original;
            });
        }

        function addItemToLocal(cart, res, qty, id) {
            let uniqueId = id + '_def'; 
            let existing = cart.find(i => i.uniqueId === uniqueId);
            
            if(existing) existing.qty += parseInt(qty);
            else cart.push({
                 id: res.product.id, uniqueId: uniqueId, qty: parseInt(qty),
                 name: res.product.name, price: res.product.price, image: res.product.image,
                 merchantId: res.product.merchantId, shopName: res.product.shopName
            });
            
            localStorage.setItem('DISKA_CART', JSON.stringify(cart));
            if(typeof updateCartBadge === 'function') updateCartBadge();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: res.message, showConfirmButton: false, timer: 1500 });
        }

        async function toggleWishlist(id, btn) {
            try {
                const icon = btn.querySelector('i');
                const isCurrentlyActive = btn.classList.contains('active');
                if(isCurrentlyActive) { btn.classList.remove('active'); icon.classList.remove('fas'); icon.classList.add('far'); }
                else { btn.classList.add('active'); icon.classList.remove('far'); icon.classList.add('fas'); btn.style.transform = "scale(1.2)"; setTimeout(() => btn.style.transform = "scale(1)", 200); }

                const response = await fetch('/Wishlist/Toggle', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: `productId=${id}` });
                if(response.status === 401) { window.location.href = '/Account/Login'; return; }
                const res = await response.json();
                if(!res.success) { 
                    if(isCurrentlyActive) { btn.classList.add('active'); icon.classList.add('fas'); }
                    else { btn.classList.remove('active'); icon.classList.remove('fas'); }
                }
            } catch(e) { console.error(e); }
        }
    </script>
}