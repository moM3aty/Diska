@model Diska.Models.DealRequest
@using System.Globalization
@{
    ViewData["Title"] = "تفاصيل الفرصة";
    Layout = "_MerchantLayout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    var myOffer = ViewBag.MyOffer as Diska.Models.MerchantOffer;
}

<style>
    /* Premium Chat Styles (Same as Admin/User) */
    .chat-box {
        height: 500px;
        display: flex;
        flex-direction: column;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
    }

    .chat-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: var(--bg-body);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .msg {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.95rem;
        position: relative;
    }

        /* Merchant (Me) */
        .msg.me {
            align-self: flex-end;
            background: var(--primary-color);
            color: #fff;
            border-bottom-left-radius: 2px;
        }

        /* Client (Other) */
        .msg.other {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-bottom-right-radius: 2px;
        }

    .chat-footer {
        padding: 15px;
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
    }

    .chat-input {
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        border-radius: 50px;
        padding: 10px 20px;
        width: 100%;
        outline: none;
    }

    .btn-send {
        background: var(--primary-color);
        color: #fff;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
</style>

<div class="row g-4">
    <!-- Request Details -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
            <div class="card-header bg-primary bg-opacity-10 py-3">
                <h5 class="mb-0 fw-bold text-primary">@Model.ProductName</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-6">
                        <small class="text-muted d-block">الكمية المطلوبة</small>
                        <span class="fw-bold fs-5">@Model.TargetQuantity</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">السعر المستهدف</small>
                        <span class="fw-bold fs-5 text-success">@Model.DealPrice.ToString("N0")</span>
                    </div>
                    <div class="col-12">
                        <small class="text-muted d-block">الموقع</small>
                        <span class="fw-bold">@Model.Location</span>
                    </div>
                    <div class="col-12">
                        <small class="text-muted d-block">العميل</small>
                        <span class="fw-bold">@Model.User?.FullName</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offer Section -->
        @if (myOffer == null)
        {
            <div class="card border-0 shadow-sm rounded-4 p-4">
                <h5 class="fw-bold mb-3">تقديم عرض سعر</h5>
                <form asp-action="SubmitOffer" method="post">
                    <input type="hidden" name="requestId" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">سرك المقترح (للقطعة)</label>
                        <input type="number" name="price" class="form-control" required placeholder="0.00">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ملاحظات</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="تفاصيل العرض..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">إرسال العرض</button>
                </form>
            </div>
        }
        else
        {
            <div class="alert @(myOffer.IsAccepted ? "alert-success" : "alert-info") rounded-4 border-0 shadow-sm">
                <h5 class="fw-bold"><i class="fas @(myOffer.IsAccepted ? "fa-check-circle" : "fa-clock") me-2"></i> حالة عرضك: @(myOffer.IsAccepted ? "مقبول" : "قيد الانتظار")</h5>
                <p class="mb-0">عرضت: <strong>@myOffer.OfferPrice.ToString("N0")</strong> - بتاريخ @myOffer.CreatedAt.ToString("dd/MM/yyyy")</p>
            </div>
        }
    </div>

    <!-- Chat Section (Only if Accepted) -->
    @if (myOffer != null && myOffer.IsAccepted)
    {
        <div class="col-lg-5">
            <div class="chat-box">
                <div class="p-3 border-bottom d-flex align-items-center gap-2 bg-light">
                    <i class="fas fa-comments text-primary"></i> محادثة مع العميل
                </div>

                <div class="chat-body" id="chatBody">
                    @if (Model.Messages != null && Model.Messages.Any())
                    {
                        foreach (var msg in Model.Messages)
                        {
                            bool isMe = msg.IsAdmin;
                            <div class="msg @(isMe ? "me" : "other")">
                                <div>@msg.Message</div>
                                <div style="font-size:0.7rem; opacity:0.7; text-align:end; margin-top:5px;">
                                    @(isMe ? "أنت" : "العميل") • @msg.CreatedAt.ToString("hh:mm tt")
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted mt-5">
                            <i class="far fa-comment-dots fa-3x mb-3 opacity-25"></i>
                            <p>ابدأ المحادثة مع العميل للاتفاق على التفاصيل.</p>
                        </div>
                    }
                </div>

                <div class="chat-footer">
                    <form id="chatForm" asp-action="SendReply" method="post" class="d-flex gap-2">
                        <input type="hidden" name="requestId" value="@Model.Id" />
                        <input type="text" name="message" class="chat-input" placeholder="اكتب رسالتك..." required autocomplete="off">
                        <button type="submit" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chatBody = document.getElementById("chatBody");
        if(chatBody) chatBody.scrollTop = chatBody.scrollHeight;
    });
</script>