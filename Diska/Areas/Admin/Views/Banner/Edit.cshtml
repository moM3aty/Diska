@model Diska.Models.Banner
@{
    ViewData["Title"] = "تعديل البنر";
    Layout = "_AdminLayout";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">تعديل البنر: @Model.Title</h5>
                <a asp-action="Index" class="btn btn-sm btn-outline-secondary">إلغاء</a>
            </div>
            <div class="card-body p-4">
                <form asp-action="Edit" enctype="multipart/form-data" id="bannerForm">
                    <input type="hidden" asp-for="Id" />

                    <!-- 1. الصور -->
                    <h6 class="text-muted fw-bold mb-3 border-bottom pb-2">الوسائط</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">صورة الديسك توب</label>
                            <input type="file" name="desktopFile" class="form-control" accept="image/*" onchange="previewImage(this, 'previewDesktop')">
                            <div class="mt-2 border rounded bg-light d-flex align-items-center justify-content-center" style="height: 100px;">
                                <img id="previewDesktop" src="~/@Model.ImageDesktop" style="max-height: 100%; max-width: 100%;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">صورة الموبايل</label>
                            <input type="file" name="mobileFile" class="form-control" accept="image/*" onchange="previewImage(this, 'previewMobile')">
                            <div class="mt-2 border rounded bg-light d-flex align-items-center justify-content-center" style="height: 100px;">
                                <img id="previewMobile" src="~/@Model.ImageMobile" style="max-height: 100%; max-width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- 2. النصوص -->
                    <h6 class="text-muted fw-bold mb-3 border-bottom pb-2">النصوص والمحتوى</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="Title" class="form-label"></label>
                            <input asp-for="Title" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="TitleEn" class="form-label"></label>
                            <input asp-for="TitleEn" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">نص فرعي (عربي)</label>
                            <input asp-for="Subtitle" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">نص فرعي (إنجليزي)</label>
                            <input asp-for="SubtitleEn" class="form-control" />
                        </div>
                    </div>

                    <!-- 3. التوجيه (يحتاج منطق JS لاسترجاع القيمة القديمة) -->
                    <h6 class="text-muted fw-bold mb-3 border-bottom pb-2">التوجيه والربط</h6>
                    <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">نوع الرابط</label>
                            <select asp-for="LinkType" id="linkType" class="form-select" onchange="toggleLinkInputs()">
                                <option value="External">رابط خارجي</option>
                                <option value="Category">قسم (Category)</option>
                                <option value="Product">منتج (Product)</option>
                                <option value="Deal">صفقة (Deal)</option>
                            </select>
                        </div>

                        <div class="col-md-8" id="inputContainer">
                            <!-- Input الرئيسي (سنستخدمه لتخزين القيمة النهائية) -->
                            <input type="hidden" asp-for="LinkId" id="finalLinkId" />

                            <div id="divExternal" class="link-input" style="display:none;">
                                <label class="form-label">الرابط (URL)</label>
                                <input type="text" id="valExternal" class="form-control" placeholder="https://..." value="@(Model.LinkType == "External" ? Model.LinkId : "")" />
                            </div>
                            <div id="divCategory" class="link-input" style="display:none;">
                                <label class="form-label">اختر القسم</label>
                                <select id="valCategory" class="form-select" asp-items="ViewBag.Categories">
                                    <option value="">-- اختر --</option>
                                </select>
                            </div>
                            <div id="divProduct" class="link-input" style="display:none;">
                                <label class="form-label">اختر المنتج</label>
                                <select id="valProduct" class="form-select" asp-items="ViewBag.Products">
                                    <option value="">-- اختر --</option>
                                </select>
                            </div>
                            <div id="divDeal" class="link-input" style="display:none;">
                                <label class="form-label">رقم الصفقة</label>
                                <input type="number" id="valDeal" class="form-control" value="@(Model.LinkType == "Deal" ? Model.LinkId : "")" />
                            </div>
                        </div>
                    </div>

                    <!-- 4. الجدولة -->
                    <h6 class="text-muted fw-bold mb-3 border-bottom pb-2">الجدولة والترتيب</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">تاريخ البدء</label>
                            <input asp-for="StartDate" type="datetime-local" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">تاريخ الانتهاء</label>
                            <input asp-for="EndDate" type="datetime-local" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">الأولوية</label>
                            <input asp-for="Priority" type="number" class="form-control" />
                        </div>
                        <div class="col-md-2 pt-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="IsActive">
                                <label class="form-check-label">تفعيل</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">حفظ التعديلات</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewImage(input, imgId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(imgId).src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleLinkInputs() {
            var type = document.getElementById('linkType').value;
            document.querySelectorAll('.link-input').forEach(el => el.style.display = 'none');
            document.getElementById('div' + type).style.display = 'block';
        }

        // Initialize based on current model value
        document.addEventListener('DOMContentLoaded', function() {
            var currentType = "@Model.LinkType";
            var currentId = "@Model.LinkId";

            toggleLinkInputs();

            // Set values if matching
            if(currentType === 'Category') document.getElementById('valCategory').value = currentId;
            if(currentType === 'Product') document.getElementById('valProduct').value = currentId;
        });

        document.getElementById('bannerForm').addEventListener('submit', function() {
            var type = document.getElementById('linkType').value;
            var finalVal = "";

            if (type === 'External') finalVal = document.getElementById('valExternal').value;
            else if (type === 'Category') finalVal = document.getElementById('valCategory').value;
            else if (type === 'Product') finalVal = document.getElementById('valProduct').value;
            else if (type === 'Deal') finalVal = document.getElementById('valDeal').value;

            document.getElementById('finalLinkId').value = finalVal;
        });
    </script>
}