@model Diska.Areas.Admin.Controllers.UserDetailsViewModel
@{
    ViewData["Title"] = "ملف المستخدم";
    Layout = "_AdminLayout";
    var role = ViewBag.UserRole as string;
}

<div style="margin-bottom:20px;">
    <a asp-action="Index" style="text-decoration:none; color:#64748b; font-weight:bold;">
        <i class="fas fa-arrow-right"></i> العودة لقائمة المستخدمين
    </a>
</div>

<div class="row g-4">
    <!-- Left: Profile Info -->
    <div class="col-md-4">
        <div class="card text-center mb-4">
            <div class="card-body">
                <div style="width:100px; height:100px; background:#f1f5f9; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:2.5rem; color:var(--primary);">
                    @(Model.User.FullName?.FirstOrDefault().ToString().ToUpper())
                </div>
                <h3 class="card-title text-primary">@Model.User.FullName</h3>
                <p class="text-muted">@Model.User.PhoneNumber</p>

                <div class="bg-light rounded p-2 mb-3 border">
                    <small class="text-muted d-block">الصلاحية</small>
                    <strong>@role</strong>
                </div>

                @if (role == "Merchant")
                {
                    <div class="text-end text-muted small border-top pt-2">
                        <p class="mb-1"><strong>المحل:</strong> @Model.User.ShopName</p>
                        <p class="mb-2"><strong>السجل:</strong> @Model.User.CommercialRegister</p>

                        <form asp-action="ToggleVerification" method="post">
                            <input type="hidden" name="id" value="@Model.User.Id" />
                            @if (Model.User.IsVerifiedMerchant)
                            {
                                <button class="btn btn-danger btn-sm w-100">إلغاء التوثيق</button>
                            }
                            else
                            {
                                <button class="btn btn-success btn-sm w-100">توثيق الحساب</button>
                            }
                        </form>
                    </div>
                }
            </div>
        </div>

        <!-- Wallet Actions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-primary"><i class="fas fa-wallet"></i> المحفظة</h5>
                <div class="text-center my-3">
                    <h2 class="text-success fw-bold">@Model.User.WalletBalance.ToString("N0") <small class="fs-6">ج.م</small></h2>
                </div>
                <button onclick="document.getElementById('balanceForm').style.display='block'; this.style.display='none';" class="btn btn-outline-secondary w-100 btn-sm">تعديل الرصيد</button>

                <form id="balanceForm" asp-action="ManageBalance" method="post" style="display:none;" class="mt-3 bg-light p-3 rounded">
                    <input type="hidden" name="id" value="@Model.User.Id" />
                    <div class="btn-group w-100 mb-2" role="group">
                        <input type="radio" class="btn-check" name="type" id="typeAdd" value="add" checked>
                        <label class="btn btn-outline-success btn-sm" for="typeAdd">إيداع (+)</label>
                        <input type="radio" class="btn-check" name="type" id="typeDeduct" value="deduct">
                        <label class="btn btn-outline-danger btn-sm" for="typeDeduct">خصم (-)</label>
                    </div>
                    <input type="number" name="amount" class="form-control form-control-sm mb-2" placeholder="المبلغ" required>
                    <input type="text" name="reason" class="form-control form-control-sm mb-2" placeholder="السبب" required>
                    <button class="btn btn-primary btn-sm w-100">تنفيذ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right: Tabs (Activity & Logs) -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#orders">الطلبات (@ViewBag.OrdersCount)</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#wallet">المعاملات المالية</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#login">سجل الدخول 🔒</button>
                    </li>
                </ul>
            </div>
            <div class="card-body tab-content">

                <!-- Orders Tab -->
                <div class="tab-pane fade show active" id="orders">
                    @if (Model.Orders.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light"><tr><th>#</th><th>التاريخ</th><th>المبلغ</th><th>الحالة</th></tr></thead>
                                <tbody>
                                    @foreach (var o in Model.Orders)
                                    {
                                        <tr>
                                            <td>#@o.Id</td>
                                            <td>@o.OrderDate.ToString("yyyy-MM-dd")</td>
                                            <td>@o.TotalAmount.ToString("N0")</td>
                                            <td><span class="badge bg-secondary">@o.Status</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {

                        <p class="text-center text-muted py-3">لا توجد طلبات.</p>
                    }
                </div>

                <!-- Wallet Tab -->
                <div class="tab-pane fade" id="wallet">
                    @if (Model.Transactions.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light"><tr><th>العملية</th><th>المبلغ</th><th>التاريخ</th><th>البيان</th></tr></thead>
                                <tbody>
                                    @foreach (var t in Model.Transactions)
                                    {
                                        <tr>
                                            <td>@(t.Type == "Deposit" ? "إيداع" : "خصم")</td>
                                            <td class="@(t.Amount > 0 ? "text-success" : "text-danger")">@t.Amount.ToString("N0")</td>
                                            <td>@t.TransactionDate.ToString("yyyy-MM-dd")</td>
                                            <td class="small">@t.Description</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {

                        <p class="text-center text-muted py-3">لا توجد معاملات.</p>
                    }
                </div>

                <!-- Login History Tab (New) -->
                <div class="tab-pane fade" id="login">
                    @if (Model.LoginLogs != null && Model.LoginLogs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>وقت الدخول</th>
                                        <th>IP Address</th>
                                        <th>الجهاز / المتصفح</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model.LoginLogs)
                                    {
                                        <tr>
                                            <td>@log.LoginTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td><span class="font-monospace">@log.IpAddress</span></td>
                                            <td class="small">@log.DeviceInfo</td>
                                            <td>
                                                @if (log.IsSuccess)
                                                {
                                                    <span class="badge bg-success">ناجح</span>
                                                }
                                                else
                                                {

                                                    <span class="badge bg-danger" title="@log.FailureReason">فشل</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fa-2x mb-2 opacity-50"></i>
                            <p>سجل الدخول غير متوفر أو فارغ لهذا المستخدم.</p>
                        </div>
                    }
                </div>

            </div>
        </div>
    </div>
</div>