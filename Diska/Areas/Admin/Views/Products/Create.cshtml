@model Diska.Models.Product
@{
    ViewData["Title"] = "إضافة منتج";
    Layout = "_AdminLayout";
}

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">إضافة منتج جديد</h5>
                <a asp-action="Index" class="btn btn-sm btn-outline-secondary">إلغاء</a>
            </div>
            <div class="card-body p-4">
                <form asp-action="Create" enctype="multipart/form-data" id="productForm">

                    <ul class="nav nav-tabs mb-4" id="prodTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic" type="button">أساسي</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pricing" type="button">الأسعار والمخزون</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#media" type="button">الصور والألوان</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#seo" type="button">SEO والشحن</button></li>
                    </ul>

                    <div class="tab-content" id="myTabContent">

                        <!-- 1. Basic Info -->
                        <div class="tab-pane fade show active" id="basic">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">الاسم (عربي) <span class="text-danger">*</span></label>
                                    <input asp-for="Name" class="form-control" required />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الاسم (إنجليزي) <span class="text-danger">*</span></label>
                                    <input asp-for="NameEn" class="form-control" required />
                                    <span asp-validation-for="NameEn" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">التاجر</label>
                                    <select asp-for="MerchantId" class="form-select" asp-items="ViewBag.Merchants"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">القسم</label>
                                    <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الماركة (Brand)</label>
                                    <input asp-for="Brand" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الحالة</label>
                                    <select asp-for="Status" class="form-select">
                                        <option value="Active">نشط (ظاهر للعملاء)</option>
                                        <option value="Draft">مسودة (غير ظاهر)</option>
                                        <option value="Archived">مؤرشف</option>
                                    </select>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="form-label">الوصف (عربي)</label>
                                    <div id="editor-ar" style="height:150px; background:#fff;"></div>
                                    <input type="hidden" asp-for="Description" id="DescriptionHidden" />
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="form-label">الوصف (إنجليزي)</label>
                                    <div id="editor-en" style="height:150px; background:#fff;"></div>
                                    <input type="hidden" asp-for="DescriptionEn" id="DescriptionEnHidden" />
                                </div>
                            </div>
                        </div>

                        <!-- 2. Pricing & Inventory -->
                        <div class="tab-pane fade" id="pricing">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">السعر (ج.م) <span class="text-danger">*</span></label>
                                    <input asp-for="Price" type="number" step="0.01" class="form-control fw-bold" required />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">السعر قبل الخصم</label>
                                    <input asp-for="OldPrice" type="number" step="0.01" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">سعر التكلفة (داخلي)</label>
                                    <input asp-for="CostPrice" type="number" step="0.01" class="form-control bg-light" />
                                </div>

                                <div class="col-12"><hr /></div>

                                <div class="col-md-4">
                                    <label class="form-label">الكمية (Stock) <span class="text-danger">*</span></label>
                                    <input asp-for="StockQuantity" type="number" class="form-control" required />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">حد النواقص (للتنبيه)</label>
                                    <input asp-for="LowStockThreshold" type="number" class="form-control" value="5" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">وحدات الكرتونة</label>
                                    <input asp-for="UnitsPerCarton" type="number" class="form-control" value="1" />
                                </div>

                                <div class="col-12"><hr /></div>

                                <div class="col-md-6">
                                    <label class="form-label">SKU (رمز المخزون)</label>
                                    <input asp-for="SKU" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الباركود (Barcode)</label>
                                    <input asp-for="Barcode" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- 3. Media & Colors -->
                        <div class="tab-pane fade" id="media">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">الصورة الرئيسية</label>
                                    <input type="file" name="mainImage" class="form-control" accept="image/*" onchange="previewSingle(this)">
                                    <img id="mainPreview" class="mt-2 border rounded" style="height:100px; display:none;">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">معرض الصور</label>
                                    <input type="file" name="galleryImages" class="form-control" accept="image/*" multiple>
                                </div>

                                <div class="col-12 mt-4">
                                    <h6 class="text-muted">خيارات الألوان</h6>
                                    <div id="colorsContainer" class="mb-2"></div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addColorInput()">+ إضافة لون</button>
                                </div>
                            </div>
                        </div>

                        <!-- 4. SEO & Shipping -->
                        <div class="tab-pane fade" id="seo">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">الوزن (كجم)</label>
                                    <input asp-for="Weight" type="number" step="0.01" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الرابط (Slug)</label>
                                    <input asp-for="Slug" class="form-control" placeholder="auto-generated" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">عنوان الميتا (Meta Title)</label>
                                    <input asp-for="MetaTitle" class="form-control" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">وصف الميتا (Meta Description)</label>
                                    <textarea asp-for="MetaDescription" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top text-end">
                        <button type="submit" class="btn btn-primary px-4 fw-bold" onclick="prepareDescription()">حفظ المنتج</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quillAr = new Quill('#editor-ar', { theme: 'snow', modules: { toolbar: [ ['bold', 'italic'], [{ 'list': 'ordered'}, { 'list': 'bullet' }] ] } });
    var quillEn = new Quill('#editor-en', { theme: 'snow', modules: { toolbar: [ ['bold', 'italic'], [{ 'list': 'ordered'}, { 'list': 'bullet' }] ] } });

    function prepareDescription() {
        document.getElementById('DescriptionHidden').value = quillAr.root.innerHTML;
        document.getElementById('DescriptionEnHidden').value = quillEn.root.innerHTML;
    }

    function previewSingle(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('mainPreview').src = e.target.result;
                document.getElementById('mainPreview').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addColorInput() {
        const div = document.createElement('div');
        div.className = 'd-flex gap-2 mb-2 align-items-center';
        div.innerHTML = `
            <input type="color" name="productColorsHex" class="form-control form-control-color" value="#000000">
            <input type="text" name="productColorsName" class="form-control" placeholder="اسم اللون">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('colorsContainer').appendChild(div);
    }
</script>