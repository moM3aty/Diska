@model IEnumerable<Diska.Models.Product>
@{
    ViewData["Title"] = "إدارة المنتجات";
    Layout = "_AdminLayout";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalItems = ViewBag.TotalItems ?? 0;
}


<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4 fade-up">
    <div>
        <h2 class="text-dark fw-bold mb-1">إدارة المنتجات</h2>
        <p class="text-muted small mb-0">عرض وإدارة مخزون المتجر</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-success btn-excel export-Excel shadow-sm bg-white" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="fas fa-file-import"></i> استيراد
        </button>
        <form asp-action="ExportToExcel" method="post" >
            <button type="submit" class="btn btn-success btn-excel shadow-sm">
                <i class="fas fa-file-excel"></i> تصدير Excel
            </button>
        </form>
        <a asp-action="Create" class="btn btn-primary fw-bold shadow-sm px-4">
            <i class="fas fa-plus me-2"></i> منتج جديد
        </a>
    </div>
</div>

<!-- Filters -->
<form method="get" asp-action="Index" class="filter-bar fade-up" style="animation-delay: 0.1s;">
    <div class="search-input-group">
        <input type="text" name="search" class="form-control" placeholder="بحث بالاسم أو SKU..." value="@ViewBag.Search">
        <i class="fas fa-search"></i>
    </div>

    <div style="width: 180px;">
        <select name="categoryId" class="form-select" asp-items="ViewBag.CategoryId">
            <option value="">كل الأقسام</option>
        </select>
    </div>

    <div style="width: 180px;">
        <select name="merchantId" class="form-select" asp-items="ViewBag.MerchantId">
            <option value="">كل التجار</option>
        </select>
    </div>

    <div style="width: 150px;">
        <select name="status" class="form-select">
            <option value="">الحالة</option>
            <option value="Active" selected="@(ViewBag.FilterStatus == "Active")">نشط</option>
            <option value="LowStock" selected="@(ViewBag.FilterStatus == "LowStock")">منخفض</option>
            <option value="OutOfStock" selected="@(ViewBag.FilterStatus == "OutOfStock")">نافذ</option>
        </select>
    </div>

    <button type="submit" class="btn btn-primary px-3"><i class="fas fa-filter"></i></button>
    <a asp-action="Index" class="btn btn-light border px-3"><i class="fas fa-undo"></i></a>
</form>

<!-- Table -->
<div class="table-card fade-up" style="animation-delay: 0.2s;">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th class="ps-4">المنتج</th>
                    <th>السعر</th>
                    <th>المخزون</th>
                    <th>القسم</th>
                    <th>التاجر</th>
                    <th>الحالة</th>
                    <th class="text-end pe-4">إجراءات</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-box-open fa-3x mb-3 opacity-25"></i>
                                <p>لا توجد منتجات مطابقة للبحث.</p>
                            </div>
                        </td>
                    </tr>
                }
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center gap-3">
                                <img src="~/@item.ImageUrl" class="product-img-box" onerror="this.src='/images/default.png'">
                                <div>
                                    <div class="fw-bold text-dark">@item.Name</div>
                                    @if (!string.IsNullOrEmpty(item.SKU))
                                    {
                                        <small class="text-muted font-monospace bg-light px-1 rounded border">@item.SKU</small>
                                    }
                                </div>
                            </div>
                        </td>
                        <td class="fw-bold text-primary">@item.Price.ToString("N0")</td>
                        <td>
                            @if (item.StockQuantity == 0)
                            {
                                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill">نافذ</span>
                            }
                            else if (item.StockQuantity <= item.LowStockThreshold)
                            {
                                <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill">منخفض (@item.StockQuantity)</span>
                            }
                            else
                            {
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill">@item.StockQuantity</span>
                            }
                        </td>
                        <td><span class="badge bg-light text-dark border">@item.Category?.Name</span></td>
                        <td><small class="fw-bold">@(item.Merchant?.ShopName ?? "الإدارة")</small></td>
                        <td>
                            @if (item.Status == "Active")
                            {
                                <span class="badge bg-success">نشط</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@item.Status</span>
                            }
                        </td>
                        <td class="text-end pe-4">
                            <div class="d-flex justify-content-end gap-2">
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn-action btn-edit" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn-action btn-delete" onclick="confirmDelete(@item.Id, '@item.Name')" title="حذف">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <form id="deleteForm-@item.Id" asp-action="Delete" method="post" class="d-none">
                                <input type="hidden" name="id" value="@item.Id" />
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (totalPages > 1)
    {
        <div class="p-3 border-top d-flex justify-content-between align-items-center">
            <span class="text-muted small">عرض @Model.Count() من أصل @totalItems منتج</span>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = currentPage - 1, search = ViewBag.Search, categoryId = ViewBag.FilterCategoryId, merchantId = ViewBag.FilterMerchantId, status = ViewBag.FilterStatus })">&laquo;</a>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = i, search = ViewBag.Search, categoryId = ViewBag.FilterCategoryId, merchantId = ViewBag.FilterMerchantId, status = ViewBag.FilterStatus })">@i</a>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = currentPage + 1, search = ViewBag.Search, categoryId = ViewBag.FilterCategoryId, merchantId = ViewBag.FilterMerchantId, status = ViewBag.FilterStatus })">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">استيراد منتجات (Excel/CSV)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="ImportFromExcel" method="post" enctype="multipart/form-data">
                <div class="modal-body text-center py-4">
                    <div class="upload-zone border-dashed p-4 rounded bg-light mb-3" onclick="document.getElementById('excelFile').click()" style="cursor:pointer;">
                        <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                        <p class="mb-1 fw-bold">اضغط لاختيار الملف</p>
                        <small class="text-muted">يقبل ملفات CSV فقط بالصيغة القياسية</small>
                        <input type="file" name="excelFile" id="excelFile" class="d-none" accept=".csv" required onchange="document.getElementById('fileName').innerText = this.files[0].name">
                    </div>
                    <div id="fileName" class="text-primary fw-bold"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary px-4">بدء الاستيراد</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function confirmDelete(id, name) {
        Swal.fire({
            title: 'حذف المنتج؟',
            text: `هل أنت متأكد من حذف "${name}"؟ لا يمكن التراجع عن هذا الإجراء.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'نعم، حذف',
            cancelButtonText: 'إلغاء'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('deleteForm-' + id).submit();
            }
        });
    }
</script>