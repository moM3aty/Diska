@model Diska.Models.Product
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = "تعديل المنتج";
    Layout = "_AdminLayout";
}

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- نفس الستايل المودرن -->
<style>
    .pro-card {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border: 1px solid #f1f5f9;
        margin-bottom: 25px;
    }

    .form-label {
        font-weight: 700;
        color: #334155;
        margin-bottom: 8px;
        display: block;
    }

    .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        background: #f8fafc;
    }

        .upload-zone:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

    .color-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .color-input {
        width: 40px;
        height: 40px;
        border: none;
        background: none;
        cursor: pointer;
        padding: 0;
    }

    .btn-remove-color {
        background: #fee2e2;
        color: #dc2626;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .gallery-preview {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    .gallery-item {
        position: relative;
        width: 80px;
        height: 80px;
    }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

    .gallery-remove {
        position: absolute;
        top: -5px;
        right: -5px;
        background: red;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    /* Quill */
    .ql-toolbar {
        border-radius: 8px 8px 0 0;
        border-color: #e2e8f0 !important;
        background: #f8fafc;
    }

    .ql-container {
        border-radius: 0 0 8px 8px;
        border-color: #e2e8f0 !important;
        font-family: 'Cairo', sans-serif;
        font-size: 1rem;
    }

    .ql-editor {
        min-height: 150px;
    }
</style>

<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2 style="color:var(--primary); margin:0;">تعديل: @Model.Name</h2>
        <div style="display:flex; gap:10px;">
            <a asp-action="Index" class="btn btn-outline">إلغاء</a>
            <button type="submit" form="editForm" class="btn btn-primary px-4" onclick="prepareDescription()">حفظ التعديلات</button>
        </div>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editForm">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ImageUrl" />

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">

            <!-- Left -->
            <div>
                <div class="pro-card">
                    <h4 style="margin-top:0; margin-bottom:20px; color:#64748b;">البيانات الأساسية</h4>
                    <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px;">
                        <div>
                            <label class="form-label">الاسم (عربي) *</label>
                            <input asp-for="Name" class="form-control" required />
                        </div>
                        <div>
                            <label class="form-label">الاسم (إنجليزي) *</label>
                            <input asp-for="NameEn" class="form-control" required />
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <label class="form-label">الوصف (عربي)</label>
                        <div id="rawDescAr" style="display:none;">@Html.Raw(Model.Description)</div>
                        <div id="editor-ar"></div>
                        <input type="hidden" asp-for="Description" id="DescriptionHidden" />
                    </div>

                    <div>
                        <label class="form-label">الوصف (إنجليزي) *</label>
                        <div id="rawDescEn" style="display:none;">@Html.Raw(Model.DescriptionEn)</div>
                        <div id="editor-en"></div>
                        <input type="hidden" asp-for="DescriptionEn" id="DescriptionEnHidden" />
                    </div>
                </div>

                <div class="pro-card">
                    <h4 style="margin-top:0; margin-bottom:20px; color:#64748b;">الصور</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label class="form-label">الصورة الرئيسية</label>
                            <div class="upload-zone" onclick="document.getElementById('mainImage').click()">
                                <input type="file" name="mainImage" id="mainImage" accept="image/*" style="display:none;" onchange="previewSingle(this)">
                                <img id="mainPreview" src="~/@Model.ImageUrl" style="max-height:100px;">
                            </div>
                        </div>
                        <div>
                            <label class="form-label">إضافة صور للمعرض</label>
                            <div class="upload-zone" onclick="document.getElementById('galleryImages').click()">
                                <input type="file" name="galleryImages" id="galleryImages" accept="image/*" multiple style="display:none;">
                                <i class="fas fa-plus fa-2x" style="color:#cbd5e1;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- عرض الصور الموجودة -->
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        <div class="gallery-preview">
                            @foreach (var img in Model.Images)
                            {
                                <div class="gallery-item" id="img-@img.Id">
                                    <img src="~/@img.ImageUrl">
                                    <button type="button" class="gallery-remove" onclick="deleteImage(@img.Id)">x</button>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- قسم الألوان -->
                <div class="pro-card">
                    <h4 style="margin-top:0; margin-bottom:20px; color:#64748b;">خيارات الألوان</h4>
                    <div id="colorsContainer">
                        @if (Model.ProductColors != null)
                        {
                            foreach (var color in Model.ProductColors)
                            {
                                <div class="color-row">
                                    <input type="color" name="productColorsHex" class="color-input" value="@color.ColorHex">
                                    <input type="text" name="productColorsName" class="form-control" value="@color.ColorName" style="flex:1;">
                                    <button type="button" class="btn-remove-color" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
                                </div>
                            }
                        }
                    </div>
                    <button type="button" class="btn btn-outline small" onclick="addColorInput()"><i class="fas fa-plus"></i> إضافة لون</button>
                </div>
            </div>

            <!-- Right -->
            <div>
                <div class="pro-card">
                    <h4 style="margin-top:0; margin-bottom:20px; color:#64748b;">الإعدادات</h4>
                    <div class="form-group mb-3">
                        <label class="form-label">التاجر *</label>
                        <select asp-for="MerchantId" class="form-control" asp-items="ViewBag.Merchants" required></select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">القسم *</label>
                        <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories" required></select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">السعر *</label>
                        <input asp-for="Price" type="number" step="0.01" class="form-control" required style="font-weight:bold;" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">السعر القديم</label>
                        <input asp-for="OldPrice" type="number" step="0.01" class="form-control" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">المخزون *</label>
                        <input asp-for="StockQuantity" type="number" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">وحدات الكرتونة *</label>
                        <input asp-for="UnitsPerCarton" type="number" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">تاريخ الإنتاج</label>
                        <input asp-for="ProductionDate" type="date" class="form-control" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">تاريخ الانتهاء</label>
                        <input asp-for="ExpiryDate" type="date" class="form-control" />
                    </div>
                    <div style="margin-top:15px; border-top:1px solid #f1f5f9; padding-top:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input asp-for="IsActive" type="checkbox" style="width:20px; height:20px;">
                            <span>نشط</span>
                        </label>
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var toolbarOptions = [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'header': [1, 2, 3, false] }], ['clean']];
    var quillAr = new Quill('#editor-ar', { theme: 'snow', modules: { toolbar: toolbarOptions } });
    var quillEn = new Quill('#editor-en', { theme: 'snow', modules: { toolbar: toolbarOptions } });

    quillAr.root.innerHTML = document.getElementById('rawDescAr').innerHTML;
    quillEn.root.innerHTML = document.getElementById('rawDescEn').innerHTML;

    function prepareDescription() {
        document.getElementById('DescriptionHidden').value = quillAr.root.innerHTML;
        document.getElementById('DescriptionEnHidden').value = quillEn.root.innerHTML;
    }

    function previewSingle(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) { document.getElementById('mainPreview').src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addColorInput() {
        const div = document.createElement('div');
        div.className = 'color-row';
        div.innerHTML = `
            <input type="color" name="productColorsHex" class="color-input" value="#000000">
            <input type="text" name="productColorsName" class="form-control" placeholder="اسم اللون" style="flex:1;">
            <button type="button" class="btn-remove-color" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('colorsContainer').appendChild(div);
    }

    async function deleteImage(imgId) {
        if(confirm('حذف هذه الصورة؟')) {
            await fetch('/Admin/Products/DeleteImage/' + imgId, { method: 'POST' });
            document.getElementById('img-' + imgId).remove();
        }
    }
</script>