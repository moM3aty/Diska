@model Diska.Areas.Admin.ViewModels.ApprovalsViewModel
@{
    ViewData["Title"] = "مركز الموافقات";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --ap-bg: #f8fafc;
        --ap-card: #ffffff;
        --ap-border: #e2e8f0;
        --ap-text: #0f172a;
        --ap-muted: #64748b;
        --ap-primary: #4f46e5;
    }

    [data-bs-theme="dark"] {
        --ap-bg: #020617;
        --ap-card: #1e293b;
        --ap-border: rgba(255, 255, 255, 0.08);
        --ap-text: #f8fafc;
        --ap-muted: #94a3b8;
        --ap-primary: #818cf8;
    }

    .approval-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        background: var(--ap-card);
        overflow: hidden;
        margin-bottom: 20px;
    }

    .nav-pills .nav-link {
        color: var(--ap-muted) !important;
        font-weight: 700;
        padding: 12px 25px;
        border-radius: 50px;
        margin-right: 10px;
        transition: all 0.3s;
        border: 1px solid var(--ap-border);
    }

        .nav-pills .nav-link.active {
            background-color: var(--ap-primary);
            color: #fff !important;
            border-color: var(--ap-primary);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

    .item-row {
        border-bottom: 1px solid var(--ap-border);
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--ap-card);
        margin-bottom: 15px;
        border-radius: 16px;
        border: 1px solid var(--ap-border);
        transition: 0.3s;
    }

        .item-row:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

    .item-info-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .item-icon {
        width: 55px;
        height: 55px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .actions-group {
        display: flex;
        gap: 10px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    /* --- Media Query --- */
    @("@media") (max-width: 768px) {
        .item-row

    {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
    }

    .item-info-group {
        width: 100%;
    }

    .actions-group {
        width: 100%;
    }

        /* توزيع الأزرار بالتساوي */
        .actions-group > * {
            flex: 1;
        }

        .actions-group button, .actions-group .btn {
            width: 100%;
            justify-content: center;
        }

    .nav-pills {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 10px;
        gap: 5px;
    }

        .nav-pills .nav-link {
            margin-right: 0;
            white-space: nowrap;
        }

    }

    /* --- Extra Small Screens (<= 478px) --- */
    @("@media") (max-width: 478px) {
        .item-row

    {
        padding: 15px; /* تقليل الحواف */
    }

    .item-icon {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
        border-radius: 10px;
    }

    .item-info-group {
        gap: 10px;
    }

    /* ترتيب الأزرار فوق بعضها في الشاشات الصغيرة جداً */
    .actions-group {
        flex-direction: column;
        width: 100%;
    }

    .page-header h2 {
        font-size: 1.5rem;
    }

    .page-header .badge {
        width: 100%;
        display: block;
        text-align: center;
        margin-top: 5px;
    }

    }
</style>

<div class="page-header fade-up">
    <div>
        <h2 class="fw-bold mb-1" style="color:var(--text-main)">مركز الموافقات</h2>
        <p class="text-muted small mb-0">مراجعة واعتماد طلبات التجار والمنتجات</p>
    </div>
    <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">@Model.TotalCount طلب معلق</span>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-4 fade-up" id="pills-tab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="pills-merchants-tab" data-bs-toggle="pill" data-bs-target="#pills-merchants" type="button">
            <i class="fas fa-store me-2"></i> تجار جدد
            @if (Model.NewMerchants.Any())
            {
                <span class="badge bg-white text-primary ms-2">@Model.NewMerchants.Count</span>
            }
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="pills-products-tab" data-bs-toggle="pill" data-bs-target="#pills-products" type="button">
            <i class="fas fa-box me-2"></i> منتجات جديدة
            @if (Model.PendingProducts.Any())
            {
                <span class="badge bg-white text-primary ms-2">@Model.PendingProducts.Count</span>
            }
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="pills-others-tab" data-bs-toggle="pill" data-bs-target="#pills-others" type="button">
            <i class="fas fa-tasks me-2"></i> طلبات أخرى
            @if (Model.OtherActions.Any())
            {
                <span class="badge bg-white text-primary ms-2">@Model.OtherActions.Count</span>
            }
        </button>
    </li>
</ul>

<div class="tab-content fade-up" id="pills-tabContent">

    <!-- 1. Merchants Tab -->
    <div class="tab-pane fade show active" id="pills-merchants">
        @if (!Model.NewMerchants.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-muted opacity-25 mb-3"></i>
                <h5 class="text-muted">لا توجد طلبات تسجيل تجار جديدة</h5>
            </div>
        }
        else
        {
            @foreach (var item in Model.NewMerchants)
            {
                <div class="item-row">
                    <div class="item-info-group">
                        <div class="item-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-1" style="color:var(--text-main)">@item.ShopName</h5>
                            <div class="text-muted small">
                                <i class="fas fa-user me-1"></i> @item.FullName
                                <span class="mx-2 d-none d-md-inline">|</span>
                                <br class="d-md-none" />
                                <i class="fas fa-phone me-1"></i> @item.PhoneNumber
                            </div>
                            <div class="mt-2 small d-flex flex-wrap gap-2">
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border">سجل: @item.CommercialRegister</span>
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border">ضريبي: @item.TaxCard</span>
                            </div>
                        </div>
                    </div>
                    <div class="actions-group">
                        <form asp-action="ApproveMerchant" method="post">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-success fw-bold px-4 rounded-pill"><i class="fas fa-check me-2"></i> توثيق</button>
                        </form>
                        <form asp-action="RejectMerchant" method="post" onsubmit="return confirm('رفض التاجر؟ سيتم حذف الحساب.')">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-outline-danger fw-bold px-4 rounded-pill"><i class="fas fa-times me-2"></i> رفض</button>
                        </form>
                    </div>
                </div>
            }
        }
    </div>

    <!-- 2. Products Tab -->
    <div class="tab-pane fade" id="pills-products">
        @if (!Model.PendingProducts.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-muted opacity-25 mb-3"></i>
                <h5 class="text-muted">لا توجد منتجات بانتظار الموافقة</h5>
            </div>
        }
        else
        {
            @foreach (var item in Model.PendingProducts)
            {
                <div class="item-row">
                    <div class="item-info-group">
                        <img src="~/@item.ImageUrl" class="item-icon object-fit-cover bg-white border" onerror="this.src='/images/default.png'">
                        <div>
                            <h5 class="fw-bold mb-1" style="color:var(--text-main)">@item.Name</h5>
                            <div class="text-muted small">
                                <i class="fas fa-store me-1"></i> @item.Merchant?.ShopName
                                <span class="mx-2">|</span>
                                <i class="fas fa-tag me-1"></i> @item.Category?.Name
                            </div>
                            <div class="mt-1 fw-bold text-success">@item.Price.ToString("N0") ج.م</div>
                        </div>
                    </div>
                    <div class="actions-group">
                        <a href="/Admin/Approvals/ProductDetails/@item.Id" target="_blank" class="btn btn-light border rounded-pill" title="معاينة"><i class="fas fa-eye"></i></a>
                        <form asp-action="ApproveProduct" method="post">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-success fw-bold px-3 rounded-pill"><i class="fas fa-check"></i> نشر</button>
                        </form>
                        <form asp-action="RejectProduct" method="post" onsubmit="return confirm('رفض المنتج؟')">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-outline-danger fw-bold px-3 rounded-pill"><i class="fas fa-times"></i> رفض</button>
                        </form>
                    </div>
                </div>
            }
        }
    </div>

    <!-- 3. Other Actions Tab -->
    <div class="tab-pane fade" id="pills-others">
        @if (!Model.OtherActions.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-muted opacity-25 mb-3"></i>
                <h5 class="text-muted">لا توجد طلبات أخرى معلقة</h5>
            </div>
        }
        else
        {
            @foreach (var item in Model.OtherActions)
            {
                <div class="item-row">
                    <div class="item-info-group">
                        <div class="item-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-1" style="color:var(--text-main)">
                                @if (item.ActionType == "UpdateProductPrice")
                                {
                                    <span>تعديل سعر منتج</span>
                                }
                                else if (item.ActionType == "WithdrawRequest")
                                {
                                    <span>طلب سحب رصيد</span>
                                }
                                else
                                {
                                    <span>@item.ActionType</span>
                                }
                            </h5>
                            <div class="text-muted small">
                                <i class="fas fa-user me-1"></i> @item.Merchant?.ShopName
                                <span class="mx-2">|</span>
                                <i class="far fa-clock me-1"></i> @item.RequestDate.ToString("yyyy-MM-dd")
                            </div>
                            <div class="mt-1 small font-monospace text-muted">
                                @if (item.ActionType == "UpdateProductPrice")
                                {
                                    <span>السعر الجديد: <strong class="text-success">@item.NewValueJson</strong></span>
                                }
                                else
                                {
                                    <span>@item.NewValueJson</span>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="actions-group">
                        <form asp-action="ApproveAction" method="post">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-success fw-bold px-4 rounded-pill"><i class="fas fa-check me-2"></i> موافقة</button>
                        </form>
                        <form asp-action="RejectAction" method="post">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="btn btn-outline-danger fw-bold px-4 rounded-pill"><i class="fas fa-times me-2"></i> رفض</button>
                        </form>
                    </div>
                </div>
            }
        }
    </div>

</div>