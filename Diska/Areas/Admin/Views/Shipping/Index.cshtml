@model IEnumerable<Diska.Models.ShippingRate>
@using System.Globalization
@{
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    ViewData["Title"] = isAr ? "إدارة الشحن" : "Shipping Management";
    Layout = "_AdminLayout";
}

<style>
    /* =========================================
           PREMIUM SHIPPING ADMIN STYLES
           ========================================= */
    :root {
        --shp-bg: #f8fafc;
        --shp-card-bg: #ffffff;
        --shp-text-main: #0f172a;
        --shp-text-muted: #64748b;
        --shp-border: #e2e8f0;
        --shp-primary: #0F172A;
        --shp-accent: #FACC15;
        --shp-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        --shp-input-bg: #f8fafc;
    }

    [data-bs-theme="dark"] {
        --shp-bg: #020617;
        --shp-card-bg: #1e293b;
        --shp-text-main: #f8fafc;
        --shp-text-muted: #94a3b8;
        --shp-border: rgba(255, 255, 255, 0.08);
        --shp-primary: #f8fafc;
        --shp-accent: #FACC15;
        --shp-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        --shp-input-bg: #0f172a;
    }

    body {
        background-color: var(--shp-bg);
        transition: background-color 0.3s ease;
    }

    .section-padding {
        padding: 50px 0;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        margin: 0;
        color: var(--shp-primary);
        font-weight: 800;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .admin-card {
        background: var(--shp-card-bg);
        border-radius: 16px;
        border: 1px solid var(--shp-border);
        box-shadow: var(--shp-shadow);
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    /* Upload Section Styles */
    .upload-icon {
        width: 60px;
        height: 60px;
        background: rgba(15, 23, 42, 0.05);
        color: var(--shp-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 15px;
    }

    [data-bs-theme="dark"] .upload-icon {
        background: rgba(255, 255, 255, 0.05);
        color: var(--shp-accent);
    }

    .upload-area {
        border: 2px dashed var(--shp-border);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: var(--shp-input-bg);
        transition: 0.3s;
        margin-bottom: 15px;
        position: relative;
    }

        .upload-area:hover {
            border-color: var(--shp-accent);
            background: var(--shp-card-bg);
        }

    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .upload-text h5 {
        font-weight: 700;
        color: var(--shp-text-main);
        margin-bottom: 5px;
        font-size: 1rem;
    }

    .upload-text p {
        color: var(--shp-text-muted);
        font-size: 0.8rem;
        margin: 0;
    }

    .btn-upload {
        width: 100%;
        background: var(--shp-primary);
        color: #fff;
        padding: 12px;
        border-radius: 50px;
        border: none;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    [data-bs-theme="dark"] .btn-upload {
        background: var(--shp-accent);
        color: #000;
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    .instructions {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--shp-border);
        color: var(--shp-text-muted);
        font-size: 0.85rem;
        text-align: start;
    }

        .instructions h6 {
            color: var(--shp-text-main);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .instructions ul {
            padding-inline-start: 20px;
            margin: 0;
        }

        .instructions li {
            margin-bottom: 4px;
        }

    .alert-custom {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .alert-success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .alert-danger {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    [data-bs-theme="dark"] .alert-success {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.2);
    }

    [data-bs-theme="dark"] .alert-danger {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        border-color: rgba(239, 68, 68, 0.2);
    }

    /* Table Styles */
    .table-responsive {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

        .table th {
            background: rgba(0,0,0,0.02);
            color: var(--shp-text-muted);
            padding: 15px;
            text-align: start;
            font-weight: 700;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--shp-border);
            text-transform: uppercase;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid var(--shp-border);
            color: var(--shp-text-main);
            vertical-align: middle;
        }

        .table tr:hover td {
            background-color: rgba(0,0,0,0.02);
        }

    .btn-action {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--shp-border);
        color: var(--shp-text-muted);
        background: transparent;
        transition: 0.2s;
    }

    .btn-edit:hover {
        background: yellow;
        color: #000;
        border-color: var(--shp-primary);
    }

    .btn-delete:hover {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
    }

    .btn-add-manual {
        background: transparent;
        border: 2px solid var(--shp-primary);
        color: var(--shp-primary);
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 700;
        transition: 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    [data-bs-theme="dark"] .btn-add-manual {
        border-color: var(--shp-accent);
        color: var(--shp-accent);
    }

    .btn-add-manual:hover {
        background: var(--shp-primary);
        color: #fff;
    }

    [data-bs-theme="dark"] .btn-add-manual:hover {
        background: var(--shp-accent);
        color: #000;
    }

    .btn-export {
        background: #10b981;
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 700;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
        transition: 0.3s;
    }

        .btn-export:hover {
            transform: translateY(-2px);
            background: #059669;
            color: #fff;
        }

    /* Modal Styles */
    .modal-content {
        background-color: var(--shp-card-bg);
        border: 1px solid var(--shp-border);
    }

    .modal-header {
        border-bottom: 1px solid var(--shp-border);
    }

    .modal-title {
        color: var(--shp-text-main);
    }

    .modal-footer {
        border-top: 1px solid var(--shp-border);
    }

    .form-label {
        color: var(--shp-text-main);
        font-weight: 600;
    }

    .form-control {
        background-color: var(--shp-input-bg);
        border: 1px solid var(--shp-border);
        color: var(--shp-text-main);
    }

        .form-control:focus {
            background-color: var(--shp-card-bg);
            border-color: var(--shp-accent);
            box-shadow: 0 0 0 0.25rem rgba(250, 204, 21, 0.15);
        }

    [data-bs-theme="dark"] .btn-close {
        filter: invert(1);
    }

    /* Animation */
    .fade-up {
        animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @@keyframes fadeUp {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

<div class="container py-5 fade-up">

    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-truck-moving" style="color:var(--shp-accent);"></i>
            @(isAr ? "إدارة أسعار الشحن" : "Shipping Rates Management")
        </h1>
        <div style="display:flex; gap:10px;">
            <a asp-action="Export" class="btn-export">
                <i class="fas fa-file-csv"></i> @(isAr ? "تصدير CSV" : "Export CSV")
            </a>
            <button type="button" class="btn-add-manual" onclick="openAddModal()">
                <i class="fas fa-plus"></i> @(isAr ? "إضافة يدوي" : "Add Manual")
            </button>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert-custom alert-success">
            <i class="fas fa-check-circle"></i> @TempData["Success"]
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert-custom alert-danger">
            <i class="fas fa-exclamation-triangle"></i> @TempData["Error"]
        </div>
    }

    <div class="row g-4">
        <!-- Left: Upload Card -->
        <div class="col-lg-4">
            <div class="admin-card">
                <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                </div>

                <div style="text-align:center; margin-bottom:20px;">
                    <h4 style="color:var(--shp-text-main); font-weight:700;">@(isAr ? "رفع ملف Excel / CSV" : "Upload Excel / CSV")</h4>
                    <p style="color:var(--shp-text-muted); font-size:0.9rem;">@(isAr ? "تحديث الأسعار جماعياً" : "Bulk update rates")</p>
                </div>

                <form asp-action="UploadSheet" method="post" enctype="multipart/form-data">
                    <div class="upload-area">
                        <!-- Updated Accept Attribute to include .csv -->
                        <input type="file" name="file" class="file-input" accept=".xlsx, .xls, .csv" required onchange="updateFileName(this)">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2" style="color:var(--shp-text-muted)"></i>
                            <h5 id="fileName">@(isAr ? "اضغط لاختيار الملف" : "Select File")</h5>
                        </div>
                    </div>
                    <button type="submit" class="btn-upload">
                        <i class="fas fa-upload me-2"></i> @(isAr ? "رفع وتحديث" : "Upload")
                    </button>
                </form>

                <div class="instructions">
                    <h6><i class="fas fa-info-circle me-1"></i> @(isAr ? "تعليمات" : "Instructions")</h6>
                    <ul>
                        <li>Header: <b>Governorate, City, Cost</b></li>
                        <li>@(isAr ? "يدعم ملفات .csv و .xlsx" : "Supports .csv and .xlsx files")</li>
                        <li>@(isAr ? "سيتم مسح البيانات القديمة عند الرفع" : "Old data will be replaced")</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right: Current Rates Table -->
        <div class="col-lg-8">
            <div class="admin-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 style="color:var(--shp-text-main); font-weight:700; margin:0;">@(isAr ? "قائمة الأسعار الحالية" : "Current Rates")</h5>
                    <span class="badge bg-light text-dark border">@(Model?.Count() ?? 0)</span>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>@(isAr ? "المحافظة" : "Governorate")</th>
                                <th>@(isAr ? "المدينة" : "City")</th>
                                <th>@(isAr ? "السعر" : "Cost")</th>
                                <th class="text-end">@(isAr ? "إجراءات" : "Actions")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.Governorate</td>
                                        <td>@(string.IsNullOrEmpty(item.City) ? "-" : item.City)</td>
                                        <td class="fw-bold text-success">@item.Cost.ToString("N2")</td>
                                        <td class="text-end">
                                            <!-- Fix: Use CultureInfo.InvariantCulture for numeric values in JS call -->
                                            <button class="btn-action btn-edit" onclick="openEditModal(@item.Id, '@(item.Governorate ?? "")', '@(item.City ?? "")', @item.Cost.ToString(CultureInfo.InvariantCulture))">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form id="deleteForm-@item.Id" asp-action="Delete" method="post" style="display:inline;">
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button type="button" class="btn-action btn-delete" onclick="confirmDelete(@item.Id)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">@(isAr ? "لا توجد أسعار مسجلة" : "No rates found")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add/Edit Rate -->
<div class="modal fade" id="rateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="SaveRate" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">@(isAr ? "إضافة سعر جديد" : "Add New Rate")</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="rateId" value="0" />

                    <div class="mb-3">
                        <label class="form-label">@(isAr ? "المحافظة" : "Governorate")</label>
                        <input type="text" name="Governorate" id="rateGov" class="form-control" required placeholder="Ex: Cairo">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@(isAr ? "المدينة (اختياري)" : "City (Optional)")</label>
                        <input type="text" name="City" id="rateCity" class="form-control" placeholder="Ex: Maadi">
                        <small class="text-muted">@(isAr ? "اتركه فارغاً لتطبيق السعر على المحافظة بالكامل" : "Leave empty for whole governorate")</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@(isAr ? "تكلفة الشحن" : "Shipping Cost")</label>
                        <input type="number" name="Cost" id="rateCost" class="form-control" required min="0" step="0.01">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@(isAr ? "إلغاء" : "Cancel")</button>
                    <button type="submit" class="btn btn-primary">@(isAr ? "حفظ" : "Save")</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function updateFileName(input) {
            if (input.files && input.files[0]) {
                document.getElementById('fileName').innerText = input.files[0].name;
                document.querySelector('.upload-text i').style.color = 'var(--shp-accent)';
            }
        }

        function openAddModal() {
            document.getElementById('rateId').value = 0;
            document.getElementById('rateGov').value = '';
            document.getElementById('rateCity').value = '';
            document.getElementById('rateCost').value = '';
            document.getElementById('modalTitle').innerText = '@Html.Raw(isAr ? "إضافة سعر جديد" : "Add New Rate")';
            new bootstrap.Modal(document.getElementById('rateModal')).show();
        }

        function openEditModal(id, gov, city, cost) {
            document.getElementById('rateId').value = id;
            document.getElementById('rateGov').value = gov;
            document.getElementById('rateCity').value = city;
            document.getElementById('rateCost').value = cost;
            document.getElementById('modalTitle').innerText = '@Html.Raw(isAr ? "تعديل السعر" : "Edit Rate")';
            new bootstrap.Modal(document.getElementById('rateModal')).show();
        }

        function confirmDelete(id) {
            // Theme check
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const colors = isDark ? { bg: '#1e293b', text: '#f8fafc' } : { bg: '#fff', text: '#0f172a' };

            Swal.fire({
                title: '@Html.Raw(isAr ? "حذف السعر؟" : "Delete Rate?")',
                text: '@Html.Raw(isAr ? "هل أنت متأكد من حذف هذا السعر؟" : "Are you sure you want to delete this?")',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: '@Html.Raw(isAr ? "نعم، حذف" : "Yes, Delete")',
                cancelButtonText: '@Html.Raw(isAr ? "إلغاء" : "Cancel")',
                background: colors.bg,
                color: colors.text
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('deleteForm-' + id).submit();
                }
            });
        }

        // Show SweetAlert on TempData
        document.addEventListener('DOMContentLoaded', () => {
            const successMsg = '@Html.Raw(TempData["Success"])';
            const errorMsg = '@Html.Raw(TempData["Error"])';

            if (successMsg) {
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success', title: successMsg,
                    showConfirmButton: false, timer: 3000, timerProgressBar: true
                });
            }
            if (errorMsg) {
                Swal.fire({ icon: 'error', title: 'Error', text: errorMsg });
            }
        });

        // Simple helper to download a template (Optional)
        function downloadTemplate() {
            // Logic to download a sample CSV/Excel could go here or link to a static file
            // For now, redirect to export as it serves as a template too
            window.location.href = '@Url.Action("Export")';
        }
    </script>
}