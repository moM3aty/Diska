@model IEnumerable<Diska.Models.ContactMessage>
@using System.Globalization
@{
    ViewData["Title"] = "الرسائل";
    Layout = "_AdminLayout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    string currentTheme = ViewContext.HttpContext.Request.Cookies["theme"] ?? "light";
}

<style>
    /* =========================================
       PREMIUM STYLES (Variables & Theming)
       ========================================= */
    :root {
        --msg-card-bg: #ffffff;
        --msg-text-main: #1e293b; /* Darker Slate for better readability */
        --msg-text-muted: #64748b;
        --msg-border: #e2e8f0;
        --msg-bg-body: #f8fafc;
        --msg-hover: #f1f5f9;
        --msg-read: #f8fafc;      /* Slightly gray background for read items */
        --msg-unread: #ffffff;    /* Pure white for unread */
        --msg-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); /* Soft Premium Shadow */
        --msg-primary: #4f46e5;
    }

    [data-bs-theme="dark"] {
        --msg-card-bg: #1e293b;
        --msg-text-main: #f8fafc;
        --msg-text-muted: #94a3b8;
        --msg-border: rgba(255, 255, 255, 0.08);
        --msg-bg-body: #0f172a;
        --msg-hover: rgba(255, 255, 255, 0.05);
        --msg-read: rgba(255, 255, 255, 0.02);
        --msg-unread: #1e293b;
        --msg-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.4);
    }

    /* --- Stats & Filter Bar --- */
    .filter-card {
        background: var(--msg-card-bg);
        border: 1px solid var(--msg-border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--msg-shadow);
        margin-bottom: 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        transition: box-shadow 0.3s ease;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-input input {
        width: 100%;
        padding: 12px 15px 12px 40px;
        border-radius: 12px;
        border: 1px solid var(--msg-border);
        background-color: var(--msg-bg-body);
        color: var(--msg-text-main);
        transition: all 0.2s;
    }
    
    .search-input input:focus {
        background-color: var(--msg-card-bg);
        border-color: var(--msg-primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        outline: none;
    }

    .search-input i {
        position: absolute;
        top: 50%;
        left: 15px; /* RTL handling needed via html[dir] */
        transform: translateY(-50%);
        color: var(--msg-text-muted);
    }

    /* --- Messages Table --- */
    .messages-card {
        background: var(--msg-card-bg);
        border: 1px solid var(--msg-border);
        border-radius: 16px;
        box-shadow: var(--msg-shadow);
        overflow: hidden;
    }

    .msg-table {
        width: 100%;
        border-collapse: collapse;
    }

    .msg-table th {
        background-color: var(--msg-bg-body);
        color: var(--msg-text-muted);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 18px 20px;
        border-bottom: 1px solid var(--msg-border);
        text-align: inherit;
        letter-spacing: 0.5px;
    }

    .msg-table td {
        padding: 18px 20px;
        vertical-align: middle;
        border-bottom: 1px solid var(--msg-border);
        color: var(--msg-text-main);
        transition: background 0.2s;
    }
    
    .msg-table tr:last-child td { border-bottom: none; }

    .msg-row:hover td {
        background-color: var(--msg-hover);
        cursor: pointer;
    }

    /* Unread vs Read Styling */
    .msg-row.unread { background-color: var(--msg-unread); position: relative; }
    .msg-row.unread td { font-weight: 600; color: var(--msg-text-main); }
    .msg-row.unread td:first-child::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background-color: var(--msg-primary);
    }
    html[dir="rtl"] .msg-row.unread td:first-child::before { left: auto; right: 0; }

    .msg-row.read { background-color: var(--msg-read); }
    .msg-row.read td { color: var(--msg-text-muted); font-weight: 400; }

    /* Avatars */
    .msg-avatar {
        width: 42px; height: 42px;
        border-radius: 12px;
        background: rgba(79, 70, 229, 0.1);
        color: var(--msg-primary);
        display: flex; align-items: center; justify-content: center;
        font-weight: 800;
        font-size: 1.1rem;
    }

    /* Badges */
    .badge-soft {
        padding: 6px 12px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid transparent;
    }

    /* --- Action Buttons --- */
    .btn-icon-action {
        width: 34px; height: 34px;
        border-radius: 10px;
        display: inline-flex; align-items: center; justify-content: center;
        transition: 0.2s;
        border: 1px solid var(--msg-border);
        background: transparent;
        color: var(--msg-text-muted);
    }
    .btn-icon-action:hover {
        background: var(--msg-hover);
        color: var(--msg-text-main);
        border-color: var(--msg-text-muted);
    }
    .btn-icon-action.delete:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #ef4444;
    }

    /* --- Modal --- */
    .modal-content-premium {
        background-color: var(--msg-card-bg);
        border: 1px solid var(--msg-border);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
    }
    
    .modal-header-premium {
        padding: 20px 25px;
        border-bottom: 1px solid var(--msg-border);
        display: flex; justify-content: space-between; align-items: center;
        background-color: var(--msg-bg-body);
    }

    .modal-body-premium {
        padding: 25px;
        color: var(--msg-text-main);
    }

    .msg-detail-label {
        color: var(--msg-text-muted);
        font-size: 0.85rem;
        margin-bottom: 4px;
        display: block;
        font-weight: 600;
    }

    .msg-detail-value {
        font-weight: 500;
        margin-bottom: 15px;
        display: block;
        font-size: 1rem;
        color: var(--msg-text-main);
    }

    .msg-body-box {
        background: var(--msg-bg-body);
        border: 1px solid var(--msg-border);
        border-radius: 12px;
        padding: 20px;
        line-height: 1.6;
        min-height: 150px;
        margin-bottom: 20px;
        color: var(--msg-text-main);
    }

    /* --- Print Styles --- */
    .print-header { display: none; }

    @@media print {
        @@page { size: A4; margin: 10mm; }
        body { background: #fff !important; color: #000 !important; font-family: 'Cairo', sans-serif; }
        
        /* Hide UI */
        .sidebar, .topbar, .filter-card, .btn, .no-print, .btn-icon-action, .form-check-input { display: none !important; }
        
        /* Layout Reset */
        .app-container, .main-content, .content-wrapper { 
            width: 100% !important; margin: 0 !important; padding: 0 !important; 
            display: block !important; overflow: visible !important;
        }

        /* Header */
        .print-header {
            display: block !important;
            text-align: center;
            border-bottom: 2px solid #000;
            margin-bottom: 30px;
            padding-bottom: 15px;
        }
        .print-header h2 { margin: 0; font-weight: 800; font-size: 24px; }

        /* Table */
        .messages-card { border: none !important; box-shadow: none !important; border-radius: 0; }
        .msg-table { font-size: 12px; border: 1px solid #000; width: 100%; }
        .msg-table th { background: #eee !important; color: #000 !important; border: 1px solid #000; padding: 10px; font-weight: 800; }
        .msg-table td { border: 1px solid #000; color: #000 !important; padding: 10px; }
        
        /* Badges */
        .badge-soft { border: 1px solid #000; color: #000 !important; background: none !important; padding: 2px 6px; }
        
        /* Links */
        a { text-decoration: none; color: #000 !important; }
    }
</style>

<!-- Print Header -->
<div class="print-header">
    <h2>تقرير رسائل التواصل (Messages Report)</h2>
    <p>تاريخ الطباعة: @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</p>
</div>

<div class="container-fluid px-0 fade-up">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2 class="fw-bold mb-1" style="color:var(--msg-text-main)">رسائل التواصل والدعم</h2>
            <p class="text-muted small mb-0">إدارة استفسارات وشكاوى المستخدمين</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary shadow-sm fw-bold px-3" onclick="window.print()">
                <i class="fas fa-print me-2"></i> طباعة
            </button>
            <div class="bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-bold border border-primary border-opacity-25">
                <i class="fas fa-envelope me-2"></i> <span id="msgCount">@Model.Count()</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card no-print">
        <div class="search-input">
            <input type="text" id="searchInput" placeholder="بحث بالاسم، الهاتف، أو المحتوى..." onkeyup="filterMessages()">
            <i class="fas fa-search"></i>
        </div>

        <div style="width:200px;">
            <select id="subjectFilter" class="form-select form-control" onchange="filterMessages()" style="background-color:var(--msg-bg-body); border-color:var(--msg-border); color:var(--msg-text-main); height: 45px; border-radius: 12px;">
                <option value="">كل المواضيع</option>
                <option value="Complaint">شكوى</option>
                <option value="Inquiry">استفسار</option>
                <option value="MerchantRequest">طلب تاجر</option>
                <option value="Suggestion">اقتراح</option>
                <option value="Other">أخرى</option>
            </select>
        </div>

        <button id="deleteSelectedBtn" onclick="deleteSelected()" class="btn btn-danger shadow-sm px-4 rounded-pill fw-bold" style="display:none;">
            <i class="fas fa-trash-alt me-2"></i> حذف (<span id="selectedCount">0</span>)
        </button>
    </div>

    <!-- Messages List -->
    <div class="messages-card">
        <div class="table-responsive">
            <table class="msg-table" id="messagesTable">
                <thead>
                    <tr>
                        <th class="ps-4 no-print" style="width:50px;">
                            <input type="checkbox" id="selectAll" class="form-check-input" onchange="toggleSelectAll()" style="cursor:pointer; width: 18px; height: 18px;">
                        </th>
                        <th>المرسل</th>
                        <th>الموضوع</th>
                        <th>ملخص الرسالة</th>
                        <th>التاريخ</th>
                        <th class="text-end pe-4 no-print">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="text-muted opacity-50">
                                    <i class="fas fa-inbox fa-4x mb-3"></i>
                                    <p class="fs-5">لا توجد رسائل في صندوق الوارد.</p>
                                </div>
                            </td>
                        </tr>
                    }
                    @foreach (var msg in Model)
                    {
                        // Styling Logic
                        string badgeClass = msg.Subject switch {
                            "Complaint" => "bg-danger bg-opacity-10 text-danger border-danger border-opacity-25",
                            "Inquiry" => "bg-info bg-opacity-10 text-info border-info border-opacity-25",
                            "MerchantRequest" => "bg-warning bg-opacity-10 text-warning border-warning border-opacity-25",
                            "Suggestion" => "bg-success bg-opacity-10 text-success border-success border-opacity-25",
                            _ => "bg-secondary bg-opacity-10 text-secondary border-secondary border-opacity-25"
                        };
                        string subjectText = msg.Subject switch {
                            "Complaint" => "شكوى", "Inquiry" => "استفسار", "MerchantRequest" => "طلب تاجر", "Suggestion" => "اقتراح", _ => msg.Subject
                        };

                        <tr class="msg-row unread" id="row-@msg.Id" data-subject="@msg.Subject">
                            <td class="ps-4 no-print" onclick="event.stopPropagation()">
                                <input type="checkbox" class="form-check-input msg-checkbox" value="@msg.Id" onchange="updateSelectedCount()" style="width: 18px; height: 18px; cursor: pointer;">
                            </td>
                            <td onclick="openMsgModal('@msg.Id', '@msg.Name', '@msg.Email', '@msg.Phone', '@msg.Subject', `@msg.Message`)">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="msg-avatar">@msg.Name.FirstOrDefault().ToString().ToUpper()</div>
                                    <div>
                                        <div class="fw-bold">@msg.Name</div>
                                        <div class="small text-muted" style="font-weight: 400;">@msg.Phone</div>
                                    </div>
                                </div>
                            </td>
                            <td onclick="openMsgModal('@msg.Id', '@msg.Name', '@msg.Email', '@msg.Phone', '@msg.Subject', `@msg.Message`)">
                                <span class="badge-soft @badgeClass">@subjectText</span>
                            </td>
                            <td onclick="openMsgModal('@msg.Id', '@msg.Name', '@msg.Email', '@msg.Phone', '@msg.Subject', `@msg.Message`)">
                                <div class="text-truncate" style="max-width: 350px; color:var(--msg-text-muted);">@msg.Message</div>
                            </td>
                            <td class="small text-muted">
                                <div style="font-weight: 600;">@msg.DateSent.ToString("yyyy-MM-dd")</div>
                                <div>@msg.DateSent.ToString("hh:mm tt")</div>
                            </td>
                            <td class="text-end pe-4 no-print" onclick="event.stopPropagation()">
                                <!-- Hidden Form for SweetAlert to Submit -->
                                <form id="deleteForm-@msg.Id" asp-action="DeleteMessage" method="post" class="d-none">
                                    <input type="hidden" name="id" value="@msg.Id" />
                                </form>
                                <button type="button" class="btn-icon-action delete" title="حذف" onclick="confirmDelete(@msg.Id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="msgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content-premium">
            <div class="modal-header-premium">
                <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-envelope-open me-2"></i> تفاصيل الرسالة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(@(currentTheme == "dark" ? 1 : 0))"></button>
            </div>
            <div class="modal-body-premium">
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <span class="msg-detail-label">المرسل</span>
                        <span class="msg-detail-value" id="modalName"></span>
                    </div>
                    <div class="col-md-6">
                        <span class="msg-detail-label">الموضوع</span>
                        <span class="msg-detail-value" id="modalSubject"></span>
                    </div>
                    <div class="col-md-6">
                        <span class="msg-detail-label">الهاتف</span>
                        <span class="msg-detail-value" id="modalPhone"></span>
                    </div>
                    <div class="col-md-6">
                        <span class="msg-detail-label">البريد الإلكتروني</span>
                        <span class="msg-detail-value" id="modalEmail"></span>
                    </div>
                </div>

                <span class="msg-detail-label">نص الرسالة</span>
                <div class="msg-body-box" id="modalBody"></div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a id="replyWhatsappBtn" href="#" target="_blank" class="btn btn-success text-white fw-bold rounded-pill px-4">
                        <i class="fab fa-whatsapp me-2"></i> رد واتساب
                    </a>
                    <a id="replyEmailBtn" href="#" class="btn btn-primary fw-bold rounded-pill px-4">
                        <i class="fas fa-reply me-2"></i> رد بالإيميل
                    </a>
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 1. Search & Filter
        function filterMessages() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const subjectFilter = document.getElementById('subjectFilter').value;
            const table = document.getElementById('messagesTable');
            const tr = table.getElementsByTagName('tr');
            let visibleCount = 0;

            for (let i = 1; i < tr.length; i++) {
                const row = tr[i];
                // Check if it's not the empty state row
                if(row.cells.length < 2) continue;

                const name = row.cells[1].innerText; // Sender Column
                const message = row.cells[3].innerText; // Message Summary
                const rowSubject = row.getAttribute('data-subject');

                const textMatch = name.toLowerCase().indexOf(filter) > -1 || message.toLowerCase().indexOf(filter) > -1;
                const subjectMatch = subjectFilter === "" || rowSubject === subjectFilter;

                if (textMatch && subjectMatch) {
                    row.style.display = "";
                    visibleCount++;
                } else {
                    row.style.display = "none";
                }
            }
            document.getElementById('msgCount').innerText = visibleCount;
        }

        // 2. Select All Logic
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.msg-checkbox');
            checkboxes.forEach(cb => {
                if(cb.closest('tr').style.display !== 'none') {
                    cb.checked = selectAll.checked;
                }
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.msg-checkbox:checked').length;
            const btn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (selected > 0) {
                btn.style.display = 'inline-flex';
                countSpan.innerText = selected;
            } else {
                btn.style.display = 'none';
            }
        }

        // 3. Confirm Delete (Single & Bulk)
        function confirmDelete(id) {
            Swal.fire({
                title: '@(isAr ? "حذف الرسالة؟" : "Delete Message?")',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: '@(isAr ? "نعم، حذف" : "Yes, delete it!")',
                cancelButtonText: '@(isAr ? "إلغاء" : "Cancel")'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('deleteForm-' + id).submit();
                }
            });
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
            if(checkboxes.length === 0) return;

            Swal.fire({
                title: '@(isAr ? "حذف المحدد؟" : "Delete Selected?")',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: '@(isAr ? "نعم، حذف الكل" : "Yes, delete all")',
                cancelButtonText: '@(isAr ? "إلغاء" : "Cancel")'
            }).then((result) => {
                if (result.isConfirmed) {
                    checkboxes.forEach(cb => {
                      
                         const form = document.createElement('form');
                         form.method = 'post';
                         form.action = '/Admin/Dashboard/DeleteMessage'; 
                         const input = document.createElement('input');
                         input.name = 'id';
                         input.value = cb.value;
                         form.appendChild(input);
                         document.body.appendChild(form);
                         form.submit(); 
                    });
                }
            });
        }

        // 4. Modal Logic
        function openMsgModal(id, name, email, phone, subject, body) {
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalSubject').innerText = subject;
            document.getElementById('modalPhone').innerText = phone;
            document.getElementById('modalEmail').innerText = email;
            document.getElementById('modalBody').innerText = body;

            // Setup Reply Links
            document.getElementById('replyEmailBtn').href = `mailto:${email}?subject=رد: ${subject}`;
            document.getElementById('replyWhatsappBtn').href = `https://wa.me/20${phone}?text=مرحباً ${name}، بخصوص رسالتك: ${subject}`;

            // Mark as read visually
            const row = document.getElementById('row-' + id);
            if(row) {
                row.classList.remove('unread');
                row.classList.add('read');
            }

            new bootstrap.Modal(document.getElementById('msgModal')).show();
        }

        function closeMsgModal() {
            var myModalEl = document.getElementById('msgModal');
            var modal = bootstrap.Modal.getInstance(myModalEl);
            if(modal) modal.hide();
        }
    </script>
    
    @if (TempData["Success"] != null)
    {
        <script>
            Swal.fire({
                icon: 'success',
                title: 'تم بنجاح',
                confirmButtonColor: '#4f46e5',
                timer: 2000,
                showConfirmButton: false
            });
        </script>
    }
}