@model IEnumerable<Diska.Models.ContactMessage>
@{
    ViewData["Title"] = "الرسائل";
    Layout = "_AdminLayout";
}

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h2 style="margin:0; color:var(--primary);">رسائل التواصل والدعم</h2>
    <div style="display:flex; gap:10px;">
        <span class="badge" style="background:#e0f2fe; color:#0284c7; font-size:0.9rem; padding: 10px 15px;">العدد: <span id="msgCount">@Model.Count()</span></span>
        <button onclick="window.print()" class="btn btn-outline" style="padding: 8px 15px;"><i class="fas fa-print"></i> طباعة</button>
    </div>
</div>

<!-- شريط الأدوات (بحث + فلترة + إجراءات جماعية) -->
<div class="card" style="margin-bottom:20px; padding:15px;">
    <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
        <!-- البحث -->
        <div style="flex:1; min-width:250px;">
            <div class="input-group" style="position:relative;">
                <input type="text" id="searchInput" class="form-control" placeholder="بحث بالاسم، الهاتف، أو المحتوى..." onkeyup="filterMessages()" style="padding-left: 35px;">
                <i class="fas fa-search" style="position:absolute; left:10px; top:12px; color:#999;"></i>
            </div>
        </div>

        <!-- الفلترة -->
        <div style="width:200px;">
            <select id="subjectFilter" class="form-control" onchange="filterMessages()">
                <option value="">كل المواضيع</option>
                <option value="Complaint">شكوى</option>
                <option value="Inquiry">استفسار</option>
                <option value="MerchantRequest">طلب تاجر</option>
                <option value="Suggestion">اقتراح</option>
                <option value="Other">أخرى</option>
            </select>
        </div>

        <!-- زر الحذف الجماعي -->
        <button id="deleteSelectedBtn" onclick="deleteSelected()" class="btn btn-danger" style="display:none;">
            <i class="fas fa-trash-alt"></i> حذف المحدد (<span id="selectedCount">0</span>)
        </button>
    </div>
</div>

<div class="card">
    @if (!Model.Any())
    {
        <div style="text-align:center; padding:50px; color:#666;">
            <i class="fas fa-envelope-open fa-3x" style="color:#e2e8f0; margin-bottom:15px;"></i>
            <p>لا توجد رسائل في صندوق الوارد.</p>
        </div>
    }
    else
    {
        <form id="bulkDeleteForm" asp-action="DeleteMultipleMessages" method="post">
            <!-- افتراض وجود أكشن للحذف الجماعي أو سيتم التعامل معه ب JS -->
            <div class="table-responsive">
                <table class="table" id="messagesTable" style="width:100%;">
                    <thead>
                        <tr>
                            <th style="width:40px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width:18px; height:18px; cursor:pointer;">
                            </th>
                            <th style="width:120px;">التاريخ</th>
                            <th style="width:200px;">المرسل</th>
                            <th>الموضوع</th>
                            <th>ملخص الرسالة</th>
                            <th style="width:100px;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var msg in Model)
                        {
                            <tr class="msg-row" data-subject="@msg.Subject" id="row-@msg.Id">
                                <td>
                                    <input type="checkbox" class="msg-checkbox" name="selectedIds" value="@msg.Id" onchange="updateSelectedCount()" style="width:18px; height:18px; cursor:pointer;">
                                </td>
                                <td style="white-space:nowrap; color:#666; font-size:0.85rem;">
                                    <div style="font-weight:bold;">@msg.DateSent.ToString("yyyy/MM/dd")</div>
                                    <div style="font-size:0.75rem;">@msg.DateSent.ToString("hh:mm tt")</div>
                                </td>
                                <td>
                                    <strong style="color:var(--text-dark); display:block;">@msg.Name</strong>
                                    <div style="font-size:0.8rem; color:#666; margin-top:2px; display:flex; align-items:center; gap:5px;">
                                        <i class="fas fa-phone" style="font-size:0.7rem;"></i>
                                        <a href="tel:@msg.Phone" style="color:inherit; text-decoration:none;">@msg.Phone</a>
                                    </div>
                                    <div style="font-size:0.8rem; color:#666; display:flex; align-items:center; gap:5px;">
                                        <i class="fas fa-envelope" style="font-size:0.7rem;"></i>
                                        <a href="mailto:@msg.Email" style="color:inherit; text-decoration:none;">@msg.Email</a>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        string badgeColor = msg.Subject switch
                                        {
                                            "Complaint" => "#fee2e2; color:#dc2626",
                                            "Inquiry" => "#e0f2fe; color:#0284c7",
                                            "MerchantRequest" => "#fffbeb; color:#d97706",
                                            "Suggestion" => "#dcfce7; color:#166534",
                                            _ => "#f3f4f6; color:#4b5563"
                                        };
                                        string subjectText = msg.Subject switch
                                        {
                                            "Complaint" => "شكوى",
                                            "Inquiry" => "استفسار",
                                            "MerchantRequest" => "طلب تاجر",
                                            "Suggestion" => "اقتراح",
                                            "Other" => "أخرى",
                                            _ => msg.Subject
                                        };
                                    }
                                    <span class="badge" style="background:@badgeColor;">@subjectText</span>
                                </td>
                                <td style="line-height:1.6; color:#555;">
                                    @{
                                        var shortMsg = msg.Message.Length > 50 ? msg.Message.Substring(0, 50) + "..." : msg.Message;
                                    }
                                    <span title="@msg.Message">@shortMsg</span>
                                </td>
                                <td>
                                    <div style="display:flex; gap:5px;">
                                        <!-- زر التفاصيل والرد -->
                                        <button type="button" class="btn btn-primary small" style="padding:6px 10px;"
                                                onclick="openMsgModal('@msg.Id', '@msg.Name', '@msg.Email', '@msg.Phone', '@msg.Subject', `@msg.Message`)">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <!-- زر الحذف الفردي -->
                                        <form asp-action="DeleteMessage" method="post" onsubmit="return confirm('حذف هذه الرسالة نهائياً؟');" style="display:inline;">
                                            <input type="hidden" name="id" value="@msg.Id" />
                                            <button type="submit" class="btn btn-danger small" style="padding:6px 10px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </form>

        <div id="noResults" style="text-align:center; padding:30px; display:none; color:#666;">
            <p>لا توجد نتائج مطابقة للبحث.</p>
        </div>
    }
</div>

<!-- Message Details Modal -->
<div id="msgModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; width:90%; max-width:600px; border-radius:15px; padding:0; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <div style="padding:20px; background:#f8fafc; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:var(--primary);">تفاصيل الرسالة</h3>
            <button onclick="closeMsgModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#666;">&times;</button>
        </div>
        <div style="padding:25px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <small style="color:#999;">المرسل</small>
                    <div id="modalName" style="font-weight:bold;"></div>
                </div>
                <div>
                    <small style="color:#999;">الموضوع</small>
                    <div id="modalSubject" style="font-weight:bold;"></div>
                </div>
                <div>
                    <small style="color:#999;">الهاتف</small>
                    <div id="modalPhone"></div>
                </div>
                <div>
                    <small style="color:#999;">البريد الإلكتروني</small>
                    <div id="modalEmail"></div>
                </div>
            </div>

            <div style="margin-bottom:25px;">
                <small style="color:#999; display:block; margin-bottom:5px;">نص الرسالة</small>
                <div id="modalBody" style="background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; line-height:1.6; max-height:200px; overflow-y:auto;"></div>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <a id="replyEmailBtn" href="#" class="btn btn-outline" style="border:1px solid #ccc;">
                    <i class="fas fa-envelope"></i> رد بالإيميل
                </a>
                <a id="replyWhatsappBtn" href="#" target="_blank" class="btn btn-success" style="background:#25D366; color:white; border:none;">
                    <i class="fab fa-whatsapp"></i> رد واتساب
                </a>
                <button onclick="closeMsgModal()" class="btn btn-primary">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Search & Filter
    function filterMessages() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const subjectFilter = document.getElementById('subjectFilter').value;
        const table = document.getElementById('messagesTable');
        const tr = table.getElementsByTagName('tr');
        let visibleCount = 0;

        for (let i = 1; i < tr.length; i++) {
            const row = tr[i];
            // Adjust cell index based on checkbox column
            const name = row.cells[2].textContent || row.cells[2].innerText;
            const message = row.cells[4].textContent || row.cells[4].innerText;
            const rowSubject = row.getAttribute('data-subject');

            const textMatch = name.toLowerCase().indexOf(filter) > -1 || message.toLowerCase().indexOf(filter) > -1;
            const subjectMatch = subjectFilter === "" || rowSubject === subjectFilter;

            if (textMatch && subjectMatch) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        }

        document.getElementById('msgCount').innerText = visibleCount;
        document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
        table.style.display = visibleCount === 0 ? 'none' : 'table';
    }

    // 2. Select All Logic
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.msg-checkbox');
        checkboxes.forEach(cb => {
            // Only select visible rows
            if(cb.closest('tr').style.display !== 'none') {
                cb.checked = selectAll.checked;
            }
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const selected = document.querySelectorAll('.msg-checkbox:checked').length;
        const btn = document.getElementById('deleteSelectedBtn');
        const countSpan = document.getElementById('selectedCount');

        if (selected > 0) {
            btn.style.display = 'inline-flex';
            countSpan.innerText = selected;
        } else {
            btn.style.display = 'none';
        }
    }

    // 3. Bulk Delete Action
    function deleteSelected() {
        if(!confirm('هل أنت متأكد من حذف الرسائل المحددة؟')) return;

        // In a real scenario, you would submit the form or use AJAX
        // For now, let's simulate deleting rows from DOM for immediate feedback
        const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
        const ids = [];
        checkboxes.forEach(cb => {
            ids.push(cb.value);
            // Optional: Remove row visually if using AJAX
             document.getElementById('row-' + cb.value).remove();
        });

        // Here you would typically perform a fetch/post to the server
        // Example:
        /*
        fetch('/Admin/Dashboard/DeleteMessages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ids)
        });
        */

       updateSelectedCount();
       // Update total count
       document.getElementById('msgCount').innerText = document.querySelectorAll('.msg-row').length;
    }

    // 4. Modal Logic
    function openMsgModal(id, name, email, phone, subject, body) {
        document.getElementById('modalName').innerText = name;
        document.getElementById('modalSubject').innerText = subject;
        document.getElementById('modalPhone').innerText = phone;
        document.getElementById('modalEmail').innerText = email;
        document.getElementById('modalBody').innerText = body;

        // Setup Reply Links
        document.getElementById('replyEmailBtn').href = `mailto:${email}?subject=رد: ${subject}`;
        document.getElementById('replyWhatsappBtn').href = `https://wa.me/20${phone}?text=مرحباً ${name}، بخصوص رسالتك: ${subject}`;

        document.getElementById('msgModal').style.display = 'flex';
    }

    function closeMsgModal() {
        document.getElementById('msgModal').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('msgModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>