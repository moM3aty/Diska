@model IEnumerable<Diska.Models.ApplicationUser>
@using System.Globalization
@{
    ViewData["Title"] = "إدارة التجار";
    Layout = "_AdminLayout";
    bool isAr = CultureInfo.CurrentCulture.Name.StartsWith("ar");
    string currentTheme = ViewContext.HttpContext.Request.Cookies["theme"] ?? "light";
}

<style>
    /* =========================================
       PREMIUM STYLES (Variables & Theming)
       ========================================= */
    :root {
        --dt-card-bg: #ffffff;
        --dt-text-main: #0f172a;
        --dt-text-muted: #64748b;
        --dt-border: #e2e8f0;
        --dt-bg-body: #f8fafc;
        --dt-header-bg: #f8fafc;
        --dt-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.06);
        --dt-radius: 16px;
        --dt-hover-bg: #f1f5f9;
    }

    [data-bs-theme="dark"] {
        --dt-card-bg: #1e293b;
        --dt-text-main: #f8fafc;
        --dt-text-muted: #94a3b8;
        --dt-border: rgba(255, 255, 255, 0.08);
        --dt-bg-body: #0f172a;
        --dt-header-bg: #0f172a;
        --dt-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.3);
        --dt-hover-bg: rgba(255, 255, 255, 0.05);
    }

    /* --- Stats Cards --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
    }

    .stat-card {
        background-color: var(--dt-card-bg);
        border-radius: var(--dt-radius);
        padding: 24px;
        border: 1px solid var(--dt-border);
        box-shadow: var(--dt-shadow);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s ease;
    }

    .stat-card:hover { transform: translateY(-5px); }

    .stat-icon {
        width: 60px; height: 60px;
        border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.8rem;
    }

    .st-blue { background: rgba(79, 70, 229, 0.1); color: #4f46e5; }
    .st-green { background: rgba(34, 197, 94, 0.1); color: #16a34a; }
    .st-orange { background: rgba(249, 115, 22, 0.1); color: #f97316; }

    /* --- Table & Card --- */
    .table-card {
        background-color: var(--dt-card-bg);
        border-radius: var(--dt-radius);
        border: 1px solid var(--dt-border);
        box-shadow: var(--dt-shadow);
        overflow: hidden;
    }

    .table { margin-bottom: 0; width: 100%; border-collapse: separate; border-spacing: 0; }
    
    .table thead th {
        background-color: var(--dt-header-bg);
        color: var(--dt-text-muted);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 18px 24px;
        border-bottom: 1px solid var(--dt-border);
        white-space: nowrap;
    }

    .table tbody td {
        padding: 20px 24px;
        vertical-align: middle;
        border-bottom: 1px solid var(--dt-border);
        color: var(--dt-text-main);
    }
    
    .table-hover tbody tr:hover td { background-color: var(--dt-hover-bg); }

    /* --- Avatars --- */
    .merchant-avatar {
        width: 48px; height: 48px;
        border-radius: 12px;
        background: var(--dt-bg-body);
        border: 1px solid var(--dt-border);
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 1.2rem; color: var(--dt-text-main);
        margin:5px;
    }

    /* --- Actions --- */
    .action-btn {
        width: 36px; height: 36px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center; justify-content: center;
        transition: 0.2s;
        border: 1px solid var(--dt-border);
        background: transparent;
        color: var(--dt-text-muted);
    }

    .action-btn:hover { background: var(--color-primary); color: #fff; border-color: var(--color-primary); }
    .action-btn.delete:hover { background: #ef4444; border-color: #ef4444; }

    /* --- Status Badges --- */
    .status-badge {
        padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700;
        display: inline-flex; align-items: center; gap: 6px;
    }
    .status-verified { background: rgba(34, 197, 94, 0.1); color: #16a34a; border: 1px solid rgba(34, 197, 94, 0.2); }
    .status-pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }

    /* --- Search Input --- */
    .search-input {
        background-color: var(--dt-card-bg);
        border: 1px solid var(--dt-border);
        color: var(--dt-text-main);
        padding: 12px 20px;
        border-radius: 12px;
        width: 300px;
    }
    .search-input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    /* =========================================
       PRINT STYLES
       ========================================= */
    .print-header { display: none; }

    @@media print {
        @@page { size: A4 landscape; margin: 10mm; }
        body { background: #fff !important; color: #000 !important; font-family: 'Cairo', sans-serif; }
        
        /* Hide UI */
        .sidebar, .topbar, .no-print, .btn, .action-btn, .modal { display: none !important; }
        
        /* Layout Reset */
        .app-container, .main-content, .content-wrapper { 
            width: 100% !important; margin: 0 !important; padding: 0 !important; 
            display: block !important; overflow: visible !important;
        }

        /* Show Header */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }
        .print-header h2 { font-size: 24px; font-weight: bold; margin: 0; }
        .print-header p { margin: 5px 0 0; color: #555; }

        /* Table Styling */
        .table-card { border: none; box-shadow: none; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #000; padding: 10px; font-size: 12px; }
        .table td { border: 1px solid #ccc; padding: 10px; color: #000 !important; font-size: 12px; }
        
        /* Badges for Print */
        .status-badge { border: 1px solid #000 !important; color: #000 !important; background: none !important; }
        .merchant-avatar { border: 1px solid #000; color: #000 !important; background: #fff !important; }
    }
</style>

<!-- Print Header -->
<div class="print-header">
    <h2>DISKA - @(isAr ? "تقرير التجار" : "Merchants Report")</h2>
    <p>@(isAr ? "تاريخ الطباعة:" : "Printed Date:") @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</p>
</div>

<div class="container-fluid px-0 fade-up ">

    <!-- Screen Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2 class="fw-bold mb-1" style="color: var(--dt-text-main);">@(isAr ? "إدارة التجار" : "Merchants Management")</h2>
            <p class="text-muted small mb-0">@(isAr ? "متابعة الحسابات التجارية والمحفظة" : "Manage merchant accounts and wallets")</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary shadow-sm fw-bold px-3" onclick="window.print()">
                <i class="fas fa-print me-2"></i> @(isAr ? "طباعة" : "Print")
            </button>
            <button class="btn btn-primary shadow-lg fw-bold px-4" data-bs-toggle="modal" data-bs-target="#createMerchantModal">
                <i class="fas fa-user-plus me-2"></i> @(isAr ? "إضافة تاجر" : "Add Merchant")
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid no-print">
        <div class="stat-card">
            <div class="stat-icon st-blue"><i class="fas fa-store"></i></div>
            <div>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.75rem;">@(isAr ? "إجمالي التجار" : "Total Merchants")</small>
                <h3 class="fw-bold mb-0" style="color: var(--dt-text-main);">@ViewBag.TotalCount</h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon st-green"><i class="fas fa-check-circle"></i></div>
            <div>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.75rem;">@(isAr ? "موثقين" : "Verified")</small>
                <h3 class="fw-bold mb-0" style="color: var(--dt-text-main);">@ViewBag.VerifiedCount</h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon st-orange"><i class="fas fa-wallet"></i></div>
            <div>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.75rem;">@(isAr ? "إجمالي المحافظ" : "Total Wallet Balance")</small>
                <h3 class="fw-bold mb-0" style="color: var(--dt-text-main);">@(((decimal)ViewBag.TotalBalance).ToString("N0")) <small class="fs-6 text-muted">LE</small></h3>
            </div>
        </div>
    </div>

    <!-- Search -->
    <div class="mb-4 no-print">
        <form method="get" class="d-flex gap-3">
            <div class="position-relative">
                <input type="text" name="q" class="search-input ps-5" placeholder="@(isAr ? "بحث..." : "Search...")" value="@Context.Request.Query["q"]">
                <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="ps-4">@(isAr ? "التاجر" : "Merchant")</th>
                        <th>@(isAr ? "بيانات الاتصال" : "Contact Info")</th>
                        <th>@(isAr ? "السجل الضريبي" : "Tax Info")</th>
                        <th>@(isAr ? "المحفظة" : "Wallet")</th>
                        <th>@(isAr ? "الحالة" : "Status")</th>
                        <th class="text-end pe-4 no-print">@(isAr ? "إجراءات" : "Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="text-muted opacity-50">
                                    <i class="fas fa-store-slash fa-3x mb-3"></i>
                                    <p>@(isAr ? "لا يوجد تجار مطابقين" : "No merchants found")</p>
                                </div>
                            </td>
                        </tr>
                    }
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="merchant-avatar">
                                        @(item.ShopName?.FirstOrDefault().ToString().ToUpper() ?? item.FullName?.FirstOrDefault().ToString().ToUpper() ?? "U")
                                    </div>
                                    <div>
                                        <div class="fw-bold">@(item.ShopName ?? "No Shop Name")</div>
                                        <div class="small text-muted">@item.FullName</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column small">
                                    <span class="text-muted"><i class="fas fa-phone me-1"></i> @item.PhoneNumber</span>
                                    <span class="text-muted"><i class="fas fa-envelope me-1"></i> @item.Email</span>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    <div class="text-muted">S.R: <span class="fw-bold" style="color:var(--dt-text-main)">@item.CommercialRegister</span></div>
                                    <div class="text-muted">Tax: <span class="fw-bold" style="color:var(--dt-text-main)">@item.TaxCard</span></div>
                                </div>
                            </td>
                            <td>
                                <span class="fw-bold text-success">@item.WalletBalance.ToString("N0")</span>
                                <small class="text-muted">ج.م</small>
                            </td>
                            <td>
                                @if (item.IsVerifiedMerchant)
                                {
                                    <span class="status-badge status-verified">
                                        <i class="fas fa-check-circle"></i> @(isAr ? "موثق" : "Verified")
                                    </span>
                                }
                                else
                                {
                                    <span class="status-badge status-pending">
                                        <i class="fas fa-clock"></i> @(isAr ? "قيد المراجعة" : "Pending")
                                    </span>
                                }
                            </td>
                            <td class="text-end pe-4 no-print">
                                <div class="d-flex justify-content-end gap-2">
                                    <form id="verifyForm-@item.Id" asp-action="VerifyMerchant" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@item.Id" />
                                        <button type="button" class="action-btn" title="@(item.IsVerifiedMerchant ? "إلغاء التوثيق" : "توثيق")" onclick="confirmVerify('@item.Id', @(item.IsVerifiedMerchant.ToString().ToLower()))">
                                            <i class="fas @(item.IsVerifiedMerchant ? "fa-times text-danger" : "fa-check text-success")"></i>
                                        </button>
                                    </form>
                                    
                                    <a href="/Admin/Users/Details/@item.Id" class="action-btn" title="التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-transparent border-top p-3 text-center no-print">
            <small class="text-muted">@(isAr ? $"عدد النتائج: {Model.Count()}" : $"Total Results: {Model.Count()}")</small>
        </div>
    </div>
</div>

<!-- Create Merchant Modal -->
<div class="modal fade" id="createMerchantModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: var(--dt-card-bg); border: 1px solid var(--dt-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--dt-border);">
                <h5 class="modal-title fw-bold" style="color: var(--dt-text-main);">
                    <i class="fas fa-store text-primary me-2"></i> @(isAr ? "إضافة تاجر جديد" : "Add New Merchant")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="@(isAr ? "margin-left:0; margin-right:auto;" : "") filter: invert(@(currentTheme == "dark" ? 1 : 0));"></button>
            </div>
            <!-- Action updated to Account/Signup -->
            <form asp-area="" asp-controller="Account" asp-action="Signup" method="post">
                <div class="modal-body p-4">
                    <!-- Required by Signup Action -->
                    <input type="hidden" name="type" value="Merchant" />
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">اسم التاجر (كامل)</label>
                            <input type="text" name="fullName" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">اسم المتجر (Shop Name)</label>
                            <input type="text" name="shopName" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">رقم الهاتف</label>
                            <input type="tel" name="phone" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">كلمة المرور</label>
                            <input type="password" name="password" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">السجل التجاري</label>
                            <input type="text" name="commercialReg" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" style="color: var(--dt-text-muted);">البطاقة الضريبية</label>
                            <input type="text" name="taxCard" class="form-control" required style="background: var(--dt-bg-body); border-color: var(--dt-border); color: var(--dt-text-main);">
                        </div>

                        <div class="col-12 mt-3 text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            @(isAr ? "سيتم إنشاء الحساب بحالة 'غير مفعل' وبريد إلكتروني وهمي تلقائي." : "Account will be created as 'Unverified' with an auto-generated dummy email.")
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--dt-border);">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary fw-bold px-4">حفظ التاجر</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        function confirmVerify(id, isVerified) {
            const title = isVerified ? '@(isAr ? "إلغاء التوثيق؟" : "Unverify?")' : '@(isAr ? "توثيق التاجر؟" : "Verify Merchant?")';
            const text = isVerified ? '@(isAr ? "سيتم إلغاء صلاحيات التاجر الموثق." : "Merchant verification will be revoked.")' : '@(isAr ? "سيتم منح صلاحيات التاجر الموثق." : "Merchant will be verified.")';
            const confirmBtn = isVerified ? '#ef4444' : '#10b981';

            Swal.fire({
                title: title,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: confirmBtn,
                cancelButtonColor: '#6b7280',
                confirmButtonText: '@(isAr ? "نعم، نفذ" : "Yes, proceed")',
                cancelButtonText: '@(isAr ? "إلغاء" : "Cancel")'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('verifyForm-' + id).submit();
                }
            });
        }
    </script>

    @if (TempData["Success"] != null)
    {
        <script>
            Swal.fire({
                icon: 'success',
                title: 'تم بنجاح',
                confirmButtonColor: '#4f46e5'
            });
        </script>
    }
}

