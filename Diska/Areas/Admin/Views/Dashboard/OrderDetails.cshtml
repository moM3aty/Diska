@model Diska.Models.Order
@{
    ViewData["Title"] = "تفاصيل الطلب";
    Layout = "_AdminLayout";
}

<div style="margin-bottom:20px;">
    <a asp-action="Orders" style="text-decoration:none; color:#666;"><i class="fas fa-arrow-right"></i> عودة للطلبات</a>
</div>

<div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
    <!-- Order Items -->
    <div class="card">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px;">محتويات الطلب #@Model.Id</h3>
        <table>
            <thead>
                <tr>
                    <th>المنتج</th>
                    <th>السعر</th>
                    <th>الكمية</th>
                    <th>المجموع</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.OrderItems)
                {
                    <tr>
                        <td>
                            @if (item.Product != null)
                            {
                                <span>@item.Product.Name</span>
                            }
                            else
                            {

                                <span style="color:red;">منتج محذوف</span>
                            }
                        </td>
                        <td>@item.UnitPrice.ToString("N2")</td>
                        <td>@item.Quantity</td>
                        <td>@((item.UnitPrice * item.Quantity).ToString("N2"))</td>
                    </tr>
                }
            </tbody>
        </table>
        <div style="margin-top:20px; text-align:left;">
            <h4>الإجمالي الكلي: <span style="color:var(--primary);">@Model.TotalAmount.ToString("N2") ج.م</span></h4>
        </div>
    </div>

    <!-- Actions & Info -->
    <div style="display:flex; flex-direction:column; gap:20px;">
        <div class="card">
            <h4 style="margin-top:0;">بيانات العميل</h4>
            <p><strong>الاسم:</strong> @Model.CustomerName</p>
            <p><strong>الهاتف:</strong> @Model.Phone</p>
            <p><strong>العنوان:</strong> @Model.Governorate - @Model.City<br><small>@Model.Address</small></p>
        </div>

        <div class="card">
            <h4 style="margin-top:0;">إدارة الحالة</h4>
            <form asp-action="UpdateOrderStatus" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <select name="status" class="form-control" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                    <option value="Pending" selected="@(Model.Status == "Pending")">قيد الانتظار</option>
                    <option value="Confirmed" selected="@(Model.Status == "Confirmed")">مؤكد</option>
                    <option value="Shipped" selected="@(Model.Status == "Shipped")">تم الشحن</option>
                    <option value="Delivered" selected="@(Model.Status == "Delivered")">تم التسليم</option>
                    <option value="Cancelled" selected="@(Model.Status == "Cancelled")">ملغي</option>
                </select>
                <button type="submit" class="btn btn-primary" style="width:100%;">تحديث الحالة</button>
            </form>
        </div>

        <!-- Refund Section -->
        @if (Model.Status == "Cancelled" && Model.PaymentMethod == "Wallet")
        {
            <div class="card" style="border-color:#fca5a5;">
                <h4 style="color:#dc2626; margin-top:0;">استرداد المبلغ (Refund)</h4>
                <p style="font-size:0.9rem;">إرجاع المبلغ إلى محفظة العميل.</p>
                <form asp-action="RefundUser" method="post">
                    <input type="hidden" name="userId" value="@Model.UserId" />
                    <input type="hidden" name="amount" value="@Model.TotalAmount" />
                    <input type="hidden" name="reason" value="Order Cancelled #@Model.Id" />
                    <button type="submit" class="btn" style="width:100%; background:#dc2626; color:#fff;">استرداد @Model.TotalAmount ج.م</button>
                </form>
            </div>
        }
    </div>
</div>